<!DOCTYPE html><html><head><meta charset="utf-8"/><link rel="icon" type="image/png" href="https://blog.jeaye.com//assets/favicon-c551898801df70b89095c40cbb11f01ff876ecf59bfa153122137abe9459c576.png"><title>Installing Arch Linux with a fully-encrypted disk</title><meta name="author" content="jeaye"/><meta name="keywords" content="jeaye,jesse,wilkerson,c++,modern,engineering,manager,software,functional,clojure,programming,arch, linux, tutorial, security, privacy, encryption, disk"/><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="I'm a leader, a problem solver, and a hacker with a passion for privacy and security."><style>.icon{background-image:url("/assets/sprite-sheet-f829f47fe9f6353c7c632fee71002c94a29b8341725e19843f2c1b263869e4f2.png") !important}</style><style rel="stylesheet" type="text/css" integrity="sha256-FAEL2/AHw4sy6PSxUkN0Zt4TaPhbApIPciXM8UG6d7c=" crossorigin="anonymous">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{display:flex;flex-flow:column nowrap;margin:0;font-family:sans-serif}a{text-decoration:none}.theme-old a{color:#3d92c9}.theme-red a{color:#c93d7a}.theme-teal a{color:#c2363c}.theme-green a{color:#3dc945}.theme-penny a{color:#ec331a}a:hover,a:focus{text-decoration:underline}.theme-old .gentle-body-color{color:#222}.theme-red .gentle-body-color{color:#222}.theme-teal .gentle-body-color{color:#222}.theme-green .gentle-body-color{color:#222}.theme-penny .gentle-body-color{color:#222}.header{display:flex;flex-flow:column wrap;align-items:center;margin:0;padding:2em 40px 2em 40px;text-align:center}.theme-old .header{background:#3d4f5d;color:#999}.theme-red .header{background:#5d3d4a;color:#999}.theme-teal .header{background:#3d5d5d;color:#999}.theme-green .header{background:#3d5d40;color:#999}.theme-penny .header{background:#812d39;color:#999}.header-inner{display:flex;flex-flow:row wrap}.header-description{flex:2;text-align:left;max-width:700px}.header-icon{display:flex;flex:1;justify-content:flex-end}.header-title,.header-short-pitch{margin:0}.header-short-pitch{font-weight:300}.theme-old .header-short-pitch{color:#b0cadb}.theme-red .header-short-pitch{color:#dbb0c3}.theme-teal .header-short-pitch{color:#b0dbd9}.theme-green .header-short-pitch{color:#b0dbb3}.theme-penny .header-short-pitch{color:#ffbbcb}.header-name{font-size:2.5em}.theme-old .header-name{color:#222}.theme-red .header-name{color:#222}.theme-teal .header-name{color:#222}.theme-green .header-name{color:#222}.theme-penny .header-name{color:#222}.nav{display:flex;flex-flow:row wrap;gap:0.5em;padding-top:0.5em}.nav-item{display:flex;flex:1;white-space:nowrap}.nav-item a{background:transparent;margin-top:1em;padding:6px 14px;letter-spacing:0.05em;font-size:85%}.theme-old .nav-item a{color:#fff;border:2px solid #b0cadb}.theme-red .nav-item a{color:#fff;border:2px solid #dbb0c3}.theme-teal .nav-item a{color:#fff;border:2px solid #b0dbd9}.theme-green .nav-item a{color:#fff;border:2px solid #b0dbb3}.theme-penny .nav-item a{color:#fff;border:2px solid #ffbbcb}.nav-item a:hover,.nav-item a:focus{text-decoration:none}.theme-old .nav-item a:hover,.theme-old .nav-item a:focus{border:2px solid #3d92c9}.theme-red .nav-item a:hover,.theme-red .nav-item a:focus{border:2px solid #c93d7a}.theme-teal .nav-item a:hover,.theme-teal .nav-item a:focus{border:2px solid #3dc9c3}.theme-green .nav-item a:hover,.theme-green .nav-item a:focus{border:2px solid #3dc945}.theme-penny .nav-item a:hover,.theme-penny .nav-item a:focus{border:2px solid #ff1345}.theme-old .special-nav-item a{border:2px solid #c2a086}.theme-red .special-nav-item a{border:2px solid #86c2aa}.theme-teal .special-nav-item a{border:2px solid #c28686}.theme-green .special-nav-item a{border:2px solid #c286bc}.theme-penny .special-nav-item a{border:2px solid #87e200}.theme-old .special-nav-item a:hover,.theme-old .special-nav-item a:focus{border:2px solid #c26d36}.theme-red .special-nav-item a:hover,.theme-red .special-nav-item a:focus{border:2px solid #36c285}.theme-teal .special-nav-item a:hover,.theme-teal .special-nav-item a:focus{border:2px solid #c2363c}.theme-green .special-nav-item a:hover,.theme-green .special-nav-item a:focus{border:2px solid #c236ba}.theme-penny .special-nav-item a:hover,.theme-penny .special-nav-item a:focus{border:2px solid #78af26}.panel-h-box{display:flex;flex:1;flex-flow:row wrap;gap:10em;justify-content:center;margin:0 3em 0 3em}.panel-v-box{display:flex;flex-flow:column wrap}.panel-gap{min-width:10em}.panel-subhead{text-transform:uppercase;padding:0;font-size:80%;font-weight:500;letter-spacing:0.1em}.theme-old .panel-subhead{color:#999}.theme-red .panel-subhead{color:#999}.theme-teal .panel-subhead{color:#999}.theme-green .panel-subhead{color:#999}.theme-penny .panel-subhead{color:#999}.main-panel,.toolbox-panel,.pgp-panel,.what-i-do-panel,.main-blog-panel{margin-top:2em}.main-panel{display:flex;flex:2;max-width:1280px;min-width:400px}.toolbox-panel{display:flex;flex:1;flex-flow:column nowrap;max-width:450px;min-width:200px}.what-i-do-panel{display:flex;flex:2;flex-flow:column nowrap;min-width:400px;max-width:900px}.what-i-do-h-box{display:flex;flex-flow:row nowrap;gap:4em;margin-top:1em}.what-i-do-thing{flex:1}.what-i-do-thing-title{font-size:1.0em;line-height:0.5em}.what-i-do-title{font-size:1.0em;line-height:0.5em;text-transform:uppercase;margin-bottom:2em}.theme-old .what-i-do-title{color:#443843}.theme-red .what-i-do-title{color:#443843}.theme-teal .what-i-do-title{color:#443843}.theme-green .what-i-do-title{color:#443843}.theme-penny .what-i-do-title{color:#443843}.what-i-do-big{font-size:2.5em;line-height:1em;font-weight:bold}.theme-old .what-i-do-big{color:#222}.theme-red .what-i-do-big{color:#222}.theme-teal .what-i-do-big{color:#222}.theme-green .what-i-do-big{color:#222}.theme-penny .what-i-do-big{color:#222}.job-title{font-size:2em;margin-bottom:0.2em}.theme-old .job-title{color:#222}.theme-red .job-title{color:#222}.theme-teal .job-title{color:#222}.theme-green .job-title{color:#222}.theme-penny .job-title{color:#222}.job-at{font-size:80%;font-weight:500}.theme-old .job-at{color:#999}.theme-red .job-at{color:#999}.theme-teal .job-at{color:#999}.theme-green .job-at{color:#999}.theme-penny .job-at{color:#999}.job-company{font-size:90%}.theme-old .job-company{color:#3d92c9}.theme-red .job-company{color:#c93d7a}.theme-teal .job-company{color:#c2363c}.theme-green .job-company{color:#3dc945}.theme-penny .job-company{color:#ec331a}.posts{display:flex;justify-content:center;flex-flow:column nowrap;max-width:1280px}.post{padding-bottom:2em}.post-header{display:flex;justify-content:space-between;align-items:center}.post-title{font-size:2em;margin-bottom:0.2em}.theme-old .post-title{color:#222}.theme-red .post-title{color:#222}.theme-teal .post-title{color:#222}.theme-green .post-title{color:#222}.theme-penny .post-title{color:#222}.theme-old .post-title a{color:#222;text-decoration-color:#222}.theme-red .post-title a{color:#222;text-decoration-color:#222}.theme-teal .post-title a{color:#222;text-decoration-color:#222}.theme-green .post-title a{color:#222;text-decoration-color:#222}.theme-penny .post-title a{color:#222;text-decoration-color:#222}.post-description{font-family:Georgia, "Cambria", serif;line-height:1.8em}.theme-old .post-description{color:#222}.theme-red .post-description{color:#222}.theme-teal .post-description{color:#222}.theme-green .post-description{color:#222}.theme-penny .post-description{color:#222}.post-meta{font-size:90%;margin:0}.theme-old .post-meta{color:#222}.theme-red .post-meta{color:#222}.theme-teal .post-meta{color:#222}.theme-green .post-meta{color:#222}.theme-penny .post-meta{color:#222}.post-date{text-align:right;white-space:nowrap}.theme-old .post-date{color:#222}.theme-red .post-date{color:#222}.theme-teal .post-date{color:#222}.theme-green .post-date{color:#222}.theme-penny .post-date{color:#222}.post-updated-date{font-size:90%;font-style:italic}.theme-old .post-updated-date{color:#5aba59}.theme-red .post-updated-date{color:#5aba59}.theme-teal .post-updated-date{color:#5aba59}.theme-green .post-updated-date{color:#5aba59}.theme-penny .post-updated-date{color:#5aba59}.post-category{margin:0 0.1em;padding:0.3em 1em;font-size:80%}.theme-old .post-category{color:#fff;background:#999}.theme-red .post-category{color:#fff;background:#999}.theme-teal .post-category{color:#fff;background:#999}.theme-green .post-category{color:#fff;background:#999}.theme-penny .post-category{color:#fff;background:#999}.theme-old .post-category-review{background:#61b360}.theme-red .post-category-review{background:#61b360}.theme-teal .post-category-review{background:#61b360}.theme-green .post-category-review{background:#61b360}.theme-penny .post-category-review{background:#61b360}.theme-old .post-category-privacy,.theme-old .post-category-security{background:#4d85d1}.theme-red .post-category-privacy,.theme-red .post-category-security{background:#4d85d1}.theme-teal .post-category-privacy,.theme-teal .post-category-security{background:#4d85d1}.theme-green .post-category-privacy,.theme-green .post-category-security{background:#4d85d1}.theme-penny .post-category-privacy,.theme-penny .post-category-security{background:#4d85d1}.theme-old .post-category-rant{background:#8156a7}.theme-red .post-category-rant{background:#8156a7}.theme-teal .post-category-rant{background:#8156a7}.theme-green .post-category-rant{background:#8156a7}.theme-penny .post-category-rant{background:#8156a7}.theme-old .post-category-tutorial{background:#bd4f64}.theme-red .post-category-tutorial{background:#bd4f64}.theme-teal .post-category-tutorial{background:#bd4f64}.theme-green .post-category-tutorial{background:#bd4f64}.theme-penny .post-category-tutorial{background:#bd4f64}.theme-old .post h1,.theme-old h2,.theme-old h3,.theme-old h4{color:#222}.theme-red .post h1,.theme-red h2,.theme-red h3,.theme-red h4{color:#222}.theme-teal .post h1,.theme-teal h2,.theme-teal h3,.theme-teal h4{color:#222}.theme-green .post h1,.theme-green h2,.theme-green h3,.theme-green h4{color:#222}.theme-penny .post h1,.theme-penny h2,.theme-penny h3,.theme-penny h4{color:#222}.post p,.post ol,.post ul{font-family:Georgia, "Cambria", serif}.theme-old .post p,.theme-old .post ol,.theme-old .post ul{color:#222}.theme-red .post p,.theme-red .post ol,.theme-red .post ul{color:#222}.theme-teal .post p,.theme-teal .post ol,.theme-teal .post ul{color:#222}.theme-green .post p,.theme-green .post ol,.theme-green .post ul{color:#222}.theme-penny .post p,.theme-penny .post ol,.theme-penny .post ul{color:#222}.post p a{font-weight:600}.skills{margin:0;padding:0 3em 0 0}.skill{display:flex;gap:1em;padding:1em 0;border-bottom:1px solid #ccc}.skill:last-child{border:none !important}.skill-name{font-size:0.8em;font-weight:bold;align-self:center}.theme-old .skill-name{color:#222}.theme-red .skill-name{color:#222}.theme-teal .skill-name{color:#222}.theme-green .skill-name{color:#222}.theme-penny .skill-name{color:#222}.main-blog-panel{display:flex;justify-content:center;margin-left:10em;margin-right:10em}.blog-header{display:flex;flex-flow:row nowrap;justify-content:space-between}.border-bottom{border-bottom:1px solid #eee}.related-list{list-style-type:none}.related-list li{padding-bottom:0.5em;border-bottom:1px solid #ccc}.related-list li:last-child{border:none}.related-post-title{font-size:1em;margin-bottom:0.2em}.theme-old .related-post-title{color:#222}.theme-red .related-post-title{color:#222}.theme-teal .related-post-title{color:#222}.theme-green .related-post-title{color:#222}.theme-penny .related-post-title{color:#222}.theme-old .related-post-title a{color:#222;text-decoration-color:#222}.theme-red .related-post-title a{color:#222;text-decoration-color:#222}.theme-teal .related-post-title a{color:#222;text-decoration-color:#222}.theme-green .related-post-title a{color:#222;text-decoration-color:#222}.theme-penny .related-post-title a{color:#222;text-decoration-color:#222}figure{text-align:center;margin:0 auto}figure img{border:1px solid rgba(50,50,50,0.5);border-radius:2px;padding:5px;background:#fff}.figure-2-3{width:66%}figcaption{padding:1em 1em 2em 1em;word-wrap:normal;text-align:center;display:inline-block !important;width:66%}code{overflow:auto}.icon-feed{background-position:0px 0px;width:24px;height:30px}.icon-j{background-position:-24px 0px;width:158px;height:155px}code:not([id='typeans']){padding-left:5px;padding-right:5px;border:1px solid;border-color:lightgrey;border-radius:5px}pre code{padding:5px}.highlight .lineno{color:#ccc;display:inline-block;padding:0 5px;border-right:1px solid #ccc}.highlight pre code{display:block;white-space:pre-wrap;overflow-x:auto;word-wrap:normal}.highlight .hll{background-color:#49483e}.highlight{background:#272822;color:#f8f8f2;border-radius:5px}.highlight .c{color:#75715e}.highlight .err{color:#960050;background-color:#1e0010}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .ch{color:#75715e}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .cpf{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .gd{color:#f92672}.highlight .ge{font-style:italic}.highlight .gi{color:#a6e22e}.highlight .gs{font-weight:bold}.highlight .gu{color:#75715e}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mb{color:#ae81ff}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sa{color:#e6db74}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .dl{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#a6e22e}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .vm{color:#f8f8f2}.highlight .il{color:#ae81ff}
</style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="/feed.xml"/></head><body class="theme-penny"><div class="header"><div class="header-inner"><div class="header-description"><h1 class="header-title">My name is <span class="header-name">Jeaye</span></h1><h2 class="header-short-pitch">I'm a leader, a problem solver, and a hacker with a passion for privacy and security.</h2></div><div class="header-icon"><div class="icon icon-j"></div></div></div><nav class="nav"><div class="nav-item"> <a href="https://jeaye.com/">About</a></div><div class="nav-item"> <a href="https://github.com/jeaye">Github</a></div><div class="nav-item"> <a href="/">Blog</a></div><div class="nav-item"> <a href="https://jeaye.com/contact">Contact</a></div><div class="nav-item special-nav-item"> <a href="https://jeaye.com/contact">Hire Me!</a></div> </nav></div><div class="main-blog-panel"><div class="posts"> <section class="post"> <header class="post-header"><h2 class="post-title"> <a href="/2016/06/29/encrypted-arch-linux/" title="/2016/06/29/encrypted-arch-linux/"> Installing Arch Linux with a fully-encrypted disk </a></h2><div class="post-date"> June 29, 2016</div> </header><p>On a typical GNU/Linux install, you won’t have disk encryption. Though you’re a keen user and you’ve chosen a <a href="https://libraryfreedomproject.org/strongpassphrases/">very strong passphrase</a>, your data is still stored openly. Should anyone steal, confiscate, buy, or otherwise obtain your hard drive, every bit of data is going to be readable. Should anyone boot into a live CD on your system and mount your drives, your data is readily available and your strong passphrase is none the wiser.</p><h3 id="varying-degrees-of-encryption">Varying degrees of encryption</h3><p>It’s becoming more popular to encrypt certain files, <a href="https://www.gnupg.org/gph/en/manual/x110.html">perhaps using GPG</a>, and even home directories. This still suffers, compared to full system encryption, since the entire root of the file system is still open. Directories like <code class="highlighter-rouge">/etc</code>, where the majority of your system configurations exist (often including sensitive information), <code class="highlighter-rouge">/var</code>, where sensitive data may be logged by running processes, and even <code class="highlighter-rouge">/tmp</code>, where processes may store sensitive temporary data, are vulnerable.</p><p><em>Encrypt first, then install; use your system with more confidence.</em></p><h3 id="start-here">Start here</h3><p>Let this be a guide for your next bare-bones Arch setup. I assume you’re the root from here on out.</p><h4 id="download">Download</h4><p>Head over to the <a href="https://www.archlinux.org/download/">Arch download site</a> and get the latest ISO, preferably via BitTorrent. Burn it to your external media in your preferred manner; I have a 16GB USB drive at <code class="highlighter-rouge">/dev/sdb</code>, in this example, and I’ll make my live disk with one command.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>archlinux-2016.07.01-dual.iso <span class="nv">of</span><span class="o">=</span>/dev/sdb <span class="nv">bs</span><span class="o">=</span>1M
</code></pre></div></div><p>Boot into your new live CD, choose your architecture, and you’ll be dropped at a root prompt. Now you’ll create your system.</p><h4 id="partition">Partition</h4><p>I’m assuming you’re installing to <code class="highlighter-rouge">/dev/sda</code>; the resulting partition table is shown below.</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dev/sda1   /boot   200MB
/dev/sda2   /       Rest
</code></pre></div></div><p>Spin up <a href="https://wiki.archlinux.org/index.php/Cfdisk">cfdisk</a> and create a matching layout.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cfdisk /dev/sda
</code></pre></div></div><h4 id="encrypt">Encrypt</h4><p>Now, before you install anything, you’re going to setup encryption for <code class="highlighter-rouge">/dev/sda2</code>. Choose a strong passphrase, at least 32 characters long. I recommend using a complete sentence with spaces, punctuation, and mixed case. As the disk is encrypted, it’ll first be scrubbed with random data. You can interrupt this, but you should not! Here’s why.</p><p>Typical data <a href="https://wiki.archlinux.org/index.php/Securely_wipe_disk">can be discovered</a> by patterns that are inherent to its format. Video, audio, source code, etc, each looks different as a pattern of bits. Encrypted data typically looks like random garbage. As a result, if you only encrypt the data of this new system, there may be old data on the drive which will not look random; it’ll still be decipherable as video, audio, etc. If you randomize the whole drive first, then it’s substantially more difficult to tell where the encrypted data stops, since it all looks like random garbage.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cryptsetup <span class="nt">--verbose</span> <span class="nt">--key-size</span> 512 <span class="nt">--hash</span> sha512 <span class="nt">--iter-time</span> 5000 <span class="se">\</span>
             <span class="nt">--use-random</span> luksFormat /dev/sda2
</code></pre></div></div><p>Given an encrypted partition, which <code class="highlighter-rouge">/dev/sda2</code> now is, you can decrypt it into a labeled volume. In this example, you’ll decrypt the fresh <code class="highlighter-rouge">/dev/sda2</code> into <code class="highlighter-rouge">/dev/mapper/cryptroot</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cryptsetup open <span class="nt">--type</span> luks /dev/sda2 cryptroot
</code></pre></div></div><p>Once it’s there, you’re free to mount it, format it, or do just about anything you would with a normal disk partition.</p><h4 id="format">Format</h4><p>Both of the partitions will just use <a href="https://en.wikipedia.org/wiki/Ext4">Ext4</a>, in this example. You’re welcome to use any file system you’d like.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkfs.ext4 /dev/sda1
<span class="nv">$ </span>mkfs.ext4 /dev/mapper/cryptroot
</code></pre></div></div><p>Once you have your file systems formatted, they should be mounted in a local directory. You’ll change root into here soon.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> mnt
<span class="nv">$ </span>mount <span class="nt">-t</span> ext4 /dev/mapper/cryptroot mnt
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> mnt/boot
<span class="nv">$ </span>mount <span class="nt">-t</span> ext4 /dev/sda1 mnt/boot
</code></pre></div></div><h4 id="install-the-base-system">Install the base system</h4><p>The Arch live system comes with a couple of commands to help bootstrap your new system. The first you’ll use is <code class="highlighter-rouge">pacstrap</code>, which takes the directory in which to install and an arbitrary number of packages. This requires network access and I recommend installing some basic tools which will help as you build up your system. Aside from the required <code class="highlighter-rouge">base</code> and <code class="highlighter-rouge">base-devel</code>, I opt for <code class="highlighter-rouge">vim</code> and <code class="highlighter-rouge">tmux</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pacstrap <span class="nt">-i</span> mnt base base-devel vim tmux
</code></pre></div></div><p>Your current mount points will work as a starting point for the new system, so you can serialize them as an fstab now.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>genfstab <span class="nt">-U</span> <span class="nt">-p</span> mnt <span class="o">&gt;&gt;</span> mnt/etc/fstab
</code></pre></div></div><h4 id="enter-the-system">Enter the system</h4><p>At this point, a working user-space is within <code class="highlighter-rouge">mnt</code> and you an change root into it. Arch provides <code class="highlighter-rouge">arch-chroot</code> for this purpose; it’s a helper script around <code class="highlighter-rouge">chroot</code> which also sets up certain API file systems and makes <code class="highlighter-rouge">/etc/resolv.conf</code> available.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>arch-chroot mnt
</code></pre></div></div><h4 id="setup-locale">Setup locale</h4><p>Now that you’re in your new system’s environment, some essential information will need to be specified. For starters, a modern setup should <a href="http://utf8everywhere.org/">default to UTF-8</a>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/^#\(en_US.UTF-8 UTF-8\)//g'</span> /etc/locale.gen
<span class="nv">$ </span>locale-gen

<span class="nv">$ </span><span class="nb">echo </span><span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8 <span class="o">&gt;</span> /etc/locale.conf
<span class="nv">$ </span><span class="nb">export </span><span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
</code></pre></div></div><h4 id="setup-time">Setup time</h4><p>Link in the appropriate time zone for you. I also recommend keeping the hardware clock on UTC.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ln</span> <span class="nt">-s</span> /usr/share/zoneinfo/America/Los_Angeles /etc/localtime

<span class="nv">$ </span>hwclock <span class="nt">--systohc</span> <span class="nt">--utc</span>
</code></pre></div></div><h4 id="setup-hostname">Setup hostname</h4><p>Your hostname can be whatever you want; it’s network-visible though, so keep it sane.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo </span>tofu-ninja <span class="o">&gt;</span> /etc/hostname
</code></pre></div></div><h4 id="setup-users">Setup users</h4><p>Root needs a password and you’ll need a normal user. Using root for anything but short-term administrative tasks is a <a href="https://askubuntu.com/questions/16178/why-is-it-bad-to-login-as-root">dangerous habit</a>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>passwd <span class="c"># enter root password</span>

<span class="nv">$ </span>useradd <span class="nt">-m</span> <span class="nt">-g</span> <span class="nb">users</span> <span class="nt">-G</span> wheel <span class="nt">-s</span> /bin/bash penny
<span class="nv">$ </span>passwd penny <span class="c"># enter user's password</span>

<span class="nv">$ </span>visudo <span class="c"># uncomment wheel</span>
</code></pre></div></div><h4 id="install-grub">Install GRUB</h4><p>You have other options for your bootloader, but <a href="https://wiki.archlinux.org/index.php/GRUB">GRUB</a> is the most powerful around. I like that, in a pinch, the GRUB shell can be used to boot just about anything. The installation is straightforward, but you need to make sure that GRUB knows about our encrypted drive.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pacman <span class="nt">-S</span> grub-bios

<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s#^\(GRUB_CMDLINE_LINUX="\)#cryptdevice=/dev/sda2:cryptroot#'</span> <span class="se">\</span>
         /etc/default/grub

<span class="nv">$ </span>grub-install <span class="nt">--recheck</span> /dev/sda
<span class="nv">$ </span>grub-mkconfig <span class="nt">--output</span> /boot/grub/grub.cfg
</code></pre></div></div><h4 id="rebuild-initramfs">Rebuild initramfs</h4><p>The kernel needs to know about your encrypted setup, so you must instruct <a href="https://wiki.archlinux.org/index.php/mkinitcpio">mkinitcpio</a> to do some extra work.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/^\(HOOKS=".*\)\(filesystems.*\)/ encrypt /'</span> <span class="se">\</span>
         /etc/mkinitcpio.conf
<span class="nv">$ </span>mkinitcpio <span class="nt">-p</span> linux
</code></pre></div></div><h4 id="reboot">Reboot</h4><p>At this point, your minimal setup is complete and your entire system, save for <code class="highlighter-rouge">/boot</code>, is encrypted. You can exit the install environment and reboot into GRUB and your new install.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">exit</span>
<span class="nv">$ </span>umount <span class="nt">-R</span> mnt/boot
<span class="nv">$ </span>umount <span class="nt">-R</span> mnt
<span class="nv">$ </span>cryptsetup close cryptroot
<span class="nv">$ </span>reboot
</code></pre></div></div><h3 id="if-you-get-locked-out">If you get locked out</h3><p>If locked out of your system, for whatever reason, you’ll need to manually decrypt your drives. You can do this by just manually opening and closing through <code class="highlighter-rouge">cryptsetup</code>, like you did for the install.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cryptsetup open <span class="nt">--type</span> luks /dev/sda2 cryptroot
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> mnt
<span class="nv">$ </span>mount <span class="nt">-t</span> ext4 /dev/mapper/cryptroot mnt
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> mnt/boot
<span class="nv">$ </span>mount <span class="nt">-t</span> ext4 /dev/sda1 mnt/boot

<span class="c"># Do your work ...</span>

<span class="nv">$ </span>umount <span class="nt">-R</span> mnt/boot
<span class="nv">$ </span>umount <span class="nt">-R</span> mnt
<span class="nv">$ </span>cryptsetup close cryptroot
</code></pre></div></div><h3 id="what-now">What now?</h3><p>A starting point for filling out your new system would be the <a href="https://wiki.archlinux.org/index.php/General_recommendations">Arch General Recommendations</a>.</p></section><hr/><div><div class="border-bottom"><h1 class="panel-subhead">Related posts</h1><ul class="related-list"><li><h2 class="related-post-title"> <a href="/2018/04/11/system76-firmware/">Removing IME: Upgrading System76 firmware on Arch</a> <span class="post-category post-category-linux">linux</span> <span class="post-category post-category-tutorial">tutorial</span> <span class="post-category post-category-security">security</span> <span class="post-category post-category-privacy">privacy</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/12/16/firefox/">Don't abandon Mozilla Firefox just yet</a> <span class="post-category post-category-privacy">privacy</span> <span class="post-category post-category-security">security</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/11/30/noscript/">A guide to using NoScript 10.x</a> <span class="post-category post-category-privacy">privacy</span> <span class="post-category post-category-security">security</span> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/10/31/clojure-keywords/">The five common forms of Clojure keywords</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li></ul></div></div></div></div></div> <footer> </footer></body></html>