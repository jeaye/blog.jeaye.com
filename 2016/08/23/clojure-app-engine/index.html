<!DOCTYPE html><html><head><meta charset="utf-8"/><link rel="icon" type="image/png" href="https://blog.jeaye.com//assets/favicon-c551898801df70b89095c40cbb11f01ff876ecf59bfa153122137abe9459c576.png"><title>Running Clojure on Google App Engine</title><meta name="author" content="jeaye"/><meta name="keywords" content="jeaye,jesse,wilkerson,c++,modern,engineering,manager,software,functional,clojure,programming,clojure, programming, appengine, google, tutorial"/><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="I'm a leader, a problem solver, and a hacker with a passion for privacy and security."><style>.icon{background-image:url("/assets/sprite-sheet-f829f47fe9f6353c7c632fee71002c94a29b8341725e19843f2c1b263869e4f2.png") !important}</style><style rel="stylesheet" type="text/css" integrity="sha256-FAEL2/AHw4sy6PSxUkN0Zt4TaPhbApIPciXM8UG6d7c=" crossorigin="anonymous">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{display:flex;flex-flow:column nowrap;margin:0;font-family:sans-serif}a{text-decoration:none}.theme-old a{color:#3d92c9}.theme-red a{color:#c93d7a}.theme-teal a{color:#c2363c}.theme-green a{color:#3dc945}.theme-penny a{color:#ec331a}a:hover,a:focus{text-decoration:underline}.theme-old .gentle-body-color{color:#222}.theme-red .gentle-body-color{color:#222}.theme-teal .gentle-body-color{color:#222}.theme-green .gentle-body-color{color:#222}.theme-penny .gentle-body-color{color:#222}.header{display:flex;flex-flow:column wrap;align-items:center;margin:0;padding:2em 40px 2em 40px;text-align:center}.theme-old .header{background:#3d4f5d;color:#999}.theme-red .header{background:#5d3d4a;color:#999}.theme-teal .header{background:#3d5d5d;color:#999}.theme-green .header{background:#3d5d40;color:#999}.theme-penny .header{background:#812d39;color:#999}.header-inner{display:flex;flex-flow:row wrap}.header-description{flex:2;text-align:left;max-width:700px}.header-icon{display:flex;flex:1;justify-content:flex-end}.header-title,.header-short-pitch{margin:0}.header-short-pitch{font-weight:300}.theme-old .header-short-pitch{color:#b0cadb}.theme-red .header-short-pitch{color:#dbb0c3}.theme-teal .header-short-pitch{color:#b0dbd9}.theme-green .header-short-pitch{color:#b0dbb3}.theme-penny .header-short-pitch{color:#ffbbcb}.header-name{font-size:2.5em}.theme-old .header-name{color:#222}.theme-red .header-name{color:#222}.theme-teal .header-name{color:#222}.theme-green .header-name{color:#222}.theme-penny .header-name{color:#222}.nav{display:flex;flex-flow:row wrap;gap:0.5em;padding-top:0.5em}.nav-item{display:flex;flex:1;white-space:nowrap}.nav-item a{background:transparent;margin-top:1em;padding:6px 14px;letter-spacing:0.05em;font-size:85%}.theme-old .nav-item a{color:#fff;border:2px solid #b0cadb}.theme-red .nav-item a{color:#fff;border:2px solid #dbb0c3}.theme-teal .nav-item a{color:#fff;border:2px solid #b0dbd9}.theme-green .nav-item a{color:#fff;border:2px solid #b0dbb3}.theme-penny .nav-item a{color:#fff;border:2px solid #ffbbcb}.nav-item a:hover,.nav-item a:focus{text-decoration:none}.theme-old .nav-item a:hover,.theme-old .nav-item a:focus{border:2px solid #3d92c9}.theme-red .nav-item a:hover,.theme-red .nav-item a:focus{border:2px solid #c93d7a}.theme-teal .nav-item a:hover,.theme-teal .nav-item a:focus{border:2px solid #3dc9c3}.theme-green .nav-item a:hover,.theme-green .nav-item a:focus{border:2px solid #3dc945}.theme-penny .nav-item a:hover,.theme-penny .nav-item a:focus{border:2px solid #ff1345}.theme-old .special-nav-item a{border:2px solid #c2a086}.theme-red .special-nav-item a{border:2px solid #86c2aa}.theme-teal .special-nav-item a{border:2px solid #c28686}.theme-green .special-nav-item a{border:2px solid #c286bc}.theme-penny .special-nav-item a{border:2px solid #87e200}.theme-old .special-nav-item a:hover,.theme-old .special-nav-item a:focus{border:2px solid #c26d36}.theme-red .special-nav-item a:hover,.theme-red .special-nav-item a:focus{border:2px solid #36c285}.theme-teal .special-nav-item a:hover,.theme-teal .special-nav-item a:focus{border:2px solid #c2363c}.theme-green .special-nav-item a:hover,.theme-green .special-nav-item a:focus{border:2px solid #c236ba}.theme-penny .special-nav-item a:hover,.theme-penny .special-nav-item a:focus{border:2px solid #78af26}.panel-h-box{display:flex;flex:1;flex-flow:row wrap;gap:10em;justify-content:center;margin:0 3em 0 3em}.panel-v-box{display:flex;flex-flow:column wrap}.panel-gap{min-width:10em}.panel-subhead{text-transform:uppercase;padding:0;font-size:80%;font-weight:500;letter-spacing:0.1em}.theme-old .panel-subhead{color:#999}.theme-red .panel-subhead{color:#999}.theme-teal .panel-subhead{color:#999}.theme-green .panel-subhead{color:#999}.theme-penny .panel-subhead{color:#999}.main-panel,.toolbox-panel,.pgp-panel,.what-i-do-panel,.main-blog-panel{margin-top:2em}.main-panel{display:flex;flex:2;max-width:1280px;min-width:400px}.toolbox-panel{display:flex;flex:1;flex-flow:column nowrap;max-width:450px;min-width:200px}.what-i-do-panel{display:flex;flex:2;flex-flow:column nowrap;min-width:400px;max-width:900px}.what-i-do-h-box{display:flex;flex-flow:row nowrap;gap:4em;margin-top:1em}.what-i-do-thing{flex:1}.what-i-do-thing-title{font-size:1.0em;line-height:0.5em}.what-i-do-title{font-size:1.0em;line-height:0.5em;text-transform:uppercase;margin-bottom:2em}.theme-old .what-i-do-title{color:#443843}.theme-red .what-i-do-title{color:#443843}.theme-teal .what-i-do-title{color:#443843}.theme-green .what-i-do-title{color:#443843}.theme-penny .what-i-do-title{color:#443843}.what-i-do-big{font-size:2.5em;line-height:1em;font-weight:bold}.theme-old .what-i-do-big{color:#222}.theme-red .what-i-do-big{color:#222}.theme-teal .what-i-do-big{color:#222}.theme-green .what-i-do-big{color:#222}.theme-penny .what-i-do-big{color:#222}.job-title{font-size:2em;margin-bottom:0.2em}.theme-old .job-title{color:#222}.theme-red .job-title{color:#222}.theme-teal .job-title{color:#222}.theme-green .job-title{color:#222}.theme-penny .job-title{color:#222}.job-at{font-size:80%;font-weight:500}.theme-old .job-at{color:#999}.theme-red .job-at{color:#999}.theme-teal .job-at{color:#999}.theme-green .job-at{color:#999}.theme-penny .job-at{color:#999}.job-company{font-size:90%}.theme-old .job-company{color:#3d92c9}.theme-red .job-company{color:#c93d7a}.theme-teal .job-company{color:#c2363c}.theme-green .job-company{color:#3dc945}.theme-penny .job-company{color:#ec331a}.posts{display:flex;justify-content:center;flex-flow:column nowrap;max-width:1280px}.post{padding-bottom:2em}.post-header{display:flex;justify-content:space-between;align-items:center}.post-title{font-size:2em;margin-bottom:0.2em}.theme-old .post-title{color:#222}.theme-red .post-title{color:#222}.theme-teal .post-title{color:#222}.theme-green .post-title{color:#222}.theme-penny .post-title{color:#222}.theme-old .post-title a{color:#222;text-decoration-color:#222}.theme-red .post-title a{color:#222;text-decoration-color:#222}.theme-teal .post-title a{color:#222;text-decoration-color:#222}.theme-green .post-title a{color:#222;text-decoration-color:#222}.theme-penny .post-title a{color:#222;text-decoration-color:#222}.post-description{font-family:Georgia, "Cambria", serif;line-height:1.8em}.theme-old .post-description{color:#222}.theme-red .post-description{color:#222}.theme-teal .post-description{color:#222}.theme-green .post-description{color:#222}.theme-penny .post-description{color:#222}.post-meta{font-size:90%;margin:0}.theme-old .post-meta{color:#222}.theme-red .post-meta{color:#222}.theme-teal .post-meta{color:#222}.theme-green .post-meta{color:#222}.theme-penny .post-meta{color:#222}.post-date{text-align:right;white-space:nowrap}.theme-old .post-date{color:#222}.theme-red .post-date{color:#222}.theme-teal .post-date{color:#222}.theme-green .post-date{color:#222}.theme-penny .post-date{color:#222}.post-updated-date{font-size:90%;font-style:italic}.theme-old .post-updated-date{color:#5aba59}.theme-red .post-updated-date{color:#5aba59}.theme-teal .post-updated-date{color:#5aba59}.theme-green .post-updated-date{color:#5aba59}.theme-penny .post-updated-date{color:#5aba59}.post-category{margin:0 0.1em;padding:0.3em 1em;font-size:80%}.theme-old .post-category{color:#fff;background:#999}.theme-red .post-category{color:#fff;background:#999}.theme-teal .post-category{color:#fff;background:#999}.theme-green .post-category{color:#fff;background:#999}.theme-penny .post-category{color:#fff;background:#999}.theme-old .post-category-review{background:#61b360}.theme-red .post-category-review{background:#61b360}.theme-teal .post-category-review{background:#61b360}.theme-green .post-category-review{background:#61b360}.theme-penny .post-category-review{background:#61b360}.theme-old .post-category-privacy,.theme-old .post-category-security{background:#4d85d1}.theme-red .post-category-privacy,.theme-red .post-category-security{background:#4d85d1}.theme-teal .post-category-privacy,.theme-teal .post-category-security{background:#4d85d1}.theme-green .post-category-privacy,.theme-green .post-category-security{background:#4d85d1}.theme-penny .post-category-privacy,.theme-penny .post-category-security{background:#4d85d1}.theme-old .post-category-rant{background:#8156a7}.theme-red .post-category-rant{background:#8156a7}.theme-teal .post-category-rant{background:#8156a7}.theme-green .post-category-rant{background:#8156a7}.theme-penny .post-category-rant{background:#8156a7}.theme-old .post-category-tutorial{background:#bd4f64}.theme-red .post-category-tutorial{background:#bd4f64}.theme-teal .post-category-tutorial{background:#bd4f64}.theme-green .post-category-tutorial{background:#bd4f64}.theme-penny .post-category-tutorial{background:#bd4f64}.theme-old .post h1,.theme-old h2,.theme-old h3,.theme-old h4{color:#222}.theme-red .post h1,.theme-red h2,.theme-red h3,.theme-red h4{color:#222}.theme-teal .post h1,.theme-teal h2,.theme-teal h3,.theme-teal h4{color:#222}.theme-green .post h1,.theme-green h2,.theme-green h3,.theme-green h4{color:#222}.theme-penny .post h1,.theme-penny h2,.theme-penny h3,.theme-penny h4{color:#222}.post p,.post ol,.post ul{font-family:Georgia, "Cambria", serif}.theme-old .post p,.theme-old .post ol,.theme-old .post ul{color:#222}.theme-red .post p,.theme-red .post ol,.theme-red .post ul{color:#222}.theme-teal .post p,.theme-teal .post ol,.theme-teal .post ul{color:#222}.theme-green .post p,.theme-green .post ol,.theme-green .post ul{color:#222}.theme-penny .post p,.theme-penny .post ol,.theme-penny .post ul{color:#222}.post p a{font-weight:600}.skills{margin:0;padding:0 3em 0 0}.skill{display:flex;gap:1em;padding:1em 0;border-bottom:1px solid #ccc}.skill:last-child{border:none !important}.skill-name{font-size:0.8em;font-weight:bold;align-self:center}.theme-old .skill-name{color:#222}.theme-red .skill-name{color:#222}.theme-teal .skill-name{color:#222}.theme-green .skill-name{color:#222}.theme-penny .skill-name{color:#222}.main-blog-panel{display:flex;justify-content:center;margin-left:10em;margin-right:10em}.blog-header{display:flex;flex-flow:row nowrap;justify-content:space-between}.border-bottom{border-bottom:1px solid #eee}.related-list{list-style-type:none}.related-list li{padding-bottom:0.5em;border-bottom:1px solid #ccc}.related-list li:last-child{border:none}.related-post-title{font-size:1em;margin-bottom:0.2em}.theme-old .related-post-title{color:#222}.theme-red .related-post-title{color:#222}.theme-teal .related-post-title{color:#222}.theme-green .related-post-title{color:#222}.theme-penny .related-post-title{color:#222}.theme-old .related-post-title a{color:#222;text-decoration-color:#222}.theme-red .related-post-title a{color:#222;text-decoration-color:#222}.theme-teal .related-post-title a{color:#222;text-decoration-color:#222}.theme-green .related-post-title a{color:#222;text-decoration-color:#222}.theme-penny .related-post-title a{color:#222;text-decoration-color:#222}figure{text-align:center;margin:0 auto}figure img{border:1px solid rgba(50,50,50,0.5);border-radius:2px;padding:5px;background:#fff}.figure-2-3{width:66%}figcaption{padding:1em 1em 2em 1em;word-wrap:normal;text-align:center;display:inline-block !important;width:66%}code{overflow:auto}.icon-feed{background-position:0px 0px;width:24px;height:30px}.icon-j{background-position:-24px 0px;width:158px;height:155px}code:not([id='typeans']){padding-left:5px;padding-right:5px;border:1px solid;border-color:lightgrey;border-radius:5px}pre code{padding:5px}.highlight .lineno{color:#ccc;display:inline-block;padding:0 5px;border-right:1px solid #ccc}.highlight pre code{display:block;white-space:pre-wrap;overflow-x:auto;word-wrap:normal}.highlight .hll{background-color:#49483e}.highlight{background:#272822;color:#f8f8f2;border-radius:5px}.highlight .c{color:#75715e}.highlight .err{color:#960050;background-color:#1e0010}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .ch{color:#75715e}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .cpf{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .gd{color:#f92672}.highlight .ge{font-style:italic}.highlight .gi{color:#a6e22e}.highlight .gs{font-weight:bold}.highlight .gu{color:#75715e}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mb{color:#ae81ff}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sa{color:#e6db74}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .dl{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#a6e22e}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .vm{color:#f8f8f2}.highlight .il{color:#ae81ff}
</style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="/feed.xml"/></head><body class="theme-penny"><div class="header"><div class="header-inner"><div class="header-description"><h1 class="header-title">My name is <span class="header-name">Jeaye</span></h1><h2 class="header-short-pitch">I'm a leader, a problem solver, and a hacker with a passion for privacy and security.</h2></div><div class="header-icon"><div class="icon icon-j"></div></div></div><nav class="nav"><div class="nav-item"> <a href="https://jeaye.com/">About</a></div><div class="nav-item"> <a href="https://github.com/jeaye">Github</a></div><div class="nav-item"> <a href="/">Blog</a></div><div class="nav-item"> <a href="https://jeaye.com/contact">Contact</a></div><div class="nav-item special-nav-item"> <a href="https://jeaye.com/contact">Hire Me!</a></div> </nav></div><div class="main-blog-panel"><div class="posts"> <section class="post"> <header class="post-header"><h2 class="post-title"> <a href="/2016/08/23/clojure-app-engine/" title="/2016/08/23/clojure-app-engine/"> Running Clojure on Google App Engine </a></h2><div class="post-date"> August 23, 2016</div> </header><p>Clojure excels at pure transformations of persistent data. One area well-suited for this is a stateless server which transforms data between the client and the datastore. For distributed server development in Clojure, we already have <a href="http://www.onyxplatform.org/">Onyx</a>, as well as <a href="https://github.com/pyr/mesomatic">wrappers for Mesos</a> and others. An apparently less-explored option is the use of Clojure on Google App Engine, which runs sandboxed applications in Google-managed data centers while providing automatic scaling.</p><h3 id="state-of-third-party-libraries">State of third-party libraries</h3><p>When looking to start with Clojure on App Engine, you might explore the current open source libraries available. Unfortunately, there are a few, namely <a href="https://github.com/gcv/appengine-magic">appengine-magic</a>, yet all of them have been stale for at least two years. Most of them are built on Clojure 1.4 or older.</p><h3 id="state-of-official-documentation">State of official documentation</h3><p>Your next step may be to see what official documentation there is, since you can’t readily use a third-party library to do your dirty work. App Engine’s <a href="https://cloud.google.com/appengine/docs">documentation</a> can be very helpful, no doubt, but one issue is that App Engine supports JVM applications, not specifically Clojure applications. Its examples are in Java, using Maven, with the typical serving of XML. The docs will come in handy, once you can get some basic App Engine code working, but they don’t get you over that hurdle. Not in Clojure.</p><h3 id="state-of-third-party-documentation">State of third-party documentation</h3><p>Before giving up, you do some searching for what others have done. <em>“Surely someone’s made an application for GAE sometime after 2014,”</em> you think. Fortunately, you’ll likely happen across a few good resources. Unfortunately, most of them are vacant mailing list threads and/or even more dated than the abandoned libraries. If you landed here, I’ll save you the trouble and provide you with what’s been most helpful for me:</p><ol><li><a href="http://lambda-startup.com/developing-clojure-on-app-engine/">http://lambda-startup.com/developing-clojure-on-app-engine/</a></li><li><a href="http://flowa.fi/blog/2014/04/25/clojure-gae-howto.html">http://flowa.fi/blog/2014/04/25/clojure-gae-howto.html</a></li></ol><p>In that order.</p><p>Still, there are unclear bits, omitted bits, outdated bits, and inconsistencies between the two of them. So, doing my part, I’ll expand upon the first resource and provide some clarifications, tools, and useful tips. I recommend you give both a read, without following along in the REPL/editor, so you have an idea of what’s required.</p><h3 id="installing-a-local-app-engine">Installing a local App Engine</h3><p>When the very useful lambda-startup article gets to installing the App Engine jars into your local repo, the instructions become unclear. To clarify, <code class="highlighter-rouge">GAE_SDK</code> is where you have downloaded and extracted the SDK. The commands should be executed from the working directory of your leiningen project. To make things even simpler, use this script, named <code class="highlighter-rouge">install-gae</code>, in your project root:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">set</span> <span class="nt">-ue</span>

<span class="nv">here</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">cd</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="k">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="k">}</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span><span class="s2">"</span>

<span class="nb">export </span><span class="nv">gae_version</span><span class="o">=</span>1.9.42
<span class="nb">export </span><span class="nv">gae_sdk</span><span class="o">=</span><span class="s2">"</span><span class="nv">$here</span><span class="s2">/lib/appengine-java-sdk-</span><span class="nv">$gae_version</span><span class="s2">"</span>
<span class="nb">export </span><span class="nv">gae_zip</span><span class="o">=</span><span class="s2">"</span><span class="nv">$gae_sdk</span><span class="s2">.zip"</span>

<span class="k">function </span>install_gae
<span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$gae_sdk</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span>
  <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"GAE exists; not installing"</span>
    <span class="k">return
  fi

  </span><span class="nb">echo</span> <span class="s2">"Downloading GAE"</span>
  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$here</span><span class="s2">/lib"</span>
  <span class="nb">pushd</span> <span class="s2">"</span><span class="nv">$here</span><span class="s2">/lib"</span>
    wget <span class="s2">"https://storage.googleapis.com/appengine-sdks/featured/appengine-java-sdk-</span><span class="nv">$gae_version</span><span class="s2">.zip"</span>
    unzip <span class="nt">-q</span> <span class="s2">"</span><span class="nv">$gae_zip</span><span class="s2">"</span>
  <span class="nb">popd

  echo</span> <span class="s2">"Installing GAE"</span>
  <span class="k">function </span>gae_install
  <span class="o">{</span> lein localrepo <span class="nb">install</span> <span class="s2">"</span><span class="nv">$gae_sdk</span><span class="s2">/lib/</span><span class="nv">$1</span><span class="s2">"</span> <span class="s2">"com.google.appengine/</span><span class="nv">$2</span><span class="s2">"</span> <span class="nv">$gae_version</span><span class="p">;</span> <span class="o">}</span>

  gae_install impl/appengine-api-stubs.jar appengine-api-stubs
  gae_install impl/appengine-api-labs.jar appengine-api-labs
  gae_install impl/appengine-local-runtime.jar appengine-local-runtime
  gae_install shared/appengine-local-runtime-shared.jar appengine-local-runtime-shared

  <span class="nb">echo</span> <span class="s2">"Done"</span>
<span class="o">}</span>
install_gae
</code></pre></div></div><h3 id="profiling-with-appstats">Profiling with Appstats</h3><p>Google provides an <a href="https://cloud.google.com/appengine/docs/java/tools/appstats">Appstats</a> library for profiling individual RPCs. It can tell you how long each Datastore read or write takes, how much time you’re spending in various routes, as well as how much each operation costs you in USD. There wasn’t any documentation for getting this working with Clojure, so this info is from experimentation. Before following, I recommend reading the <a href="https://cloud.google.com/appengine/docs/java/tools/appstats">Appstats documentation</a> for how to set it up in Java; once you have an idea of what’s needed, the following will make more sense.</p><p>First, add the proper dependency:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.google.appengine/appengine-api-labs</span><span class="w"> </span><span class="s">"1.9.42"</span><span class="p">]</span><span class="w"> </span><span class="c1">; Installed with above script</span><span class="w">
</span></code></pre></div></div><h4 id="run-a-servlet">Run a servlet</h4><p>In order to use Appstats, you’ll need to configure your application to be a servlet. First, change your <code class="highlighter-rouge">my-project.core</code> to extend from <code class="highlighter-rouge">HttpServlet</code>:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">my-project.core</span><span class="w">
  </span><span class="p">(</span><span class="no">:gen-class</span><span class="w"> </span><span class="no">:extends</span><span class="w"> </span><span class="n">javax.servlet.http.HttpServlet</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="no">:use</span><span class="w"> </span><span class="p">[</span><span class="n">ring.util.servlet</span><span class="w"> </span><span class="no">:only</span><span class="w"> </span><span class="p">[</span><span class="n">defservice</span><span class="p">]])</span><span class="w">
  </span><span class="c1">; Other stuff ...</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p>Then define a service around your ring application.</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">defroutes</span><span class="w"> </span><span class="n">app</span><span class="w">
  </span><span class="p">(</span><span class="nf">ANY</span><span class="w"> </span><span class="s">"/kittens"</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">show-kittens</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">wrapped-app</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">app</span><span class="w">
      </span><span class="n">wrap-params</span><span class="w"> </span><span class="c1">; Optional: Handy bit from [ring.middleware.params]</span><span class="w">
      </span><span class="p">(</span><span class="nf">wrap-trace</span><span class="w"> </span><span class="no">:header</span><span class="p">)))</span><span class="w"> </span><span class="c1">; Optional: Handy bit from [liberator.dev]</span><span class="w">

</span><span class="p">(</span><span class="nf">defservice</span><span class="w"> </span><span class="n">wrapped-app</span><span class="p">)</span><span class="w"> </span><span class="c1">; Meat and potatoes</span><span class="w">
</span></code></pre></div></div><h4 id="package-a-webxml">Package a web.xml</h4><p>Finally, there’s another file that’s needed: <code class="highlighter-rouge">web.xml</code> (adjacent to <code class="highlighter-rouge">appengine-web.xml</code>), as described by the documentation. In it, you can specify how Appstats should be accessible, among other things. Here’s a reasonable version which works with the deploy script below (update values as needed – XXX is replaced by the deploy script):</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/javaee"</span> <span class="na">version=</span><span class="s">"2.5"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;servlet&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>XXX<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;servlet-class&gt;</span>my-project.core<span class="nt">&lt;/servlet-class&gt;</span>
  <span class="nt">&lt;/servlet&gt;</span>
  <span class="nt">&lt;servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>XXX<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/servlet-mapping&gt;</span>

  <span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>appstats<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>com.google.appengine.tools.appstats.AppstatsFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;init-param&gt;</span>
      <span class="nt">&lt;param-name&gt;</span>calculateRpcCosts<span class="nt">&lt;/param-name&gt;</span>
      <span class="nt">&lt;param-value&gt;</span>true<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/init-param&gt;</span>
  <span class="nt">&lt;/filter&gt;</span>

  <span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>appstats<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/filter-mapping&gt;</span>

  <span class="nt">&lt;servlet&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>appstats<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;servlet-class&gt;</span>com.google.appengine.tools.appstats.AppstatsServlet<span class="nt">&lt;/servlet-class&gt;</span>
  <span class="nt">&lt;/servlet&gt;</span>

  <span class="nt">&lt;servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>appstats<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/appstats/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/servlet-mapping&gt;</span>

  <span class="nt">&lt;security-constraint&gt;</span>
    <span class="nt">&lt;web-resource-collection&gt;</span>
      <span class="nt">&lt;web-resource-name&gt;</span>appstats<span class="nt">&lt;/web-resource-name&gt;</span>
      <span class="nt">&lt;url-pattern&gt;</span>/appstats/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/web-resource-collection&gt;</span>
    <span class="nt">&lt;auth-constraint&gt;</span>
      <span class="nt">&lt;role-name&gt;</span>admin<span class="nt">&lt;/role-name&gt;</span>
    <span class="nt">&lt;/auth-constraint&gt;</span>
  <span class="nt">&lt;/security-constraint&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div></div><h4 id="accessing">Accessing</h4><p>After deploying your new servlet with Appstats enabled, you will be able to access the web interface at <code class="highlighter-rouge">https://project-id.appspot.com/appstats</code>.</p><h3 id="intricate-errors">Intricate errors</h3><p>You may find some odd errors, when setting up your project, which yield very little information, when searched.</p><ul><li><p><code class="highlighter-rouge">Compilation failed: No method in multimethod 'print-dup' for dispatch value: class org.sonatype.aether.repository.RemoteRepository</code></p><p>The solution here is to upgrade lein-ring to 0.9.7; the lambda-startup docs are outdated and recommend 0.9.6. I highly recommend <a href="https://github.com/xsc/lein-ancient">lein-ancient</a> for keeping dependencies up-to-date.</p></li><li><p><code class="highlighter-rouge">No API environment is registered for this thread</code></p><p>This will happen if you try to use datastore from the REPL. Since it can only be accessed from one thread, I’ve only been able to do my datastore work from within the program. It’s an annoyance, but not as serious of an issue as it first seemed.</p></li><li><p><code class="highlighter-rouge">java.lang.NullPointerException</code> in <code class="highlighter-rouge">/appstats/stats</code></p><p>If you try to view Appstats and you get this error, make sure that you’ve added the <code class="highlighter-rouge">api-labs</code> dependency to the WAR. Supplying it in your leiningen project should suffice.</p></li><li><p><code class="highlighter-rouge">java.lang.ClassNotFoundException: com.google.appengine.tools.development.ApiProxyLocalFactory</code></p><p>The lambda-startup resource doesn’t mention that the provided App Engine wrapper source (<code class="highlighter-rouge">app-engine.clj</code>) should only be compiled in the <code class="highlighter-rouge">:dev</code> profile; it should not be included in the uberwar. To handle this, update your leiningen project to include another directory and move your <code class="highlighter-rouge">app-engine.clj</code> there. The <code class="highlighter-rouge">dev</code> directory might look like this: <code class="highlighter-rouge">dev/my_app/app_engine.clj</code></p></li></ul><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="no">:profiles</span><span class="w"> </span><span class="p">{</span><span class="no">:dev</span><span class="w"> </span><span class="p">{</span><span class="no">:source-paths</span><span class="w"> </span><span class="p">[</span><span class="s">"dev/"</span><span class="p">]}}</span><span class="w">
</span></code></pre></div></div><h3 id="liberator-specific-issues">Liberator-specific issues</h3><p>For those not familiar with Clojure’s <a href="https://clojure-liberator.github.io/liberator/">Liberator</a> library, I <em>highly recommend it</em>, in conjunction with Compojure. I came across Liberator by reading <a href="http://www.flyingmachinestudios.com/programming/building-a-forum-with-clojure-datomic-angular/">this post</a>. With all of its lovely features, there are some behavior differences I’ve noticed between the App Engine development and production servers, when it comes to Liberator.</p><ul><li><p><code class="highlighter-rouge">No method in multimethod 'render-map-generic' for dispatch value: null</code></p><p>This occurs when you return a map which contains a nil key from a Liberator resource. Use <a href="http://clojuredocs.org/clojure.core/pr-str">pr-str</a> instead of returning a map directly.</p></li><li><p>Status 400 when accessing liberator/compojure routes</p><p>Watch your <a href="https://en.wikipedia.org/wiki/Media_type">MIME types</a>! The App Engine + Liberator combo isn’t so much the “issue” as Google’s front-end servers are. If you’re lazy, during development, and you’re using curl or the handy <a href="https://github.com/jkbrzt/httpie">httpie</a>, you may run into this issue because you haven’t specified an <code class="highlighter-rouge">Accept</code> header.</p></li></ul><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    curl <span class="nt">-i</span> <span class="nt">-H</span> <span class="s2">"Accept: application/json"</span> <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s2">""</span> <span class="s2">"https://project-id.appspot.com/meow?kitty=cat"</span>

    <span class="c"># or...</span>

    http POST <span class="s2">"https://project-id.appspot.com/meow?kitty=cat"</span> Accept:application/json
</code></pre></div></div><ul><li>What’s going on? While testing, an echo resource proved very useful. Google’s front-end servers may surprise you.</li></ul><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="p">(</span><span class="nf">defresource</span><span class="w"> </span><span class="n">echo</span><span class="w">
      </span><span class="no">:media-type-available?</span><span class="w"> </span><span class="p">(</span><span class="nb">constantly</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
      </span><span class="no">:method-allowed?</span><span class="w"> </span><span class="p">(</span><span class="nb">constantly</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
      </span><span class="no">:handle-ok</span><span class="w"> </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="nb">pr-str</span><span class="p">)</span><span class="w">
      </span><span class="no">:handle-created</span><span class="w"> </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="nb">pr-str</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><h3 id="one-shot-deploy-script">One-shot deploy script</h3><p>It’s been said, over and over, that a deployment should only take a single command. For this simple App Engine setup, a bash script will do the trick. The only change this requires, aside from storing the script adjacent to the <code class="highlighter-rouge">install-gae</code> script in the root of the project, is that the <code class="highlighter-rouge">appengine-web.xml</code> file is also stored in the root of the project. The project ID, which is to be kept secret, should be <code class="highlighter-rouge">XXX</code>; it’ll be read from the <code class="highlighter-rouge">gae_project_id</code> environment variable and substituted.</p><p>For something more complex, consider integrating a custom <a href="https://github.com/technomancy/leiningen/blob/stable/doc/PLUGINS.md">leiningen plugin</a>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">set</span> <span class="nt">-ue</span>

<span class="nv">here</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">cd</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="k">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="k">}</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span><span class="s2">"</span>

<span class="nb">source</span> <span class="s2">"</span><span class="nv">$here</span><span class="s2">/install-gae"</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="k">${</span><span class="nv">gae_project_id</span><span class="p">+x</span><span class="k">}</span> <span class="o">]</span><span class="p">;</span>
<span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"No gae_project_id set in environment"</span>
  <span class="nb">exit </span>1
<span class="k">fi

function </span>deploy
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"Cleaning"</span>
  lein clean

  <span class="nb">echo</span> <span class="s2">"Building uberwar"</span>
  lein ring uberwar
  <span class="nv">war</span><span class="o">=</span><span class="k">$(</span><span class="nb">ls</span> <span class="nt">-1t</span> <span class="nv">$here</span>/target/uberjar/<span class="k">*</span>.war | <span class="nb">head</span><span class="k">)</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">"x</span><span class="nv">$war</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"x"</span> <span class="o">]</span><span class="p">;</span>
  <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Unable to build war"</span>
    <span class="k">return </span>1
  <span class="k">fi

  </span><span class="nv">tmp</span><span class="o">=</span><span class="k">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span> /tmp/XXXXXX<span class="k">)</span>
  <span class="nb">echo</span> <span class="s2">"Exploding"</span>
  <span class="nb">pushd</span> <span class="s2">"</span><span class="nv">$tmp</span><span class="s2">"</span>
    jar xf <span class="s2">"</span><span class="nv">$war</span><span class="s2">"</span>
    <span class="nb">sed</span> <span class="s2">"s/XXX/</span><span class="nv">$gae_project_id</span><span class="s2">/g"</span> &lt; <span class="s2">"</span><span class="nv">$here</span><span class="s2">/appengine-web.xml"</span> <span class="o">&gt;</span> WEB-INF/appengine-web.xml
    <span class="nb">sed</span> <span class="s2">"s/XXX/</span><span class="nv">$gae_project_id</span><span class="s2">/g"</span> &lt; <span class="s2">"</span><span class="nv">$here</span><span class="s2">/web.xml"</span> <span class="o">&gt;</span> WEB-INF/web.xml

    <span class="nb">echo</span> <span class="s2">"Uploading"</span>
    <span class="s2">"</span><span class="nv">$gae_sdk</span><span class="s2">/bin/appcfg.sh"</span> update <span class="nb">.</span>
  <span class="nb">popd

  echo</span> <span class="s2">"Deployed!"</span>
<span class="o">}</span>
deploy
</code></pre></div></div><h3 id="closing-thoughts">Closing thoughts</h3><p>The biggest issue, once everything’s working, is just getting through all that Java interop. The appeal of something like <a href="https://github.com/gcv/appengine-magic">appengine-magic</a> is that so much of the cruft is hidden away. At the very least, its interface and MIT-licensed implementation gives us a starting point from which we can clean up our App Engine code.</p><p>Cognitect approached me recently, asking how I’m enjoying Datomic. Unfortunately, I replied saying it’s not being utilized, since it lacks support for Google Cloud Datastore. I was linked to the <a href="https://groups.google.com/forum/#!topic/datomic/M9v1ssUbT9Q/discussion">mailing list thread</a>, where some users have reportedly setup Datomic with Google Cloud SQL. That’s something worth investigating.</p></section><hr/><div><div class="border-bottom"><h1 class="panel-subhead">Related posts</h1><ul class="related-list"><li><h2 class="related-post-title"> <a href="/2018/04/11/system76-firmware/">Removing IME: Upgrading System76 firmware on Arch</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/11/30/noscript/">A guide to using NoScript 10.x</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/10/31/clojure-keywords/">The five common forms of Clojure keywords</a> <span class="post-category post-category-clojure">clojure</span> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/09/30/clojurescript-promesa/">Async/await in ClojureScript with Promesa</a> <span class="post-category post-category-clojure">clojure</span> <span class="post-category post-category-tutorial">tutorial</span></h2></li></ul></div></div></div></div></div> <footer> </footer></body></html>