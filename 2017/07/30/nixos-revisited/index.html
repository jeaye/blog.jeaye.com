<!DOCTYPE html><html><head><meta charset="utf-8"/><link rel="icon" type="image/png" href="https://blog.jeaye.com//assets/favicon-c551898801df70b89095c40cbb11f01ff876ecf59bfa153122137abe9459c576.png"><title>NixOS: A lasting impression</title><meta name="author" content="jeaye"/><meta name="keywords" content="jeaye,jesse,wilkerson,c++,modern,engineering,manager,software,functional,clojure,programming,linux, nixos, nix, review, digital ocean, functional programming"/><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="I'm a leader, a problem solver, and a hacker with a passion for privacy and security."><style>.icon{background-image:url("/assets/sprite-sheet-f829f47fe9f6353c7c632fee71002c94a29b8341725e19843f2c1b263869e4f2.png") !important}</style><style rel="stylesheet" type="text/css" integrity="sha256-FAEL2/AHw4sy6PSxUkN0Zt4TaPhbApIPciXM8UG6d7c=" crossorigin="anonymous">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{display:flex;flex-flow:column nowrap;margin:0;font-family:sans-serif}a{text-decoration:none}.theme-old a{color:#3d92c9}.theme-red a{color:#c93d7a}.theme-teal a{color:#c2363c}.theme-green a{color:#3dc945}.theme-penny a{color:#ec331a}a:hover,a:focus{text-decoration:underline}.theme-old .gentle-body-color{color:#222}.theme-red .gentle-body-color{color:#222}.theme-teal .gentle-body-color{color:#222}.theme-green .gentle-body-color{color:#222}.theme-penny .gentle-body-color{color:#222}.header{display:flex;flex-flow:column wrap;align-items:center;margin:0;padding:2em 40px 2em 40px;text-align:center}.theme-old .header{background:#3d4f5d;color:#999}.theme-red .header{background:#5d3d4a;color:#999}.theme-teal .header{background:#3d5d5d;color:#999}.theme-green .header{background:#3d5d40;color:#999}.theme-penny .header{background:#812d39;color:#999}.header-inner{display:flex;flex-flow:row wrap}.header-description{flex:2;text-align:left;max-width:700px}.header-icon{display:flex;flex:1;justify-content:flex-end}.header-title,.header-short-pitch{margin:0}.header-short-pitch{font-weight:300}.theme-old .header-short-pitch{color:#b0cadb}.theme-red .header-short-pitch{color:#dbb0c3}.theme-teal .header-short-pitch{color:#b0dbd9}.theme-green .header-short-pitch{color:#b0dbb3}.theme-penny .header-short-pitch{color:#ffbbcb}.header-name{font-size:2.5em}.theme-old .header-name{color:#222}.theme-red .header-name{color:#222}.theme-teal .header-name{color:#222}.theme-green .header-name{color:#222}.theme-penny .header-name{color:#222}.nav{display:flex;flex-flow:row wrap;gap:0.5em;padding-top:0.5em}.nav-item{display:flex;flex:1;white-space:nowrap}.nav-item a{background:transparent;margin-top:1em;padding:6px 14px;letter-spacing:0.05em;font-size:85%}.theme-old .nav-item a{color:#fff;border:2px solid #b0cadb}.theme-red .nav-item a{color:#fff;border:2px solid #dbb0c3}.theme-teal .nav-item a{color:#fff;border:2px solid #b0dbd9}.theme-green .nav-item a{color:#fff;border:2px solid #b0dbb3}.theme-penny .nav-item a{color:#fff;border:2px solid #ffbbcb}.nav-item a:hover,.nav-item a:focus{text-decoration:none}.theme-old .nav-item a:hover,.theme-old .nav-item a:focus{border:2px solid #3d92c9}.theme-red .nav-item a:hover,.theme-red .nav-item a:focus{border:2px solid #c93d7a}.theme-teal .nav-item a:hover,.theme-teal .nav-item a:focus{border:2px solid #3dc9c3}.theme-green .nav-item a:hover,.theme-green .nav-item a:focus{border:2px solid #3dc945}.theme-penny .nav-item a:hover,.theme-penny .nav-item a:focus{border:2px solid #ff1345}.theme-old .special-nav-item a{border:2px solid #c2a086}.theme-red .special-nav-item a{border:2px solid #86c2aa}.theme-teal .special-nav-item a{border:2px solid #c28686}.theme-green .special-nav-item a{border:2px solid #c286bc}.theme-penny .special-nav-item a{border:2px solid #87e200}.theme-old .special-nav-item a:hover,.theme-old .special-nav-item a:focus{border:2px solid #c26d36}.theme-red .special-nav-item a:hover,.theme-red .special-nav-item a:focus{border:2px solid #36c285}.theme-teal .special-nav-item a:hover,.theme-teal .special-nav-item a:focus{border:2px solid #c2363c}.theme-green .special-nav-item a:hover,.theme-green .special-nav-item a:focus{border:2px solid #c236ba}.theme-penny .special-nav-item a:hover,.theme-penny .special-nav-item a:focus{border:2px solid #78af26}.panel-h-box{display:flex;flex:1;flex-flow:row wrap;gap:10em;justify-content:center;margin:0 3em 0 3em}.panel-v-box{display:flex;flex-flow:column wrap}.panel-gap{min-width:10em}.panel-subhead{text-transform:uppercase;padding:0;font-size:80%;font-weight:500;letter-spacing:0.1em}.theme-old .panel-subhead{color:#999}.theme-red .panel-subhead{color:#999}.theme-teal .panel-subhead{color:#999}.theme-green .panel-subhead{color:#999}.theme-penny .panel-subhead{color:#999}.main-panel,.toolbox-panel,.pgp-panel,.what-i-do-panel,.main-blog-panel{margin-top:2em}.main-panel{display:flex;flex:2;max-width:1280px;min-width:400px}.toolbox-panel{display:flex;flex:1;flex-flow:column nowrap;max-width:450px;min-width:200px}.what-i-do-panel{display:flex;flex:2;flex-flow:column nowrap;min-width:400px;max-width:900px}.what-i-do-h-box{display:flex;flex-flow:row nowrap;gap:4em;margin-top:1em}.what-i-do-thing{flex:1}.what-i-do-thing-title{font-size:1.0em;line-height:0.5em}.what-i-do-title{font-size:1.0em;line-height:0.5em;text-transform:uppercase;margin-bottom:2em}.theme-old .what-i-do-title{color:#443843}.theme-red .what-i-do-title{color:#443843}.theme-teal .what-i-do-title{color:#443843}.theme-green .what-i-do-title{color:#443843}.theme-penny .what-i-do-title{color:#443843}.what-i-do-big{font-size:2.5em;line-height:1em;font-weight:bold}.theme-old .what-i-do-big{color:#222}.theme-red .what-i-do-big{color:#222}.theme-teal .what-i-do-big{color:#222}.theme-green .what-i-do-big{color:#222}.theme-penny .what-i-do-big{color:#222}.job-title{font-size:2em;margin-bottom:0.2em}.theme-old .job-title{color:#222}.theme-red .job-title{color:#222}.theme-teal .job-title{color:#222}.theme-green .job-title{color:#222}.theme-penny .job-title{color:#222}.job-at{font-size:80%;font-weight:500}.theme-old .job-at{color:#999}.theme-red .job-at{color:#999}.theme-teal .job-at{color:#999}.theme-green .job-at{color:#999}.theme-penny .job-at{color:#999}.job-company{font-size:90%}.theme-old .job-company{color:#3d92c9}.theme-red .job-company{color:#c93d7a}.theme-teal .job-company{color:#c2363c}.theme-green .job-company{color:#3dc945}.theme-penny .job-company{color:#ec331a}.posts{display:flex;justify-content:center;flex-flow:column nowrap;max-width:1280px}.post{padding-bottom:2em}.post-header{display:flex;justify-content:space-between;align-items:center}.post-title{font-size:2em;margin-bottom:0.2em}.theme-old .post-title{color:#222}.theme-red .post-title{color:#222}.theme-teal .post-title{color:#222}.theme-green .post-title{color:#222}.theme-penny .post-title{color:#222}.theme-old .post-title a{color:#222;text-decoration-color:#222}.theme-red .post-title a{color:#222;text-decoration-color:#222}.theme-teal .post-title a{color:#222;text-decoration-color:#222}.theme-green .post-title a{color:#222;text-decoration-color:#222}.theme-penny .post-title a{color:#222;text-decoration-color:#222}.post-description{font-family:Georgia, "Cambria", serif;line-height:1.8em}.theme-old .post-description{color:#222}.theme-red .post-description{color:#222}.theme-teal .post-description{color:#222}.theme-green .post-description{color:#222}.theme-penny .post-description{color:#222}.post-meta{font-size:90%;margin:0}.theme-old .post-meta{color:#222}.theme-red .post-meta{color:#222}.theme-teal .post-meta{color:#222}.theme-green .post-meta{color:#222}.theme-penny .post-meta{color:#222}.post-date{text-align:right;white-space:nowrap}.theme-old .post-date{color:#222}.theme-red .post-date{color:#222}.theme-teal .post-date{color:#222}.theme-green .post-date{color:#222}.theme-penny .post-date{color:#222}.post-updated-date{font-size:90%;font-style:italic}.theme-old .post-updated-date{color:#5aba59}.theme-red .post-updated-date{color:#5aba59}.theme-teal .post-updated-date{color:#5aba59}.theme-green .post-updated-date{color:#5aba59}.theme-penny .post-updated-date{color:#5aba59}.post-category{margin:0 0.1em;padding:0.3em 1em;font-size:80%}.theme-old .post-category{color:#fff;background:#999}.theme-red .post-category{color:#fff;background:#999}.theme-teal .post-category{color:#fff;background:#999}.theme-green .post-category{color:#fff;background:#999}.theme-penny .post-category{color:#fff;background:#999}.theme-old .post-category-review{background:#61b360}.theme-red .post-category-review{background:#61b360}.theme-teal .post-category-review{background:#61b360}.theme-green .post-category-review{background:#61b360}.theme-penny .post-category-review{background:#61b360}.theme-old .post-category-privacy,.theme-old .post-category-security{background:#4d85d1}.theme-red .post-category-privacy,.theme-red .post-category-security{background:#4d85d1}.theme-teal .post-category-privacy,.theme-teal .post-category-security{background:#4d85d1}.theme-green .post-category-privacy,.theme-green .post-category-security{background:#4d85d1}.theme-penny .post-category-privacy,.theme-penny .post-category-security{background:#4d85d1}.theme-old .post-category-rant{background:#8156a7}.theme-red .post-category-rant{background:#8156a7}.theme-teal .post-category-rant{background:#8156a7}.theme-green .post-category-rant{background:#8156a7}.theme-penny .post-category-rant{background:#8156a7}.theme-old .post-category-tutorial{background:#bd4f64}.theme-red .post-category-tutorial{background:#bd4f64}.theme-teal .post-category-tutorial{background:#bd4f64}.theme-green .post-category-tutorial{background:#bd4f64}.theme-penny .post-category-tutorial{background:#bd4f64}.theme-old .post h1,.theme-old h2,.theme-old h3,.theme-old h4{color:#222}.theme-red .post h1,.theme-red h2,.theme-red h3,.theme-red h4{color:#222}.theme-teal .post h1,.theme-teal h2,.theme-teal h3,.theme-teal h4{color:#222}.theme-green .post h1,.theme-green h2,.theme-green h3,.theme-green h4{color:#222}.theme-penny .post h1,.theme-penny h2,.theme-penny h3,.theme-penny h4{color:#222}.post p,.post ol,.post ul{font-family:Georgia, "Cambria", serif}.theme-old .post p,.theme-old .post ol,.theme-old .post ul{color:#222}.theme-red .post p,.theme-red .post ol,.theme-red .post ul{color:#222}.theme-teal .post p,.theme-teal .post ol,.theme-teal .post ul{color:#222}.theme-green .post p,.theme-green .post ol,.theme-green .post ul{color:#222}.theme-penny .post p,.theme-penny .post ol,.theme-penny .post ul{color:#222}.post p a{font-weight:600}.skills{margin:0;padding:0 3em 0 0}.skill{display:flex;gap:1em;padding:1em 0;border-bottom:1px solid #ccc}.skill:last-child{border:none !important}.skill-name{font-size:0.8em;font-weight:bold;align-self:center}.theme-old .skill-name{color:#222}.theme-red .skill-name{color:#222}.theme-teal .skill-name{color:#222}.theme-green .skill-name{color:#222}.theme-penny .skill-name{color:#222}.main-blog-panel{display:flex;justify-content:center;margin-left:10em;margin-right:10em}.blog-header{display:flex;flex-flow:row nowrap;justify-content:space-between}.border-bottom{border-bottom:1px solid #eee}.related-list{list-style-type:none}.related-list li{padding-bottom:0.5em;border-bottom:1px solid #ccc}.related-list li:last-child{border:none}.related-post-title{font-size:1em;margin-bottom:0.2em}.theme-old .related-post-title{color:#222}.theme-red .related-post-title{color:#222}.theme-teal .related-post-title{color:#222}.theme-green .related-post-title{color:#222}.theme-penny .related-post-title{color:#222}.theme-old .related-post-title a{color:#222;text-decoration-color:#222}.theme-red .related-post-title a{color:#222;text-decoration-color:#222}.theme-teal .related-post-title a{color:#222;text-decoration-color:#222}.theme-green .related-post-title a{color:#222;text-decoration-color:#222}.theme-penny .related-post-title a{color:#222;text-decoration-color:#222}figure{text-align:center;margin:0 auto}figure img{border:1px solid rgba(50,50,50,0.5);border-radius:2px;padding:5px;background:#fff}.figure-2-3{width:66%}figcaption{padding:1em 1em 2em 1em;word-wrap:normal;text-align:center;display:inline-block !important;width:66%}code{overflow:auto}.icon-feed{background-position:0px 0px;width:24px;height:30px}.icon-j{background-position:-24px 0px;width:158px;height:155px}code:not([id='typeans']){padding-left:5px;padding-right:5px;border:1px solid;border-color:lightgrey;border-radius:5px}pre code{padding:5px}.highlight .lineno{color:#ccc;display:inline-block;padding:0 5px;border-right:1px solid #ccc}.highlight pre code{display:block;white-space:pre-wrap;overflow-x:auto;word-wrap:normal}.highlight .hll{background-color:#49483e}.highlight{background:#272822;color:#f8f8f2;border-radius:5px}.highlight .c{color:#75715e}.highlight .err{color:#960050;background-color:#1e0010}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .ch{color:#75715e}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .cpf{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .gd{color:#f92672}.highlight .ge{font-style:italic}.highlight .gi{color:#a6e22e}.highlight .gs{font-weight:bold}.highlight .gu{color:#75715e}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mb{color:#ae81ff}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sa{color:#e6db74}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .dl{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#a6e22e}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .vm{color:#f8f8f2}.highlight .il{color:#ae81ff}
</style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="/feed.xml"/></head><body class="theme-penny"><div class="header"><div class="header-inner"><div class="header-description"><h1 class="header-title">My name is <span class="header-name">Jeaye</span></h1><h2 class="header-short-pitch">I'm a leader, a problem solver, and a hacker with a passion for privacy and security.</h2></div><div class="header-icon"><div class="icon icon-j"></div></div></div><nav class="nav"><div class="nav-item"> <a href="https://jeaye.com/">About</a></div><div class="nav-item"> <a href="https://github.com/jeaye">Github</a></div><div class="nav-item"> <a href="/">Blog</a></div><div class="nav-item"> <a href="https://jeaye.com/contact">Contact</a></div><div class="nav-item special-nav-item"> <a href="https://jeaye.com/contact">Hire Me!</a></div> </nav></div><div class="main-blog-panel"><div class="posts"> <section class="post"> <header class="post-header"><h2 class="post-title"> <a href="/2017/07/30/nixos-revisited/" title="/2017/07/30/nixos-revisited/"> NixOS: A lasting impression </a></h2><div class="post-date"> July 30, 2017</div> </header><p>Two years ago, I wrote about <a href="/2015/11/24/nixos/">my first impression of NixOS</a>, as I was using it in my workstation. While I adored the concept of declarative OS configuration, it didn’t quite fit the workflow I had in mind for my laptop. The post was concluded with me considering NixOS for my VPS, but I didn’t quite want to move away from DigitalOcean, which has support for only a few distros. What follows details how I’ve been running NixOS since, what it took, and what I’ve learned.</p><h3 id="dealing-with-digitalocean">Dealing with DigitalOcean</h3><p>My VPS is hosting this blog, <a href="https://jeaye.com/">jeaye.com</a>, and many other sites and services. For this, I use DigitalOcean. Ever since I started with DigitalOcean a few years ago, they’ve been joy to work with, so I really didn’t want to leave. Alas, they don’t support many distros, and certainly not custom ISOs. The first droplet I was administrating was already going against the grain, running Arch using <a href="https://github.com/gh2o/digitalocean-debian-to-arch">a script which converts Debian to Arch in place</a>.</p><p><em>“What a neat idea,”</em> I thought, <em>“to trick DigitalOcean into thinking it’s running a supported distro.”</em> A couple weeks later, <a href="https://github.com/jeaye/nixos-in-place">nixos-in-place</a> was born; it remains the most stable solution for converting any running GNU/Linux setup to NixOS in place.</p><h3 id="setting-up-complex-services">Setting up complex services</h3><p>Once NixOS was running on my DigitalOcean droplet, I had the work of porting all of the services I was running on my Arch droplet to a declarative setup which I could easily version with git. Here are some of the services I’m running, as well as the related configs for each.</p><ul><li><a href="https://github.com/jeaye/nix-files/blob/e3bf921a5af925465d8f41ec006c87c8f0ffafe3/service/httpd.nix">apache-httpd</a></li><li><a href="https://github.com/jeaye/nix-files/blob/e3bf921a5af925465d8f41ec006c87c8f0ffafe3/service/fail2ban.nix">fail2ban</a></li><li><a href="https://github.com/jeaye/nix-files/blob/e3bf921a5af925465d8f41ec006c87c8f0ffafe3/service/dovecot.nix">dovecot</a></li><li><a href="https://github.com/jeaye/nix-files/blob/e3bf921a5af925465d8f41ec006c87c8f0ffafe3/service/postfix.nix">postfix</a></li><li><a href="https://github.com/jeaye/nix-files/blob/e3bf921a5af925465d8f41ec006c87c8f0ffafe3/service/radicale.nix">radicale</a></li></ul><p>For the most part, setting up a service on NixOS is similar to setting it up on any normal distro. The difference is that one generally is limited to the API provided by that NixOS service. Unlike packages, in Nix and NixOS, services can’t be overridden. This has only been an issue once, in the past couple years, but it’s currently limiting my ability to configure <a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/mail/spamassassin.nix">spamassassin</a> (<code class="highlighter-rouge">master</code> has a much better interface than <code class="highlighter-rouge">17.03</code>).</p><p>I tend to forget things, like what I’ve set up on a machine, or everything that was required to get a service running, so having it all in plain text, and version control, in a reproducible fashion, is ideal.</p><h3 id="managing-user-homes">Managing user homes</h3><p>NixOS doesn’t provide a way to declaratively manage user homes. In fact, the only direct control it provides, declaratively, is over what’s in <code class="highlighter-rouge">/etc</code> and its subdirectories. There have been some approaches and discussions (like <a href="https://github.com/NixOS/nixpkgs/issues/1750">here</a> and <a href="https://github.com/NixOS/nixpkgs/pull/9250">here</a>), but I opted for a much simpler solution, which was already supported at the time. NixOS forfeits the conventional ideas of where programs live and how they’re installed and upgraded, so why not take that liberty with user homes?</p><p>So, since NixOS provides declarative management of <code class="highlighter-rouge">/etc</code> and its subdirectories, I just use <code class="highlighter-rouge">/etc/user</code> as my analogous <code class="highlighter-rouge">/home</code>. For example, the user <code class="highlighter-rouge">jeaye</code>, <a href="https://github.com/jeaye/nix-files/blob/e3bf921a5af925465d8f41ec006c87c8f0ffafe3/user/jeaye.nix">defined here</a>, is described as:</p><div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">users</span><span class="o">.</span><span class="nv">users</span><span class="o">.</span><span class="nv">jeaye</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="nv">isNormalUser</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nv">home</span> <span class="o">=</span> <span class="s2">"/etc/user/jeaye"</span><span class="p">;</span>
  <span class="nv">createHome</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nv">extraGroups</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"wheel"</span> <span class="p">];</span>
<span class="p">};</span>
</code></pre></div></div><p>If I want to put anything in the home directory for <code class="highlighter-rouge">jeaye</code>, I can do so declaratively, like so:</p><div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">environment</span><span class="o">.</span><span class="nv">etc</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="s2">"user/jeaye/.procmailrc"</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="nv">text</span> <span class="o">=</span>
    <span class="s2">''</span><span class="err">
</span><span class="s2">      INCLUDERC=/etc/user/jeaye/.procmail/list.rc</span><span class="err">
</span><span class="s2">      INCLUDERC=/etc/user/jeaye/.procmail/work.rc</span><span class="err">
</span><span class="s2">      INCLUDERC=/etc/user/jeaye/.procmail/admin.rc</span><span class="err">
</span><span class="s2">    ''</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

</code></pre></div></div><p>I also use a trick to ensure directories exist, which just involves declaratively putting a hidden file in there. NixOS will create any parent directories needed.</p><div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Ensure that the /etc/user/safepaste/paste directory exists</span>
<span class="nv">environment</span><span class="o">.</span><span class="nv">etc</span><span class="o">.</span><span class="s2">"user/safepaste/paste/.manage-directory"</span><span class="o">.</span><span class="nv">text</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
</code></pre></div></div><h3 id="sticking-with-mainstream-configuration-to-avoid-compilations">Sticking with mainstream configuration to avoid compilations</h3><p>Initially, I was amazed that my VPS was regularly spending an hour compiling <a href="https://en.wikipedia.org/wiki/OpenJDK">OpenJDK</a> every time I updated. After further investigation, in the helpful <code class="highlighter-rouge">#nixos</code> IRC channel on Freenode, it seems this is because I had disabled X everywhere I could. On a headless server, this seemed intuitive. Unfortunately, <a href="https://nixos.org/hydra/">NixOS Hydra</a>, which builds all of NixOS’ deterministic binaries, only builds with so many configurations. As one can imagine, each new configuration added for a build, with the various platforms, architectures, and other configurations, expands the build time exponentially. As such, the VPS now runs with <a href="https://github.com/jeaye/nix-files/blob/e3bf921a5af925465d8f41ec006c87c8f0ffafe3/system/environment.nix#L26">environment.noXlibs set to false</a>.</p><h3 id="hitting-the-network-in-an-activation-script">Hitting the network in an activation script</h3><p>I had an upgrade script, which I was running in <code class="highlighter-rouge">system.activationScripts</code>, that hit the network to check for upgrades. While the machine was already running, this posed no problem at all and worked quite nicely. Whenever I would <code class="highlighter-rouge">nixos-rebuild switch</code>, the activation script would run and upgrade the package if needed. Alas, during a routine reboot, I was no longer able to boot even into a shell; the kernel would panic. After several hours of painstaking debugging with a custom initrd, it turns out the problem was that the activation script hitting the network was failing, since there was no network, and the rest of the boot would then fail.</p><p>In short, leave network IO out of activation scripts; I’m using a cron job, for this task, instead. Simple enough.</p><h3 id="building-clojure-packages-with-leiningen">Building Clojure packages with Leiningen</h3><p>When bringing in some of my Clojure services, there were issues with compiling Leiningen projects, due to the dependency downloading. By default, the home of the Nix builder isn’t writable, so some workarounds are needed. This setup has been working for me (as part of your typical Nix package):</p><div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">buildInputs</span> <span class="o">=</span> <span class="p">[</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">leiningen</span> <span class="p">];</span>
<span class="nv">buildPhase</span> <span class="o">=</span>
<span class="s2">''</span><span class="err">
</span><span class="s2">  # For leiningen</span><span class="err">
</span><span class="s2">  export HOME=$PWD</span><span class="err">
</span><span class="s2">  export LEIN_HOME=$HOME/.lein</span><span class="err">
</span><span class="s2">  mkdir -p $LEIN_HOME</span><span class="err">
</span><span class="s2">  echo "{:user {:local-repo </span><span class="se">\"</span><span class="s2">$LEIN_HOME</span><span class="se">\"</span><span class="s2">}}" &gt; $LEIN_HOME/profiles.clj</span><span class="err">

</span><span class="s2">  </span><span class="si">${</span><span class="nv">pkgs</span><span class="o">.</span><span class="nv">leiningen</span><span class="si">}</span><span class="s2">/bin/lein uberjar</span><span class="err">
</span><span class="s2">''</span><span class="p">;</span>
</code></pre></div></div><h3 id="pulling-from-unstable-when-packages-are-too-old">Pulling from unstable when packages are too old</h3><p>Occasionally, a package in the Nix repos for a given release, like <code class="highlighter-rouge">17.03</code>, will be too old, have a bug, etc. If NixOS <code class="highlighter-rouge">master</code> has a fix for this, it might be worthwhile to bring in the <code class="highlighter-rouge">master</code> version of just that package, not your whole OS. Due to the elegance of Nix’s dependency management, this isn’t a problem at all; the <code class="highlighter-rouge">unstable</code> channel follows each successful build of the <code class="highlighter-rouge">master</code> branch, so we can just pull that in. Say we wanted to do this for <a href="https://weechat.org/">weechat</a>.</p><div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">environment</span><span class="o">.</span><span class="nv">systemPackages</span> <span class="o">=</span> <span class="kd">let</span> <span class="nv">pkgsUnstable</span> <span class="o">=</span> <span class="kr">import</span>
<span class="p">(</span>
  <span class="kr">fetchTarball</span> <span class="sx">https://github.com/NixOS/nixpkgs-channels/archive/nixos-unstable.tar.gz</span>
<span class="p">)</span>
<span class="p">{</span> <span class="p">};</span>
<span class="kn">in</span>
<span class="p">[</span>
  <span class="nv">pkgsUnstable</span><span class="o">.</span><span class="nv">weechat</span>
<span class="p">];</span>
</code></pre></div></div><p>Once the next version has been released, or the fix has been added to your default channel, then this can go back to normal.</p><div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">environment</span><span class="o">.</span><span class="nv">systemPackages</span> <span class="o">=</span>
<span class="p">[</span>
  <span class="nv">pkgs</span><span class="o">.</span><span class="nv">weechat</span>
<span class="p">];</span>
</code></pre></div></div><h3 id="minimizing-used-disk-space">Minimizing used disk space</h3><p>If left on its own, NixOS can be quite greedy with disk space. This is primarily a trade-off for the convenience of a purely functional package infrastructure, but it’s still worth noting how it can be managed. The following bits have helped keep my system pretty lean (<code class="highlighter-rouge">/nix</code> is 5.4G).</p><div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Auto GC every morning</span>
<span class="nv">nix</span><span class="o">.</span><span class="nv">gc</span><span class="o">.</span><span class="nv">automatic</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nv">services</span><span class="o">.</span><span class="nv">cron</span><span class="o">.</span><span class="nv">systemCronJobs</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"0 3 * * * root /etc/admin/optimize-nix"</span> <span class="p">];</span>

<span class="nv">environment</span><span class="o">.</span><span class="nv">etc</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="s2">"admin/optimize-nix"</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="nv">text</span> <span class="o">=</span>
    <span class="s2">''</span><span class="err">
</span><span class="s2">      #!/run/current-system/sw/bin/bash</span><span class="err">
</span><span class="s2">      set -eu</span><span class="err">

</span><span class="s2">      # Delete everything from this profile that isn't currently needed</span><span class="err">
</span><span class="s2">      nix-env --delete-generations old</span><span class="err">

</span><span class="s2">      # Delete generations older than a week</span><span class="err">
</span><span class="s2">      nix-collect-garbage</span><span class="err">
</span><span class="s2">      nix-collect-garbage --delete-older-than 7d</span><span class="err">

</span><span class="s2">      # Optimize</span><span class="err">
</span><span class="s2">      nix-store --gc --print-dead</span><span class="err">
</span><span class="s2">      nix-store --optimise</span><span class="err">
</span><span class="s2">    ''</span><span class="p">;</span>
    <span class="nv">mode</span> <span class="o">=</span> <span class="s2">"0774"</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div><h3 id="various-nitpicks-which-could-improve-the-nixos-users-experience">Various nitpicks which could improve the NixOS user’s experience</h3><ul><li><p>Calculating SHA-256 of a package isn’t easy</p><p>It seems like the best way to do this is to put in a bad SHA-256, try to build, have it fail and tell you the correct one, and then put it in.</p></li><li><p>Nix command-line UI needs a re-design</p><p>This is a <a href="https://github.com/NixOS/nix/issues/779">known issue</a> but, after nearly two years, has not yet been merged. In short, commands like <code class="highlighter-rouge">nix-env -qa</code> would become <code class="highlighter-rouge">nix search</code> and <code class="highlighter-rouge">nix-env -qc</code> would become <code class="highlighter-rouge">nix status</code>. There’s no reason users should have to remember, or learn, the former.</p></li><li><p>Editor support for Nix and Nixpkgs</p><p>Yes, there are Nix plugins for every good editor. What I haven’t seen any formal discussion about, but could help Nix along, is a more functional integration into those editors. I think <a href="https://github.com/matthewbauer/nix-mode">Emacs is currently best posed</a>, in this regard, but providing semantic completion of all the items in <a href="https://github.com/NixOS/nixpkgs">nixpkgs</a>, completion for dependency injection and Nix’s standard library, semantic highlighting, linting, SHA-256 calculation (when writing packages), etc., might really help users jump into the Nix world.</p></li><li><p>Declaring private data</p><p>This is something I’ve yet to tackle. Instead, there are various places within my NixOS files which are marked as <code class="highlighter-rouge">XXX</code>, with a comment saying what I need to do. These comments represent imperative steps I need to take when deploying this configuration to a new machine. Currently, this just entails setting up private keys, <a href="https://en.wikipedia.org/wiki/.htpasswd">htpassword</a> files, and some private git repos which I host. A possible solution for passwords, and the like, may be to commit them to git after GPG-encrypting them. For everything else, perhaps a GPG-encrypted bash script in the repo, which does the remaining setup interactively, would suffice.</p></li></ul><h3 id="considering-whats-left-and-how-things-are">Considering what’s left and how things are</h3><p>It’s been two years with NixOS on my VPS and they’ve been great. My biggest complaints are in the form of the Nix expression language itself not being very easy to use, having a good standard library, and having much documentation on doing generic tasks. In this regard, I think that <a href="https://www.gnu.org/software/guix/">GuixSD</a> is much more appealing: it uses <a href="https://www.gnu.org/software/guile/">Guile Scheme</a>, which has clear practical applications and is a much more general-purpose language that system administrators might even already know.</p><p>Guix’s stance on free software, due to it being a GNU project, is also more appealing; my VPS has absolutely no need for proprietary software (it’s only somewhat harder to argue that for my workstation).</p><p>I very much plan to keep NixOS running on my VPS and switching as much as I can to the declarative style. After having such great success in the server world, I’ve been thinking more about trying it again for my workstation. Alas, I think my issues would the Nix language would bug me enough to where that wouldn’t be enjoyable. If I can work out getting Skype (and maybe nVidia) on GuixSD, or maybe if <a href="https://ring.cx/en">GNU Ring</a> stabilizes enough, then I’d really enjoy having a declarative workspace in very much the same fashion. Maybe in two years I’ll be following up with my thoughts on that.</p></section><hr/><div><div class="border-bottom"><h1 class="panel-subhead">Related posts</h1><ul class="related-list"><li><h2 class="related-post-title"> <a href="/2018/04/11/system76-firmware/">Removing IME: Upgrading System76 firmware on Arch</a> <span class="post-category post-category-linux">linux</span></h2></li><li><h2 class="related-post-title"> <a href="/2018/02/01/gruvbox/">Switching from solarized to gruvbox</a> <span class="post-category post-category-review">review</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/08/31/clojure-code-quality/">The state of code quality tools in Clojure</a> <span class="post-category post-category-review">review</span></h2></li><li><h2 class="related-post-title"> <a href="/2016/10/31/weechat-logs/">Optimizing weechat log usage</a> <span class="post-category post-category-linux">linux</span></h2></li></ul></div></div></div></div></div> <footer> </footer></body></html>