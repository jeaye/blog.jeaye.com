<!DOCTYPE html><html><head><meta charset="utf-8"/><link rel="icon" type="image/png" href="https://blog.jeaye.com//assets/favicon-c551898801df70b89095c40cbb11f01ff876ecf59bfa153122137abe9459c576.png"><title>Porting Orchestra to ClojureScript</title><meta name="author" content="jeaye"/><meta name="keywords" content="jeaye,jesse,wilkerson,c++,modern,engineering,manager,software,functional,clojure,programming,clojure, clojurescript, spec, orchestra, dependent types, safety"/><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="I'm a leader, a problem solver, and a hacker with a passion for privacy and security."><style>.icon{background-image:url("/assets/sprite-sheet-f829f47fe9f6353c7c632fee71002c94a29b8341725e19843f2c1b263869e4f2.png") !important}</style><style rel="stylesheet" type="text/css" integrity="sha256-FAEL2/AHw4sy6PSxUkN0Zt4TaPhbApIPciXM8UG6d7c=" crossorigin="anonymous">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{display:flex;flex-flow:column nowrap;margin:0;font-family:sans-serif}a{text-decoration:none}.theme-old a{color:#3d92c9}.theme-red a{color:#c93d7a}.theme-teal a{color:#c2363c}.theme-green a{color:#3dc945}.theme-penny a{color:#ec331a}a:hover,a:focus{text-decoration:underline}.theme-old .gentle-body-color{color:#222}.theme-red .gentle-body-color{color:#222}.theme-teal .gentle-body-color{color:#222}.theme-green .gentle-body-color{color:#222}.theme-penny .gentle-body-color{color:#222}.header{display:flex;flex-flow:column wrap;align-items:center;margin:0;padding:2em 40px 2em 40px;text-align:center}.theme-old .header{background:#3d4f5d;color:#999}.theme-red .header{background:#5d3d4a;color:#999}.theme-teal .header{background:#3d5d5d;color:#999}.theme-green .header{background:#3d5d40;color:#999}.theme-penny .header{background:#812d39;color:#999}.header-inner{display:flex;flex-flow:row wrap}.header-description{flex:2;text-align:left;max-width:700px}.header-icon{display:flex;flex:1;justify-content:flex-end}.header-title,.header-short-pitch{margin:0}.header-short-pitch{font-weight:300}.theme-old .header-short-pitch{color:#b0cadb}.theme-red .header-short-pitch{color:#dbb0c3}.theme-teal .header-short-pitch{color:#b0dbd9}.theme-green .header-short-pitch{color:#b0dbb3}.theme-penny .header-short-pitch{color:#ffbbcb}.header-name{font-size:2.5em}.theme-old .header-name{color:#222}.theme-red .header-name{color:#222}.theme-teal .header-name{color:#222}.theme-green .header-name{color:#222}.theme-penny .header-name{color:#222}.nav{display:flex;flex-flow:row wrap;gap:0.5em;padding-top:0.5em}.nav-item{display:flex;flex:1;white-space:nowrap}.nav-item a{background:transparent;margin-top:1em;padding:6px 14px;letter-spacing:0.05em;font-size:85%}.theme-old .nav-item a{color:#fff;border:2px solid #b0cadb}.theme-red .nav-item a{color:#fff;border:2px solid #dbb0c3}.theme-teal .nav-item a{color:#fff;border:2px solid #b0dbd9}.theme-green .nav-item a{color:#fff;border:2px solid #b0dbb3}.theme-penny .nav-item a{color:#fff;border:2px solid #ffbbcb}.nav-item a:hover,.nav-item a:focus{text-decoration:none}.theme-old .nav-item a:hover,.theme-old .nav-item a:focus{border:2px solid #3d92c9}.theme-red .nav-item a:hover,.theme-red .nav-item a:focus{border:2px solid #c93d7a}.theme-teal .nav-item a:hover,.theme-teal .nav-item a:focus{border:2px solid #3dc9c3}.theme-green .nav-item a:hover,.theme-green .nav-item a:focus{border:2px solid #3dc945}.theme-penny .nav-item a:hover,.theme-penny .nav-item a:focus{border:2px solid #ff1345}.theme-old .special-nav-item a{border:2px solid #c2a086}.theme-red .special-nav-item a{border:2px solid #86c2aa}.theme-teal .special-nav-item a{border:2px solid #c28686}.theme-green .special-nav-item a{border:2px solid #c286bc}.theme-penny .special-nav-item a{border:2px solid #87e200}.theme-old .special-nav-item a:hover,.theme-old .special-nav-item a:focus{border:2px solid #c26d36}.theme-red .special-nav-item a:hover,.theme-red .special-nav-item a:focus{border:2px solid #36c285}.theme-teal .special-nav-item a:hover,.theme-teal .special-nav-item a:focus{border:2px solid #c2363c}.theme-green .special-nav-item a:hover,.theme-green .special-nav-item a:focus{border:2px solid #c236ba}.theme-penny .special-nav-item a:hover,.theme-penny .special-nav-item a:focus{border:2px solid #78af26}.panel-h-box{display:flex;flex:1;flex-flow:row wrap;gap:10em;justify-content:center;margin:0 3em 0 3em}.panel-v-box{display:flex;flex-flow:column wrap}.panel-gap{min-width:10em}.panel-subhead{text-transform:uppercase;padding:0;font-size:80%;font-weight:500;letter-spacing:0.1em}.theme-old .panel-subhead{color:#999}.theme-red .panel-subhead{color:#999}.theme-teal .panel-subhead{color:#999}.theme-green .panel-subhead{color:#999}.theme-penny .panel-subhead{color:#999}.main-panel,.toolbox-panel,.pgp-panel,.what-i-do-panel,.main-blog-panel{margin-top:2em}.main-panel{display:flex;flex:2;max-width:1280px;min-width:400px}.toolbox-panel{display:flex;flex:1;flex-flow:column nowrap;max-width:450px;min-width:200px}.what-i-do-panel{display:flex;flex:2;flex-flow:column nowrap;min-width:400px;max-width:900px}.what-i-do-h-box{display:flex;flex-flow:row nowrap;gap:4em;margin-top:1em}.what-i-do-thing{flex:1}.what-i-do-thing-title{font-size:1.0em;line-height:0.5em}.what-i-do-title{font-size:1.0em;line-height:0.5em;text-transform:uppercase;margin-bottom:2em}.theme-old .what-i-do-title{color:#443843}.theme-red .what-i-do-title{color:#443843}.theme-teal .what-i-do-title{color:#443843}.theme-green .what-i-do-title{color:#443843}.theme-penny .what-i-do-title{color:#443843}.what-i-do-big{font-size:2.5em;line-height:1em;font-weight:bold}.theme-old .what-i-do-big{color:#222}.theme-red .what-i-do-big{color:#222}.theme-teal .what-i-do-big{color:#222}.theme-green .what-i-do-big{color:#222}.theme-penny .what-i-do-big{color:#222}.job-title{font-size:2em;margin-bottom:0.2em}.theme-old .job-title{color:#222}.theme-red .job-title{color:#222}.theme-teal .job-title{color:#222}.theme-green .job-title{color:#222}.theme-penny .job-title{color:#222}.job-at{font-size:80%;font-weight:500}.theme-old .job-at{color:#999}.theme-red .job-at{color:#999}.theme-teal .job-at{color:#999}.theme-green .job-at{color:#999}.theme-penny .job-at{color:#999}.job-company{font-size:90%}.theme-old .job-company{color:#3d92c9}.theme-red .job-company{color:#c93d7a}.theme-teal .job-company{color:#c2363c}.theme-green .job-company{color:#3dc945}.theme-penny .job-company{color:#ec331a}.posts{display:flex;justify-content:center;flex-flow:column nowrap;max-width:1280px}.post{padding-bottom:2em}.post-header{display:flex;justify-content:space-between;align-items:center}.post-title{font-size:2em;margin-bottom:0.2em}.theme-old .post-title{color:#222}.theme-red .post-title{color:#222}.theme-teal .post-title{color:#222}.theme-green .post-title{color:#222}.theme-penny .post-title{color:#222}.theme-old .post-title a{color:#222;text-decoration-color:#222}.theme-red .post-title a{color:#222;text-decoration-color:#222}.theme-teal .post-title a{color:#222;text-decoration-color:#222}.theme-green .post-title a{color:#222;text-decoration-color:#222}.theme-penny .post-title a{color:#222;text-decoration-color:#222}.post-description{font-family:Georgia, "Cambria", serif;line-height:1.8em}.theme-old .post-description{color:#222}.theme-red .post-description{color:#222}.theme-teal .post-description{color:#222}.theme-green .post-description{color:#222}.theme-penny .post-description{color:#222}.post-meta{font-size:90%;margin:0}.theme-old .post-meta{color:#222}.theme-red .post-meta{color:#222}.theme-teal .post-meta{color:#222}.theme-green .post-meta{color:#222}.theme-penny .post-meta{color:#222}.post-date{text-align:right;white-space:nowrap}.theme-old .post-date{color:#222}.theme-red .post-date{color:#222}.theme-teal .post-date{color:#222}.theme-green .post-date{color:#222}.theme-penny .post-date{color:#222}.post-updated-date{font-size:90%;font-style:italic}.theme-old .post-updated-date{color:#5aba59}.theme-red .post-updated-date{color:#5aba59}.theme-teal .post-updated-date{color:#5aba59}.theme-green .post-updated-date{color:#5aba59}.theme-penny .post-updated-date{color:#5aba59}.post-category{margin:0 0.1em;padding:0.3em 1em;font-size:80%}.theme-old .post-category{color:#fff;background:#999}.theme-red .post-category{color:#fff;background:#999}.theme-teal .post-category{color:#fff;background:#999}.theme-green .post-category{color:#fff;background:#999}.theme-penny .post-category{color:#fff;background:#999}.theme-old .post-category-review{background:#61b360}.theme-red .post-category-review{background:#61b360}.theme-teal .post-category-review{background:#61b360}.theme-green .post-category-review{background:#61b360}.theme-penny .post-category-review{background:#61b360}.theme-old .post-category-privacy,.theme-old .post-category-security{background:#4d85d1}.theme-red .post-category-privacy,.theme-red .post-category-security{background:#4d85d1}.theme-teal .post-category-privacy,.theme-teal .post-category-security{background:#4d85d1}.theme-green .post-category-privacy,.theme-green .post-category-security{background:#4d85d1}.theme-penny .post-category-privacy,.theme-penny .post-category-security{background:#4d85d1}.theme-old .post-category-rant{background:#8156a7}.theme-red .post-category-rant{background:#8156a7}.theme-teal .post-category-rant{background:#8156a7}.theme-green .post-category-rant{background:#8156a7}.theme-penny .post-category-rant{background:#8156a7}.theme-old .post-category-tutorial{background:#bd4f64}.theme-red .post-category-tutorial{background:#bd4f64}.theme-teal .post-category-tutorial{background:#bd4f64}.theme-green .post-category-tutorial{background:#bd4f64}.theme-penny .post-category-tutorial{background:#bd4f64}.theme-old .post h1,.theme-old h2,.theme-old h3,.theme-old h4{color:#222}.theme-red .post h1,.theme-red h2,.theme-red h3,.theme-red h4{color:#222}.theme-teal .post h1,.theme-teal h2,.theme-teal h3,.theme-teal h4{color:#222}.theme-green .post h1,.theme-green h2,.theme-green h3,.theme-green h4{color:#222}.theme-penny .post h1,.theme-penny h2,.theme-penny h3,.theme-penny h4{color:#222}.post p,.post ol,.post ul{font-family:Georgia, "Cambria", serif}.theme-old .post p,.theme-old .post ol,.theme-old .post ul{color:#222}.theme-red .post p,.theme-red .post ol,.theme-red .post ul{color:#222}.theme-teal .post p,.theme-teal .post ol,.theme-teal .post ul{color:#222}.theme-green .post p,.theme-green .post ol,.theme-green .post ul{color:#222}.theme-penny .post p,.theme-penny .post ol,.theme-penny .post ul{color:#222}.post p a{font-weight:600}.skills{margin:0;padding:0 3em 0 0}.skill{display:flex;gap:1em;padding:1em 0;border-bottom:1px solid #ccc}.skill:last-child{border:none !important}.skill-name{font-size:0.8em;font-weight:bold;align-self:center}.theme-old .skill-name{color:#222}.theme-red .skill-name{color:#222}.theme-teal .skill-name{color:#222}.theme-green .skill-name{color:#222}.theme-penny .skill-name{color:#222}.main-blog-panel{display:flex;justify-content:center;margin-left:10em;margin-right:10em}.blog-header{display:flex;flex-flow:row nowrap;justify-content:space-between}.border-bottom{border-bottom:1px solid #eee}.related-list{list-style-type:none}.related-list li{padding-bottom:0.5em;border-bottom:1px solid #ccc}.related-list li:last-child{border:none}.related-post-title{font-size:1em;margin-bottom:0.2em}.theme-old .related-post-title{color:#222}.theme-red .related-post-title{color:#222}.theme-teal .related-post-title{color:#222}.theme-green .related-post-title{color:#222}.theme-penny .related-post-title{color:#222}.theme-old .related-post-title a{color:#222;text-decoration-color:#222}.theme-red .related-post-title a{color:#222;text-decoration-color:#222}.theme-teal .related-post-title a{color:#222;text-decoration-color:#222}.theme-green .related-post-title a{color:#222;text-decoration-color:#222}.theme-penny .related-post-title a{color:#222;text-decoration-color:#222}figure{text-align:center;margin:0 auto}figure img{border:1px solid rgba(50,50,50,0.5);border-radius:2px;padding:5px;background:#fff}.figure-2-3{width:66%}figcaption{padding:1em 1em 2em 1em;word-wrap:normal;text-align:center;display:inline-block !important;width:66%}code{overflow:auto}.icon-feed{background-position:0px 0px;width:24px;height:30px}.icon-j{background-position:-24px 0px;width:158px;height:155px}code:not([id='typeans']){padding-left:5px;padding-right:5px;border:1px solid;border-color:lightgrey;border-radius:5px}pre code{padding:5px}.highlight .lineno{color:#ccc;display:inline-block;padding:0 5px;border-right:1px solid #ccc}.highlight pre code{display:block;white-space:pre-wrap;overflow-x:auto;word-wrap:normal}.highlight .hll{background-color:#49483e}.highlight{background:#272822;color:#f8f8f2;border-radius:5px}.highlight .c{color:#75715e}.highlight .err{color:#960050;background-color:#1e0010}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .ch{color:#75715e}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .cpf{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .gd{color:#f92672}.highlight .ge{font-style:italic}.highlight .gi{color:#a6e22e}.highlight .gs{font-weight:bold}.highlight .gu{color:#75715e}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mb{color:#ae81ff}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sa{color:#e6db74}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .dl{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#a6e22e}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .vm{color:#f8f8f2}.highlight .il{color:#ae81ff}
</style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="/feed.xml"/></head><body class="theme-penny"><div class="header"><div class="header-inner"><div class="header-description"><h1 class="header-title">My name is <span class="header-name">Jeaye</span></h1><h2 class="header-short-pitch">I'm a leader, a problem solver, and a hacker with a passion for privacy and security.</h2></div><div class="header-icon"><div class="icon icon-j"></div></div></div><nav class="nav"><div class="nav-item"> <a href="https://jeaye.com/">About</a></div><div class="nav-item"> <a href="https://github.com/jeaye">Github</a></div><div class="nav-item"> <a href="/">Blog</a></div><div class="nav-item"> <a href="https://jeaye.com/contact">Contact</a></div><div class="nav-item special-nav-item"> <a href="https://jeaye.com/contact">Hire Me!</a></div> </nav></div><div class="main-blog-panel"><div class="posts"> <section class="post"> <header class="post-header"><h2 class="post-title"> <a href="/2017/06/30/orchestra-cljs/" title="/2017/06/30/orchestra-cljs/"> Porting Orchestra to ClojureScript </a></h2><div class="post-date"> June 30, 2017</div> </header><p><a href="https://github.com/jeaye/orchestra">Orchestra</a> is a Clojure library made as a drop-in replacement for <code class="highlighter-rouge">clojure.spec.test.alpha</code>, which provides custom instrumentation that validates all aspects of function specs. Now, it also works with ClojureScript. This post covers some pitfalls of porting Clojure projects to ClojureScript, as well as some instruction for those looking to do so while maintaining a respectable amount of sanity.</p><h3 id="consideration-directory-structure">Consideration: Directory structure</h3><p>For sake of illustration, imagine you’re porting a hypothetical <code class="highlighter-rouge">kitty-ninja</code> Clojure project to ClojureScript. Your directory structure almost certainly looks like this:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── project.clj
├── src
│   └── kitty_ninja
│       ├── core.clj
│       └── meow.clj
└── test
    └── kitty_ninja
        ├── core_test.clj
        └── meow_test.clj
</code></pre></div></div><p>There are three types of Clojure files to deal with, when supporting both Clojure and ClojureScript. There’s the obvious <code class="highlighter-rouge">clj</code> and <code class="highlighter-rouge">cljs</code>, but also <code class="highlighter-rouge">cljc</code>, which represents a file which may be compiled as either Clojure or ClojureScript. When refactoring your shared code from Clojure land to be exposed to ClojureScript, <code class="highlighter-rouge">cljc</code> is what will be used. For the most part, code in <code class="highlighter-rouge">cljc</code> files can either be Clojure or ClojureScript, but platform-specific bits can also be included using <a href="https://clojure.org/guides/reader_conditionals">reader conditionals</a>.</p><p>The directory structure is thus changed to something like this:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── project.clj
├── src
│   ├── clj
│   │   └── kitty_ninja
│   │       └── core.clj
│   ├── cljc
│   │   └── kitty_ninja
│   │       └── meow.cljc
│   └── cljs
│       └── kitty_ninja_cljs
│           └── core.cljs
└── test
    ├── clj
    │   └── kitty_ninja
    │       └── core_test.clj
    ├── cljc
    │   └── kitty_ninja
    │       └── meow_test.cljc
    └── cljs
        └── kitty_ninja_cljs
            └── core_test.cljs
</code></pre></div></div><p>As is shown, the <code class="highlighter-rouge">meow</code> functionality is shared between both Clojure and ClojureScript. Furthermore, its tests are also shared. Aside from that, both Clojure and ClojureScript have their own platform-specific code and tests/entry points as well. More on this later.</p><h3 id="pitfall-namespaces">Pitfall: Namespaces</h3><p>The likely first thought, when looking to port the <code class="highlighter-rouge">kitty-ninja</code> project to ClojureScript, would be to also have the ClojureScript counterpart be in the <code class="highlighter-rouge">kitty-ninja</code> namespace.</p><p><em>This will cause much, much more harm than good.</em></p><p>For this reason, we have <code class="highlighter-rouge">cljs.spec</code> instead of <code class="highlighter-rouge">clojure.spec</code> for ClojureScript. Similarly, we now have <code class="highlighter-rouge">orchestra-cljs.spec.test</code> instead of <code class="highlighter-rouge">orchestra.spec.test</code>. Since ClojureScript can actually require Clojure files, and all of its macros are run in Clojure, as well as the class path issues that arise with having <code class="highlighter-rouge">src/clj/</code> and <code class="highlighter-rouge">src/cljs/</code> in your Leiningen <code class="highlighter-rouge">:source-paths</code>, just agree from the start that your ClojureScript port will be in a different namespace.</p><h3 id="pitfall-macros">Pitfall: Macros</h3><p>In ClojureScript, macro expansion is a very distinct phase of compilation, which involves running Clojure on the ClojureScript code. As such, macros need to be in either a <code class="highlighter-rouge">clj</code> or <code class="highlighter-rouge">cljc</code> file. Part of refactoring <code class="highlighter-rouge">kitty-ninja</code>, or any other project, would involve moving the macros which will be shared with ClojureScript to the <code class="highlighter-rouge">src/cljc/</code> directory. Furthermore, any ClojureScript-specific macros may be kept in the <code class="highlighter-rouge">src/cljs/</code> directory. This may be counter-intuitive, since it means there will be <code class="highlighter-rouge">cljc</code> files in <code class="highlighter-rouge">src/cljs/</code>, but this makes sense in the case where they’re for ClojureScript-only macros.</p><p>There is also a pattern, which has largely gone unstated as far I can tell, where a <code class="highlighter-rouge">cljs</code> and <code class="highlighter-rouge">cljc</code> file can have the same file name and namespace. If the <code class="highlighter-rouge">cljs</code> file requires the <code class="highlighter-rouge">cljc</code> version, to bring in its macros, then they’ll automatically be available to anyone to requires the <code class="highlighter-rouge">cljs</code> file. Here’s an illustration of how that works:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
└── src
    └── cljs
        └── kitty_ninja_cljs
            ├── core.cljs
            ├── stealth.cljc
            └── stealth.cljs
</code></pre></div></div><p><strong>stealth.cljc</strong>:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">kitty-ninja-cljs.stealth</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">purr</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"purrrr"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p><strong>stealth.cljs</strong>:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">kitty-ninja-cljs.stealth</span><span class="w">
  </span><span class="p">(</span><span class="no">:require-macros</span><span class="w"> </span><span class="p">[</span><span class="n">kitty-ninja-cljs.stealth</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">st</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div><p><strong>core.cljs:</strong></p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">kitty-ninja-cljs.core</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">kitty-ninja-cljs.stealth</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">st</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="nf">st/purr</span><span class="p">)</span><span class="w"> </span><span class="c1">; Macro invocation without having to do require-macros</span><span class="w">
</span></code></pre></div></div><h3 id="pitfall-cljsbuild-profiles">Pitfall: Cljsbuild profiles</h3><p>Unlike <a href="https://github.com/technomancy/leiningen/blob/master/doc/PROFILES.md">Leiningen profiles</a>, which are quite flexible, <a href="https://github.com/emezeske/lein-cljsbuild">cljsbuild</a> profiles tend toward redundancy. Furthermore, cljsbuild requires a top-level key in the <code class="highlighter-rouge">project.clj</code>. As a result, the best setup I’ve found is to provide the base information at the top-level, using a fixed build name, rather than in a shared Leiningen profile. From there, use Leiningen profiles to customize the values you need. Here’s an annotated example from Orchestra:</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">defproject</span><span class="w"> </span><span class="c1">; ... elided a great deal ...</span><span class="w">

  </span><span class="c1">; Keep cljs in here so `lein jar` packages the sources</span><span class="w">
  </span><span class="no">:source-paths</span><span class="w"> </span><span class="p">[</span><span class="s">"src/clj/"</span><span class="w"> </span><span class="s">"src/cljs/"</span><span class="p">]</span><span class="w">

  </span><span class="c1">; Base cljs setup</span><span class="w">
  </span><span class="no">:cljsbuild</span><span class="w"> </span><span class="p">{</span><span class="no">:test-commands</span><span class="w"> </span><span class="p">{</span><span class="s">"test"</span><span class="w"> </span><span class="p">[</span><span class="s">"lein"</span><span class="w"> </span><span class="s">"doo"</span><span class="w"> </span><span class="s">"node"</span><span class="w"> </span><span class="s">"app"</span><span class="w"> </span><span class="s">"once"</span><span class="p">]}</span><span class="w">
              </span><span class="no">:builds</span><span class="w"> </span><span class="p">{</span><span class="no">:app</span><span class="w">
                       </span><span class="p">{</span><span class="no">:source-paths</span><span class="w"> </span><span class="p">[</span><span class="s">"src/cljs/"</span><span class="p">]</span><span class="w">
                        </span><span class="no">:compiler</span><span class="w">
                        </span><span class="p">{</span><span class="no">:optimizations</span><span class="w"> </span><span class="no">:advanced</span><span class="w">
                         </span><span class="no">:pretty-print</span><span class="w"> </span><span class="n">false</span><span class="w">
                         </span><span class="no">:parallel-build</span><span class="w"> </span><span class="n">true</span><span class="w">
                         </span><span class="no">:output-dir</span><span class="w"> </span><span class="s">"target/test"</span><span class="w">
                         </span><span class="no">:output-to</span><span class="w"> </span><span class="s">"target/test.js"</span><span class="p">}}}}</span><span class="w">

  </span><span class="c1">; Custom dev dependencies, sources, and entry point for test running</span><span class="w">
  </span><span class="no">:profiles</span><span class="w"> </span><span class="p">{</span><span class="no">:dev</span><span class="w"> </span><span class="p">{</span><span class="no">:dependencies</span><span class="w"> </span><span class="p">[[</span><span class="n">lein-doo</span><span class="w"> </span><span class="s">"0.1.7"</span><span class="p">]]</span><span class="w">
                   </span><span class="no">:source-paths</span><span class="w"> </span><span class="p">[</span><span class="s">"test/clj/"</span><span class="w"> </span><span class="s">"test/cljc/"</span><span class="p">]</span><span class="w">
                   </span><span class="no">:cljsbuild</span><span class="w"> </span><span class="p">{</span><span class="no">:builds</span><span class="w"> </span><span class="p">{</span><span class="no">:app</span><span class="w">
                                        </span><span class="p">{</span><span class="no">:source-paths</span><span class="w"> </span><span class="p">[</span><span class="s">"test/cljs/"</span><span class="w"> </span><span class="s">"test/cljc/"</span><span class="p">]</span><span class="w">
                                         </span><span class="no">:compiler</span><span class="w">
                                         </span><span class="p">{</span><span class="no">:main</span><span class="w"> </span><span class="n">orchestra-cljs.test</span><span class="w">
                                          </span><span class="no">:target</span><span class="w"> </span><span class="no">:nodejs</span><span class="p">}}}}}})</span><span class="w">
</span></code></pre></div></div><h3 id="consideration-tests-with-doo">Consideration: Tests with doo</h3><p>A combination of <a href="https://github.com/bensu/doo">doo</a> and ClojureScript’s <code class="highlighter-rouge">cljs.test</code> will allow for mostly painless sharing of tests between Clojure and ClojureScript. A word of caution, however, based on my experience:</p><p><em>Use Node for your tests, not Phantom.</em></p><p>There exists an <a href="https://github.com/bensu/doo/issues/135">issue on doo</a> for this, but PhantomJS is not as well supported and, in my experience, not nearly as reliable. Fortunately, switching to Node should be as easy as adding <code class="highlighter-rouge">:target :nodejs</code> to the cljsbuild profile and changing the <code class="highlighter-rouge">lein doo</code> command to use <code class="highlighter-rouge">node</code> instead of <code class="highlighter-rouge">phantom</code>. See the Orchestra profile above for reference.</p><h3 id="pitfall-figwheels-repl">Pitfall: Figwheel’s REPL</h3><p>If you end up using <a href="https://github.com/bhauman/lein-figwheel">figwheel</a>, which arguably most non-trivial ClojureScript projects do, absolutely consider using <a href="https://github.com/hanslub42/rlwrap">rlwrap</a> (available on most Unix-like platforms). By default, fighwheel’s REPL doesn’t provide history (up and down arrows), word/line based editing (like <code class="highlighter-rouge">^W</code> and <code class="highlighter-rouge">^U</code>), or reverse search of previous inputs (using <code class="highlighter-rouge">^R</code>). rlwrap will provide all of these otherwise ubiquitous features for you, without breaking any figwheel functionality.</p><h3 id="wrapping-up">Wrapping up</h3><p>ClojureScript’s tooling doesn’t compare to Clojure’s, but it’s certainly a capable platform. For those already working in ClojureScript, be it with React(Native) or anything else, please do consider using spec and instrumentation to aid in your development. For those coming to ClojureScript, from Clojure, hopefully these points will save you some time.</p></section><hr/><div><div class="border-bottom"><h1 class="panel-subhead">Related posts</h1><ul class="related-list"><li><h2 class="related-post-title"> <a href="/2017/10/31/clojure-keywords/">The five common forms of Clojure keywords</a> <span class="post-category post-category-clojure">clojure</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/09/30/clojurescript-promesa/">Async/await in ClojureScript with Promesa</a> <span class="post-category post-category-clojure">clojure</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/08/31/clojure-code-quality/">The state of code quality tools in Clojure</a> <span class="post-category post-category-clojure">clojure</span> <span class="post-category post-category-safety">safety</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/05/31/clojure-spec/">Dear Clojure devs, use clojure.spec please</a> <span class="post-category post-category-clojure">clojure</span> <span class="post-category post-category-safety">safety</span></h2></li></ul></div></div></div></div></div> <footer> </footer></body></html>