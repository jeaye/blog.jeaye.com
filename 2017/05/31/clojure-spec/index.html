<!DOCTYPE html><html><head><meta charset="utf-8"/><link rel="icon" type="image/png" href="https://blog.jeaye.com//assets/favicon-c551898801df70b89095c40cbb11f01ff876ecf59bfa153122137abe9459c576.png"><title>Dear Clojure devs, use clojure.spec please</title><meta name="author" content="jeaye"/><meta name="keywords" content="jeaye,jesse,wilkerson,c++,modern,engineering,manager,software,functional,clojure,programming,clojure, spec, orchestra, rant, dependent types, safety"/><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="I'm a leader, a problem solver, and a hacker with a passion for privacy and security."><style>.icon{background-image:url("/assets/sprite-sheet-f829f47fe9f6353c7c632fee71002c94a29b8341725e19843f2c1b263869e4f2.png") !important}</style><style rel="stylesheet" type="text/css" integrity="sha256-FAEL2/AHw4sy6PSxUkN0Zt4TaPhbApIPciXM8UG6d7c=" crossorigin="anonymous">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{display:flex;flex-flow:column nowrap;margin:0;font-family:sans-serif}a{text-decoration:none}.theme-old a{color:#3d92c9}.theme-red a{color:#c93d7a}.theme-teal a{color:#c2363c}.theme-green a{color:#3dc945}.theme-penny a{color:#ec331a}a:hover,a:focus{text-decoration:underline}.theme-old .gentle-body-color{color:#222}.theme-red .gentle-body-color{color:#222}.theme-teal .gentle-body-color{color:#222}.theme-green .gentle-body-color{color:#222}.theme-penny .gentle-body-color{color:#222}.header{display:flex;flex-flow:column wrap;align-items:center;margin:0;padding:2em 40px 2em 40px;text-align:center}.theme-old .header{background:#3d4f5d;color:#999}.theme-red .header{background:#5d3d4a;color:#999}.theme-teal .header{background:#3d5d5d;color:#999}.theme-green .header{background:#3d5d40;color:#999}.theme-penny .header{background:#812d39;color:#999}.header-inner{display:flex;flex-flow:row wrap}.header-description{flex:2;text-align:left;max-width:700px}.header-icon{display:flex;flex:1;justify-content:flex-end}.header-title,.header-short-pitch{margin:0}.header-short-pitch{font-weight:300}.theme-old .header-short-pitch{color:#b0cadb}.theme-red .header-short-pitch{color:#dbb0c3}.theme-teal .header-short-pitch{color:#b0dbd9}.theme-green .header-short-pitch{color:#b0dbb3}.theme-penny .header-short-pitch{color:#ffbbcb}.header-name{font-size:2.5em}.theme-old .header-name{color:#222}.theme-red .header-name{color:#222}.theme-teal .header-name{color:#222}.theme-green .header-name{color:#222}.theme-penny .header-name{color:#222}.nav{display:flex;flex-flow:row wrap;gap:0.5em;padding-top:0.5em}.nav-item{display:flex;flex:1;white-space:nowrap}.nav-item a{background:transparent;margin-top:1em;padding:6px 14px;letter-spacing:0.05em;font-size:85%}.theme-old .nav-item a{color:#fff;border:2px solid #b0cadb}.theme-red .nav-item a{color:#fff;border:2px solid #dbb0c3}.theme-teal .nav-item a{color:#fff;border:2px solid #b0dbd9}.theme-green .nav-item a{color:#fff;border:2px solid #b0dbb3}.theme-penny .nav-item a{color:#fff;border:2px solid #ffbbcb}.nav-item a:hover,.nav-item a:focus{text-decoration:none}.theme-old .nav-item a:hover,.theme-old .nav-item a:focus{border:2px solid #3d92c9}.theme-red .nav-item a:hover,.theme-red .nav-item a:focus{border:2px solid #c93d7a}.theme-teal .nav-item a:hover,.theme-teal .nav-item a:focus{border:2px solid #3dc9c3}.theme-green .nav-item a:hover,.theme-green .nav-item a:focus{border:2px solid #3dc945}.theme-penny .nav-item a:hover,.theme-penny .nav-item a:focus{border:2px solid #ff1345}.theme-old .special-nav-item a{border:2px solid #c2a086}.theme-red .special-nav-item a{border:2px solid #86c2aa}.theme-teal .special-nav-item a{border:2px solid #c28686}.theme-green .special-nav-item a{border:2px solid #c286bc}.theme-penny .special-nav-item a{border:2px solid #87e200}.theme-old .special-nav-item a:hover,.theme-old .special-nav-item a:focus{border:2px solid #c26d36}.theme-red .special-nav-item a:hover,.theme-red .special-nav-item a:focus{border:2px solid #36c285}.theme-teal .special-nav-item a:hover,.theme-teal .special-nav-item a:focus{border:2px solid #c2363c}.theme-green .special-nav-item a:hover,.theme-green .special-nav-item a:focus{border:2px solid #c236ba}.theme-penny .special-nav-item a:hover,.theme-penny .special-nav-item a:focus{border:2px solid #78af26}.panel-h-box{display:flex;flex:1;flex-flow:row wrap;gap:10em;justify-content:center;margin:0 3em 0 3em}.panel-v-box{display:flex;flex-flow:column wrap}.panel-gap{min-width:10em}.panel-subhead{text-transform:uppercase;padding:0;font-size:80%;font-weight:500;letter-spacing:0.1em}.theme-old .panel-subhead{color:#999}.theme-red .panel-subhead{color:#999}.theme-teal .panel-subhead{color:#999}.theme-green .panel-subhead{color:#999}.theme-penny .panel-subhead{color:#999}.main-panel,.toolbox-panel,.pgp-panel,.what-i-do-panel,.main-blog-panel{margin-top:2em}.main-panel{display:flex;flex:2;max-width:1280px;min-width:400px}.toolbox-panel{display:flex;flex:1;flex-flow:column nowrap;max-width:450px;min-width:200px}.what-i-do-panel{display:flex;flex:2;flex-flow:column nowrap;min-width:400px;max-width:900px}.what-i-do-h-box{display:flex;flex-flow:row nowrap;gap:4em;margin-top:1em}.what-i-do-thing{flex:1}.what-i-do-thing-title{font-size:1.0em;line-height:0.5em}.what-i-do-title{font-size:1.0em;line-height:0.5em;text-transform:uppercase;margin-bottom:2em}.theme-old .what-i-do-title{color:#443843}.theme-red .what-i-do-title{color:#443843}.theme-teal .what-i-do-title{color:#443843}.theme-green .what-i-do-title{color:#443843}.theme-penny .what-i-do-title{color:#443843}.what-i-do-big{font-size:2.5em;line-height:1em;font-weight:bold}.theme-old .what-i-do-big{color:#222}.theme-red .what-i-do-big{color:#222}.theme-teal .what-i-do-big{color:#222}.theme-green .what-i-do-big{color:#222}.theme-penny .what-i-do-big{color:#222}.job-title{font-size:2em;margin-bottom:0.2em}.theme-old .job-title{color:#222}.theme-red .job-title{color:#222}.theme-teal .job-title{color:#222}.theme-green .job-title{color:#222}.theme-penny .job-title{color:#222}.job-at{font-size:80%;font-weight:500}.theme-old .job-at{color:#999}.theme-red .job-at{color:#999}.theme-teal .job-at{color:#999}.theme-green .job-at{color:#999}.theme-penny .job-at{color:#999}.job-company{font-size:90%}.theme-old .job-company{color:#3d92c9}.theme-red .job-company{color:#c93d7a}.theme-teal .job-company{color:#c2363c}.theme-green .job-company{color:#3dc945}.theme-penny .job-company{color:#ec331a}.posts{display:flex;justify-content:center;flex-flow:column nowrap;max-width:1280px}.post{padding-bottom:2em}.post-header{display:flex;justify-content:space-between;align-items:center}.post-title{font-size:2em;margin-bottom:0.2em}.theme-old .post-title{color:#222}.theme-red .post-title{color:#222}.theme-teal .post-title{color:#222}.theme-green .post-title{color:#222}.theme-penny .post-title{color:#222}.theme-old .post-title a{color:#222;text-decoration-color:#222}.theme-red .post-title a{color:#222;text-decoration-color:#222}.theme-teal .post-title a{color:#222;text-decoration-color:#222}.theme-green .post-title a{color:#222;text-decoration-color:#222}.theme-penny .post-title a{color:#222;text-decoration-color:#222}.post-description{font-family:Georgia, "Cambria", serif;line-height:1.8em}.theme-old .post-description{color:#222}.theme-red .post-description{color:#222}.theme-teal .post-description{color:#222}.theme-green .post-description{color:#222}.theme-penny .post-description{color:#222}.post-meta{font-size:90%;margin:0}.theme-old .post-meta{color:#222}.theme-red .post-meta{color:#222}.theme-teal .post-meta{color:#222}.theme-green .post-meta{color:#222}.theme-penny .post-meta{color:#222}.post-date{text-align:right;white-space:nowrap}.theme-old .post-date{color:#222}.theme-red .post-date{color:#222}.theme-teal .post-date{color:#222}.theme-green .post-date{color:#222}.theme-penny .post-date{color:#222}.post-updated-date{font-size:90%;font-style:italic}.theme-old .post-updated-date{color:#5aba59}.theme-red .post-updated-date{color:#5aba59}.theme-teal .post-updated-date{color:#5aba59}.theme-green .post-updated-date{color:#5aba59}.theme-penny .post-updated-date{color:#5aba59}.post-category{margin:0 0.1em;padding:0.3em 1em;font-size:80%}.theme-old .post-category{color:#fff;background:#999}.theme-red .post-category{color:#fff;background:#999}.theme-teal .post-category{color:#fff;background:#999}.theme-green .post-category{color:#fff;background:#999}.theme-penny .post-category{color:#fff;background:#999}.theme-old .post-category-review{background:#61b360}.theme-red .post-category-review{background:#61b360}.theme-teal .post-category-review{background:#61b360}.theme-green .post-category-review{background:#61b360}.theme-penny .post-category-review{background:#61b360}.theme-old .post-category-privacy,.theme-old .post-category-security{background:#4d85d1}.theme-red .post-category-privacy,.theme-red .post-category-security{background:#4d85d1}.theme-teal .post-category-privacy,.theme-teal .post-category-security{background:#4d85d1}.theme-green .post-category-privacy,.theme-green .post-category-security{background:#4d85d1}.theme-penny .post-category-privacy,.theme-penny .post-category-security{background:#4d85d1}.theme-old .post-category-rant{background:#8156a7}.theme-red .post-category-rant{background:#8156a7}.theme-teal .post-category-rant{background:#8156a7}.theme-green .post-category-rant{background:#8156a7}.theme-penny .post-category-rant{background:#8156a7}.theme-old .post-category-tutorial{background:#bd4f64}.theme-red .post-category-tutorial{background:#bd4f64}.theme-teal .post-category-tutorial{background:#bd4f64}.theme-green .post-category-tutorial{background:#bd4f64}.theme-penny .post-category-tutorial{background:#bd4f64}.theme-old .post h1,.theme-old h2,.theme-old h3,.theme-old h4{color:#222}.theme-red .post h1,.theme-red h2,.theme-red h3,.theme-red h4{color:#222}.theme-teal .post h1,.theme-teal h2,.theme-teal h3,.theme-teal h4{color:#222}.theme-green .post h1,.theme-green h2,.theme-green h3,.theme-green h4{color:#222}.theme-penny .post h1,.theme-penny h2,.theme-penny h3,.theme-penny h4{color:#222}.post p,.post ol,.post ul{font-family:Georgia, "Cambria", serif}.theme-old .post p,.theme-old .post ol,.theme-old .post ul{color:#222}.theme-red .post p,.theme-red .post ol,.theme-red .post ul{color:#222}.theme-teal .post p,.theme-teal .post ol,.theme-teal .post ul{color:#222}.theme-green .post p,.theme-green .post ol,.theme-green .post ul{color:#222}.theme-penny .post p,.theme-penny .post ol,.theme-penny .post ul{color:#222}.post p a{font-weight:600}.skills{margin:0;padding:0 3em 0 0}.skill{display:flex;gap:1em;padding:1em 0;border-bottom:1px solid #ccc}.skill:last-child{border:none !important}.skill-name{font-size:0.8em;font-weight:bold;align-self:center}.theme-old .skill-name{color:#222}.theme-red .skill-name{color:#222}.theme-teal .skill-name{color:#222}.theme-green .skill-name{color:#222}.theme-penny .skill-name{color:#222}.main-blog-panel{display:flex;justify-content:center;margin-left:10em;margin-right:10em}.blog-header{display:flex;flex-flow:row nowrap;justify-content:space-between}.border-bottom{border-bottom:1px solid #eee}.related-list{list-style-type:none}.related-list li{padding-bottom:0.5em;border-bottom:1px solid #ccc}.related-list li:last-child{border:none}.related-post-title{font-size:1em;margin-bottom:0.2em}.theme-old .related-post-title{color:#222}.theme-red .related-post-title{color:#222}.theme-teal .related-post-title{color:#222}.theme-green .related-post-title{color:#222}.theme-penny .related-post-title{color:#222}.theme-old .related-post-title a{color:#222;text-decoration-color:#222}.theme-red .related-post-title a{color:#222;text-decoration-color:#222}.theme-teal .related-post-title a{color:#222;text-decoration-color:#222}.theme-green .related-post-title a{color:#222;text-decoration-color:#222}.theme-penny .related-post-title a{color:#222;text-decoration-color:#222}figure{text-align:center;margin:0 auto}figure img{border:1px solid rgba(50,50,50,0.5);border-radius:2px;padding:5px;background:#fff}.figure-2-3{width:66%}figcaption{padding:1em 1em 2em 1em;word-wrap:normal;text-align:center;display:inline-block !important;width:66%}code{overflow:auto}.icon-feed{background-position:0px 0px;width:24px;height:30px}.icon-j{background-position:-24px 0px;width:158px;height:155px}code:not([id='typeans']){padding-left:5px;padding-right:5px;border:1px solid;border-color:lightgrey;border-radius:5px}pre code{padding:5px}.highlight .lineno{color:#ccc;display:inline-block;padding:0 5px;border-right:1px solid #ccc}.highlight pre code{display:block;white-space:pre-wrap;overflow-x:auto;word-wrap:normal}.highlight .hll{background-color:#49483e}.highlight{background:#272822;color:#f8f8f2;border-radius:5px}.highlight .c{color:#75715e}.highlight .err{color:#960050;background-color:#1e0010}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .ch{color:#75715e}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .cpf{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .gd{color:#f92672}.highlight .ge{font-style:italic}.highlight .gi{color:#a6e22e}.highlight .gs{font-weight:bold}.highlight .gu{color:#75715e}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mb{color:#ae81ff}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sa{color:#e6db74}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .dl{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#a6e22e}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .vm{color:#f8f8f2}.highlight .il{color:#ae81ff}
</style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="/feed.xml"/></head><body class="theme-penny"><div class="header"><div class="header-inner"><div class="header-description"><h1 class="header-title">My name is <span class="header-name">Jeaye</span></h1><h2 class="header-short-pitch">I'm a leader, a problem solver, and a hacker with a passion for privacy and security.</h2></div><div class="header-icon"><div class="icon icon-j"></div></div></div><nav class="nav"><div class="nav-item"> <a href="https://jeaye.com/">About</a></div><div class="nav-item"> <a href="https://github.com/jeaye">Github</a></div><div class="nav-item"> <a href="/">Blog</a></div><div class="nav-item"> <a href="https://jeaye.com/contact">Contact</a></div><div class="nav-item special-nav-item"> <a href="https://jeaye.com/contact">Hire Me!</a></div> </nav></div><div class="main-blog-panel"><div class="posts"> <section class="post"> <header class="post-header"><h2 class="post-title"> <a href="/2017/05/31/clojure-spec/" title="/2017/05/31/clojure-spec/"> Dear Clojure devs, use clojure.spec please </a></h2><div class="post-date"> May 31, 2017</div> </header><p>Clojure 1.9 has introduced a novel library, <a href="https://clojure.org/about/spec">clojure.spec</a>, which allows developers to parse and validate data using a predicative API which is just composed of Clojure functions. If there’s one thing Clojure’s good at, though there’s not just one, it’s the <a href="https://en.wikipedia.org/wiki/Pure_function">pure</a> transformation of data. With spec, that grasp is broadened to allow for exceedingly expressive validation of data as well. What’s most important is that Clojure developers understand this new tool and use it to improve the safety and readability of their code.</p><h3 id="learning-clojurespec">Learning clojure.spec</h3><p>It’s been around long enough for there to be some great introductory material. There’s an official <a href="https://clojure.org/about/spec">Rationale and Overview</a>, thorough <a href="https://clojure.org/guides/spec">Spec Guide</a>, more illustrative <a href="https://lambdaisland.com/episodes/clojure-spec">Video Introduction</a>, etc. This post assumes a working understanding of spec, since its goal is to talk more about spec’s practical applications.</p><h3 id="why-spec">Why spec?</h3><p>Knowing how spec works and even how to use it is handy. Still, why bother spec’ing? If you look at the spec docs linked above, most reasons are for the aid in <a href="https://en.wikipedia.org/wiki/Software_testing">testing</a>, specifically with <a href="https://clojure.org/guides/spec#_generators">generative testing</a>. That’s great, if you like writing tests, or if your tests aren’t already written in something else. What if that’s not the case?</p><p><em>Please. Still use clojure.spec.</em></p><p>Here’s why.</p><h3 id="instrumentation">Instrumentation</h3><p>A hugely overlooked aspect of spec is its <a href="https://clojure.org/guides/spec#_instrumentation_and_testing">instrumentation</a>. In short, if you spec your functions and your data, you can ask Clojure to automatically check every single function call to make sure the arguments are correct. Not just during testing, but during development or even production. Furthermore, if you use <a href="https://github.com/jeaye/orchestra">Orchestra</a>, then Clojure can automatically check every function’s return value against its spec, among other things. Note, this includes ClojureScript!</p><p><em>This is superb.</em></p><p>Coming from C++, or Java, or C#, or so many other languages: have you been able to easily instrument every single function to validate it’s working properly? Not just with static types, which can be quite limiting, but with arbitrary predicates written in the same language you’re using? Unlikely.</p><p>Let’s look at some code.</p><h4 id="simple-math">Simple math</h4><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">my-inc</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">inc</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p>This is a simple function, so it’s easy to tell what <code class="highlighter-rouge">x</code> needs to be. In more complex functions, that’s not always the case. Now, what if we were to call this with something other than a number?</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">my-inc</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w"> </span><span class="c1">; =&gt; java.lang.NullPointerException</span><span class="w">
</span><span class="p">(</span><span class="nf">my-inc</span><span class="w"> </span><span class="s">"ok"</span><span class="p">)</span><span class="w"> </span><span class="c1">; =&gt; java.lang.ClassCastException</span><span class="w">
</span></code></pre></div></div><p>Those are pretty helpful. The exception will include a stack trace, so you can get the line number and find the right function. Let’s spec out that function and see what we’d get with instrumentation enabled.</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.spec.alpha</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">s</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">my-inc</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">inc</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="n">my-inc</span><span class="w">
      </span><span class="no">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="no">:x</span><span class="w"> </span><span class="n">number?</span><span class="p">)</span><span class="w">
      </span><span class="no">:ret</span><span class="w"> </span><span class="n">number?</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p>Just a single example should be descriptive enough, once we <a href="https://github.com/jeaye/orchestra#usage">enable Orchestra</a>.</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">my-inc</span><span class="w"> </span><span class="s">"ok"</span><span class="p">)</span><span class="w">
</span><span class="n">ExceptionInfo</span><span class="err">:</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">#</span><span class="ss">'user/my-inc</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="nb">not</span><span class="w"> </span><span class="n">conform</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">spec</span><span class="err">:</span><span class="w">
               </span><span class="n">In</span><span class="err">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">
               </span><span class="nb">val</span><span class="err">:</span><span class="w"> </span><span class="s">"ok"</span><span class="w">
               </span><span class="n">fails</span><span class="w"> </span><span class="n">at</span><span class="err">:</span><span class="w"> </span><span class="p">[</span><span class="no">:args</span><span class="w"> </span><span class="no">:x</span><span class="p">]</span><span class="w">
               </span><span class="n">predicate</span><span class="err">:</span><span class="w"> </span><span class="n">number?</span><span class="w">
               </span><span class="no">:clojure.spec.alpha/spec</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">...</span><span class="p">]</span><span class="w">
               </span><span class="no">:clojure.spec.alpha/value</span><span class="w"> </span><span class="p">(</span><span class="s">"ok"</span><span class="p">)</span><span class="w">
               </span><span class="no">:clojure.spec.alpha/args</span><span class="w"> </span><span class="p">(</span><span class="s">"ok"</span><span class="p">)</span><span class="w">
               </span><span class="no">:clojure.spec.alpha/failure</span><span class="w"> </span><span class="no">:instrument</span><span class="w">
               </span><span class="no">:orchestra.spec.test/caller</span><span class="w"> </span><span class="p">{</span><span class="no">:file</span><span class="w"> </span><span class="s">"form-..."</span><span class="n">,</span><span class="w">
                                            </span><span class="no">:line</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w">
                                            </span><span class="no">:var-scope</span><span class="w"> </span><span class="n">user/eval42203</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>That’s gorgeous. Before we get into the function, we’re stopped with some very detailed information that <code class="highlighter-rouge">[:args :x]</code> (the argument called <code class="highlighter-rouge">x</code>) was supposed to match <code class="highlighter-rouge">number?</code>, but it has the value of <code class="highlighter-rouge">"ok"</code>. We also get to see all the other args to the function, line/file info, etc. Compared to typical statically-typed languages, and the typical Clojure exceptions, which say “expected number, got string,” we’re now dealing with values, not just types. In this way, spec behaves more like a <a href="https://en.wikipedia.org/wiki/Dependent_type">dependent type system</a>.</p><p>The most important aspect has yet to be mentioned: if a Clojure library provides these specs for its functions and data, any consumers using Orchestra and spec will immediately be able to benefit from automatic instrumentation. Each spec is also a form of documentation which must be up-to-date with the code (or instrumentation would fail!).</p><h4 id="more-complex-map-extraction">More complex map extraction</h4><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">; This behaves similarly to clojure.core/select-keys</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">extract</span><span class="w">
  </span><span class="s">"Given a map and some keys, return a map with only those keys"</span><span class="w">
  </span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="n">ks</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">acc</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w">
            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">v</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">)]</span><span class="w">
              </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">some?</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
                </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
                </span><span class="n">acc</span><span class="p">)))</span><span class="w">
          </span><span class="p">{}</span><span class="w">
          </span><span class="n">ks</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">s/fdef</span><span class="w"> </span><span class="n">extract</span><span class="w">
        </span><span class="no">:args</span><span class="w"> </span><span class="p">(</span><span class="nf">s/cat</span><span class="w"> </span><span class="no">:m</span><span class="w"> </span><span class="nb">map?</span><span class="w">
                     </span><span class="no">:ks</span><span class="w"> </span><span class="p">(</span><span class="nf">s/coll-of</span><span class="w"> </span><span class="n">any?</span><span class="p">))</span><span class="w">
        </span><span class="no">:fn</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">ctx</span><span class="p">]</span><span class="w">
              </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="o">#</span><span class="p">{}</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="no">:ks</span><span class="p">))</span><span class="w">
                 </span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="o">#</span><span class="p">{}</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="no">:ret</span><span class="w"> </span><span class="nb">keys</span><span class="p">))))</span><span class="w">
        </span><span class="no">:ret</span><span class="w"> </span><span class="nb">map?</span><span class="p">)</span><span class="w">
</span></code></pre></div></div><p>In this example, we can use Orchestra to take advantage of spec’s <code class="highlighter-rouge">:fn</code> spec. These are executed at the end of a function call, and they’re given both the arguments and the return value. In this case, we can verify that the keys of the output map are exactly the keys meant to be extracted. Note, this expects that all keys were present, but that’s the sort of control which you can embed and automatically run on each function call.</p><p>If we intentionally add a bug, where we use <code class="highlighter-rouge">if-let</code> instead of <code class="highlighter-rouge">if-some</code> or <code class="highlighter-rouge">some?</code>, this function won’t work well with <code class="highlighter-rouge">false</code>.</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">extract</span><span class="w">
  </span><span class="s">"Given a map and some keys, return a map with only those keys"</span><span class="w">
  </span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="n">ks</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">acc</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w">
            </span><span class="p">(</span><span class="nb">if-let</span><span class="w"> </span><span class="p">[</span><span class="n">v</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">k</span><span class="p">)]</span><span class="w">
              </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
              </span><span class="n">acc</span><span class="p">))</span><span class="w">
          </span><span class="p">{}</span><span class="w">
          </span><span class="n">ks</span><span class="p">))</span><span class="w">
</span></code></pre></div></div><p>With instrumentation enabled, here’s what we might see. Since it’s the <code class="highlighter-rouge">:fn</code> spec which fails, the error will give us all of the argument values, as well as the return value. It gives use the predicate which failed and dropping them all in the REPL would allow us to figure out exactly why.</p><div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">extract</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="no">:bar</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="no">:spam</span><span class="w"> </span><span class="s">"meow"</span><span class="p">}</span><span class="w"> </span><span class="p">[</span><span class="no">:bar</span><span class="p">])</span><span class="w">

</span><span class="n">ExceptionInfo</span><span class="err">:</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">#</span><span class="ss">'user/extract</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="nb">not</span><span class="w"> </span><span class="n">conform</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">spec</span><span class="err">:</span><span class="w">
               </span><span class="nb">val</span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="no">:ret</span><span class="w"> </span><span class="p">{}</span><span class="n">,</span><span class="w">
                     </span><span class="no">:args</span><span class="w"> </span><span class="p">{</span><span class="no">:m</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:bar</span><span class="w"> </span><span class="n">false,</span><span class="w"> </span><span class="no">:spam</span><span class="w"> </span><span class="s">"meow"</span><span class="p">}</span><span class="n">,</span><span class="w">
                            </span><span class="no">:ks</span><span class="w"> </span><span class="p">[</span><span class="no">:bar</span><span class="p">]}}</span><span class="w">
               </span><span class="n">fails</span><span class="w"> </span><span class="n">at</span><span class="err">:</span><span class="w"> </span><span class="p">[</span><span class="no">:fn</span><span class="p">]</span><span class="w">
               </span><span class="n">predicate</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">ctx</span><span class="p">]</span><span class="w">
                            </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="o">#</span><span class="p">{}</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="no">:ks</span><span class="p">))</span><span class="w">
                               </span><span class="p">(</span><span class="nb">into</span><span class="w"> </span><span class="o">#</span><span class="p">{}</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="no">:ret</span><span class="w"> </span><span class="nb">keys</span><span class="p">))))</span><span class="w">
               </span><span class="no">:clojure.spec.alpha/spec</span><span class="w">  </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">...</span><span class="p">]</span><span class="w">
               </span><span class="no">:clojure.spec.alpha/value</span><span class="w"> </span><span class="p">{</span><span class="no">:ret</span><span class="w"> </span><span class="p">{}</span><span class="n">,</span><span class="w">
                                          </span><span class="no">:args</span><span class="w"> </span><span class="p">{</span><span class="no">:m</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:bar</span><span class="w"> </span><span class="n">false,</span><span class="w"> </span><span class="no">:spam</span><span class="w"> </span><span class="s">"meow"</span><span class="p">}</span><span class="n">,</span><span class="w">
                                                 </span><span class="no">:ks</span><span class="w"> </span><span class="p">[</span><span class="no">:bar</span><span class="p">]}}</span><span class="w">
               </span><span class="no">:clojure.spec.alpha/fn</span><span class="w"> </span><span class="p">{</span><span class="no">:ret</span><span class="w"> </span><span class="p">{}</span><span class="n">,</span><span class="w">
                                       </span><span class="no">:args</span><span class="w"> </span><span class="p">{</span><span class="no">:m</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:bar</span><span class="w"> </span><span class="n">false,</span><span class="w"> </span><span class="no">:spam</span><span class="w"> </span><span class="s">"meow"</span><span class="p">}</span><span class="n">,</span><span class="w">
                                              </span><span class="no">:ks</span><span class="w"> </span><span class="p">[</span><span class="no">:bar</span><span class="p">]}}</span><span class="w">
               </span><span class="no">:clojure.spec.alpha/failure</span><span class="w"> </span><span class="no">:instrument</span><span class="w">
               </span><span class="no">:orchestra.spec.test/caller</span><span class="w"> </span><span class="p">{</span><span class="no">:file</span><span class="w"> </span><span class="s">"form-..."</span><span class="n">,</span><span class="w">
                                            </span><span class="no">:line</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w">
                                            </span><span class="no">:var-scope</span><span class="w"> </span><span class="n">user/eval53563</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><h3 id="a-real-world-example">A real-world example</h3><p>Just recently, I opened a <a href="https://github.com/reagent-project/reagent/pull/301">pull request to Reagent</a>, which is an excellent project, in hopes of improving its input validation and error messages. Rather than using spec, it’s performing manual asserts on input data and then providing adhoc error messages on failed validation. My PR keeps the asserts, but refactors them to common helpers and improves the messages (introducing new deps isn’t typically the right first step in improving a library as an outsider). Still, we can do so much better than that. These can be checked for us and we can describe the shape of the data as it should be when it flows through our Clojure machines.</p><h3 id="performance-implications">Performance implications</h3><p>Automatically instrumenting every single function call, checking all the arguments, return values, and possibly <code class="highlighter-rouge">:fn</code> specs sounds pretty slow, right? You may be surprised. For development, I’ve seen absolutely no notable performance issues running Orchestra and instrumenting just about every function in a back-end deployment of Ring + Compojure + PostgreSQL. Your mileage may vary, but this is something you should try first, get as much out of it as you can, and only put down if you absolutely must.</p><p>For the safety of your programs and the programs of everyone using your libraries, Clojure devs, please spec out your functions and your data. If you want help writing your specs, heck, email me and let’s get it done. Clojure devs deserve the huge win of automatic instrumentation.</p></section><hr/><div><div class="border-bottom"><h1 class="panel-subhead">Related posts</h1><ul class="related-list"><li><h2 class="related-post-title"> <a href="/2017/12/16/firefox/">Don't abandon Mozilla Firefox just yet</a> <span class="post-category post-category-rant">rant</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/10/31/clojure-keywords/">The five common forms of Clojure keywords</a> <span class="post-category post-category-clojure">clojure</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/09/30/clojurescript-promesa/">Async/await in ClojureScript with Promesa</a> <span class="post-category post-category-clojure">clojure</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/08/31/clojure-code-quality/">The state of code quality tools in Clojure</a> <span class="post-category post-category-clojure">clojure</span> <span class="post-category post-category-safety">safety</span></h2></li></ul></div></div></div></div></div> <footer> </footer></body></html>