<!DOCTYPE html><html><head><meta charset="utf-8"/><link rel="icon" type="image/png" href="https://blog.jeaye.com//assets/favicon-c551898801df70b89095c40cbb11f01ff876ecf59bfa153122137abe9459c576.png"><title>Common Lisp, Parenscript, and AJAX</title><meta name="author" content="jeaye"/><meta name="keywords" content="jeaye,jesse,wilkerson,c++,modern,engineering,manager,software,functional,clojure,programming,lisp, parenscript, ajax, tutorial"/><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="I'm a leader, a problem solver, and a hacker with a passion for privacy and security."><style>.icon{background-image:url("/assets/sprite-sheet-f829f47fe9f6353c7c632fee71002c94a29b8341725e19843f2c1b263869e4f2.png") !important}</style><style rel="stylesheet" type="text/css" integrity="sha256-FAEL2/AHw4sy6PSxUkN0Zt4TaPhbApIPciXM8UG6d7c=" crossorigin="anonymous">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{display:flex;flex-flow:column nowrap;margin:0;font-family:sans-serif}a{text-decoration:none}.theme-old a{color:#3d92c9}.theme-red a{color:#c93d7a}.theme-teal a{color:#c2363c}.theme-green a{color:#3dc945}.theme-penny a{color:#ec331a}a:hover,a:focus{text-decoration:underline}.theme-old .gentle-body-color{color:#222}.theme-red .gentle-body-color{color:#222}.theme-teal .gentle-body-color{color:#222}.theme-green .gentle-body-color{color:#222}.theme-penny .gentle-body-color{color:#222}.header{display:flex;flex-flow:column wrap;align-items:center;margin:0;padding:2em 40px 2em 40px;text-align:center}.theme-old .header{background:#3d4f5d;color:#999}.theme-red .header{background:#5d3d4a;color:#999}.theme-teal .header{background:#3d5d5d;color:#999}.theme-green .header{background:#3d5d40;color:#999}.theme-penny .header{background:#812d39;color:#999}.header-inner{display:flex;flex-flow:row wrap}.header-description{flex:2;text-align:left;max-width:700px}.header-icon{display:flex;flex:1;justify-content:flex-end}.header-title,.header-short-pitch{margin:0}.header-short-pitch{font-weight:300}.theme-old .header-short-pitch{color:#b0cadb}.theme-red .header-short-pitch{color:#dbb0c3}.theme-teal .header-short-pitch{color:#b0dbd9}.theme-green .header-short-pitch{color:#b0dbb3}.theme-penny .header-short-pitch{color:#ffbbcb}.header-name{font-size:2.5em}.theme-old .header-name{color:#222}.theme-red .header-name{color:#222}.theme-teal .header-name{color:#222}.theme-green .header-name{color:#222}.theme-penny .header-name{color:#222}.nav{display:flex;flex-flow:row wrap;gap:0.5em;padding-top:0.5em}.nav-item{display:flex;flex:1;white-space:nowrap}.nav-item a{background:transparent;margin-top:1em;padding:6px 14px;letter-spacing:0.05em;font-size:85%}.theme-old .nav-item a{color:#fff;border:2px solid #b0cadb}.theme-red .nav-item a{color:#fff;border:2px solid #dbb0c3}.theme-teal .nav-item a{color:#fff;border:2px solid #b0dbd9}.theme-green .nav-item a{color:#fff;border:2px solid #b0dbb3}.theme-penny .nav-item a{color:#fff;border:2px solid #ffbbcb}.nav-item a:hover,.nav-item a:focus{text-decoration:none}.theme-old .nav-item a:hover,.theme-old .nav-item a:focus{border:2px solid #3d92c9}.theme-red .nav-item a:hover,.theme-red .nav-item a:focus{border:2px solid #c93d7a}.theme-teal .nav-item a:hover,.theme-teal .nav-item a:focus{border:2px solid #3dc9c3}.theme-green .nav-item a:hover,.theme-green .nav-item a:focus{border:2px solid #3dc945}.theme-penny .nav-item a:hover,.theme-penny .nav-item a:focus{border:2px solid #ff1345}.theme-old .special-nav-item a{border:2px solid #c2a086}.theme-red .special-nav-item a{border:2px solid #86c2aa}.theme-teal .special-nav-item a{border:2px solid #c28686}.theme-green .special-nav-item a{border:2px solid #c286bc}.theme-penny .special-nav-item a{border:2px solid #87e200}.theme-old .special-nav-item a:hover,.theme-old .special-nav-item a:focus{border:2px solid #c26d36}.theme-red .special-nav-item a:hover,.theme-red .special-nav-item a:focus{border:2px solid #36c285}.theme-teal .special-nav-item a:hover,.theme-teal .special-nav-item a:focus{border:2px solid #c2363c}.theme-green .special-nav-item a:hover,.theme-green .special-nav-item a:focus{border:2px solid #c236ba}.theme-penny .special-nav-item a:hover,.theme-penny .special-nav-item a:focus{border:2px solid #78af26}.panel-h-box{display:flex;flex:1;flex-flow:row wrap;gap:10em;justify-content:center;margin:0 3em 0 3em}.panel-v-box{display:flex;flex-flow:column wrap}.panel-gap{min-width:10em}.panel-subhead{text-transform:uppercase;padding:0;font-size:80%;font-weight:500;letter-spacing:0.1em}.theme-old .panel-subhead{color:#999}.theme-red .panel-subhead{color:#999}.theme-teal .panel-subhead{color:#999}.theme-green .panel-subhead{color:#999}.theme-penny .panel-subhead{color:#999}.main-panel,.toolbox-panel,.pgp-panel,.what-i-do-panel,.main-blog-panel{margin-top:2em}.main-panel{display:flex;flex:2;max-width:1280px;min-width:400px}.toolbox-panel{display:flex;flex:1;flex-flow:column nowrap;max-width:450px;min-width:200px}.what-i-do-panel{display:flex;flex:2;flex-flow:column nowrap;min-width:400px;max-width:900px}.what-i-do-h-box{display:flex;flex-flow:row nowrap;gap:4em;margin-top:1em}.what-i-do-thing{flex:1}.what-i-do-thing-title{font-size:1.0em;line-height:0.5em}.what-i-do-title{font-size:1.0em;line-height:0.5em;text-transform:uppercase;margin-bottom:2em}.theme-old .what-i-do-title{color:#443843}.theme-red .what-i-do-title{color:#443843}.theme-teal .what-i-do-title{color:#443843}.theme-green .what-i-do-title{color:#443843}.theme-penny .what-i-do-title{color:#443843}.what-i-do-big{font-size:2.5em;line-height:1em;font-weight:bold}.theme-old .what-i-do-big{color:#222}.theme-red .what-i-do-big{color:#222}.theme-teal .what-i-do-big{color:#222}.theme-green .what-i-do-big{color:#222}.theme-penny .what-i-do-big{color:#222}.job-title{font-size:2em;margin-bottom:0.2em}.theme-old .job-title{color:#222}.theme-red .job-title{color:#222}.theme-teal .job-title{color:#222}.theme-green .job-title{color:#222}.theme-penny .job-title{color:#222}.job-at{font-size:80%;font-weight:500}.theme-old .job-at{color:#999}.theme-red .job-at{color:#999}.theme-teal .job-at{color:#999}.theme-green .job-at{color:#999}.theme-penny .job-at{color:#999}.job-company{font-size:90%}.theme-old .job-company{color:#3d92c9}.theme-red .job-company{color:#c93d7a}.theme-teal .job-company{color:#c2363c}.theme-green .job-company{color:#3dc945}.theme-penny .job-company{color:#ec331a}.posts{display:flex;justify-content:center;flex-flow:column nowrap;max-width:1280px}.post{padding-bottom:2em}.post-header{display:flex;justify-content:space-between;align-items:center}.post-title{font-size:2em;margin-bottom:0.2em}.theme-old .post-title{color:#222}.theme-red .post-title{color:#222}.theme-teal .post-title{color:#222}.theme-green .post-title{color:#222}.theme-penny .post-title{color:#222}.theme-old .post-title a{color:#222;text-decoration-color:#222}.theme-red .post-title a{color:#222;text-decoration-color:#222}.theme-teal .post-title a{color:#222;text-decoration-color:#222}.theme-green .post-title a{color:#222;text-decoration-color:#222}.theme-penny .post-title a{color:#222;text-decoration-color:#222}.post-description{font-family:Georgia, "Cambria", serif;line-height:1.8em}.theme-old .post-description{color:#222}.theme-red .post-description{color:#222}.theme-teal .post-description{color:#222}.theme-green .post-description{color:#222}.theme-penny .post-description{color:#222}.post-meta{font-size:90%;margin:0}.theme-old .post-meta{color:#222}.theme-red .post-meta{color:#222}.theme-teal .post-meta{color:#222}.theme-green .post-meta{color:#222}.theme-penny .post-meta{color:#222}.post-date{text-align:right;white-space:nowrap}.theme-old .post-date{color:#222}.theme-red .post-date{color:#222}.theme-teal .post-date{color:#222}.theme-green .post-date{color:#222}.theme-penny .post-date{color:#222}.post-updated-date{font-size:90%;font-style:italic}.theme-old .post-updated-date{color:#5aba59}.theme-red .post-updated-date{color:#5aba59}.theme-teal .post-updated-date{color:#5aba59}.theme-green .post-updated-date{color:#5aba59}.theme-penny .post-updated-date{color:#5aba59}.post-category{margin:0 0.1em;padding:0.3em 1em;font-size:80%}.theme-old .post-category{color:#fff;background:#999}.theme-red .post-category{color:#fff;background:#999}.theme-teal .post-category{color:#fff;background:#999}.theme-green .post-category{color:#fff;background:#999}.theme-penny .post-category{color:#fff;background:#999}.theme-old .post-category-review{background:#61b360}.theme-red .post-category-review{background:#61b360}.theme-teal .post-category-review{background:#61b360}.theme-green .post-category-review{background:#61b360}.theme-penny .post-category-review{background:#61b360}.theme-old .post-category-privacy,.theme-old .post-category-security{background:#4d85d1}.theme-red .post-category-privacy,.theme-red .post-category-security{background:#4d85d1}.theme-teal .post-category-privacy,.theme-teal .post-category-security{background:#4d85d1}.theme-green .post-category-privacy,.theme-green .post-category-security{background:#4d85d1}.theme-penny .post-category-privacy,.theme-penny .post-category-security{background:#4d85d1}.theme-old .post-category-rant{background:#8156a7}.theme-red .post-category-rant{background:#8156a7}.theme-teal .post-category-rant{background:#8156a7}.theme-green .post-category-rant{background:#8156a7}.theme-penny .post-category-rant{background:#8156a7}.theme-old .post-category-tutorial{background:#bd4f64}.theme-red .post-category-tutorial{background:#bd4f64}.theme-teal .post-category-tutorial{background:#bd4f64}.theme-green .post-category-tutorial{background:#bd4f64}.theme-penny .post-category-tutorial{background:#bd4f64}.theme-old .post h1,.theme-old h2,.theme-old h3,.theme-old h4{color:#222}.theme-red .post h1,.theme-red h2,.theme-red h3,.theme-red h4{color:#222}.theme-teal .post h1,.theme-teal h2,.theme-teal h3,.theme-teal h4{color:#222}.theme-green .post h1,.theme-green h2,.theme-green h3,.theme-green h4{color:#222}.theme-penny .post h1,.theme-penny h2,.theme-penny h3,.theme-penny h4{color:#222}.post p,.post ol,.post ul{font-family:Georgia, "Cambria", serif}.theme-old .post p,.theme-old .post ol,.theme-old .post ul{color:#222}.theme-red .post p,.theme-red .post ol,.theme-red .post ul{color:#222}.theme-teal .post p,.theme-teal .post ol,.theme-teal .post ul{color:#222}.theme-green .post p,.theme-green .post ol,.theme-green .post ul{color:#222}.theme-penny .post p,.theme-penny .post ol,.theme-penny .post ul{color:#222}.post p a{font-weight:600}.skills{margin:0;padding:0 3em 0 0}.skill{display:flex;gap:1em;padding:1em 0;border-bottom:1px solid #ccc}.skill:last-child{border:none !important}.skill-name{font-size:0.8em;font-weight:bold;align-self:center}.theme-old .skill-name{color:#222}.theme-red .skill-name{color:#222}.theme-teal .skill-name{color:#222}.theme-green .skill-name{color:#222}.theme-penny .skill-name{color:#222}.main-blog-panel{display:flex;justify-content:center;margin-left:10em;margin-right:10em}.blog-header{display:flex;flex-flow:row nowrap;justify-content:space-between}.border-bottom{border-bottom:1px solid #eee}.related-list{list-style-type:none}.related-list li{padding-bottom:0.5em;border-bottom:1px solid #ccc}.related-list li:last-child{border:none}.related-post-title{font-size:1em;margin-bottom:0.2em}.theme-old .related-post-title{color:#222}.theme-red .related-post-title{color:#222}.theme-teal .related-post-title{color:#222}.theme-green .related-post-title{color:#222}.theme-penny .related-post-title{color:#222}.theme-old .related-post-title a{color:#222;text-decoration-color:#222}.theme-red .related-post-title a{color:#222;text-decoration-color:#222}.theme-teal .related-post-title a{color:#222;text-decoration-color:#222}.theme-green .related-post-title a{color:#222;text-decoration-color:#222}.theme-penny .related-post-title a{color:#222;text-decoration-color:#222}figure{text-align:center;margin:0 auto}figure img{border:1px solid rgba(50,50,50,0.5);border-radius:2px;padding:5px;background:#fff}.figure-2-3{width:66%}figcaption{padding:1em 1em 2em 1em;word-wrap:normal;text-align:center;display:inline-block !important;width:66%}code{overflow:auto}.icon-feed{background-position:0px 0px;width:24px;height:30px}.icon-j{background-position:-24px 0px;width:158px;height:155px}code:not([id='typeans']){padding-left:5px;padding-right:5px;border:1px solid;border-color:lightgrey;border-radius:5px}pre code{padding:5px}.highlight .lineno{color:#ccc;display:inline-block;padding:0 5px;border-right:1px solid #ccc}.highlight pre code{display:block;white-space:pre-wrap;overflow-x:auto;word-wrap:normal}.highlight .hll{background-color:#49483e}.highlight{background:#272822;color:#f8f8f2;border-radius:5px}.highlight .c{color:#75715e}.highlight .err{color:#960050;background-color:#1e0010}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .ch{color:#75715e}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .cpf{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .gd{color:#f92672}.highlight .ge{font-style:italic}.highlight .gi{color:#a6e22e}.highlight .gs{font-weight:bold}.highlight .gu{color:#75715e}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mb{color:#ae81ff}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sa{color:#e6db74}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .dl{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#a6e22e}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .vm{color:#f8f8f2}.highlight .il{color:#ae81ff}
</style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="/feed.xml"/></head><body class="theme-penny"><div class="header"><div class="header-inner"><div class="header-description"><h1 class="header-title">My name is <span class="header-name">Jeaye</span></h1><h2 class="header-short-pitch">I'm a leader, a problem solver, and a hacker with a passion for privacy and security.</h2></div><div class="header-icon"><div class="icon icon-j"></div></div></div><nav class="nav"><div class="nav-item"> <a href="https://jeaye.com/">About</a></div><div class="nav-item"> <a href="https://github.com/jeaye">Github</a></div><div class="nav-item"> <a href="/">Blog</a></div><div class="nav-item"> <a href="https://jeaye.com/contact">Contact</a></div><div class="nav-item special-nav-item"> <a href="https://jeaye.com/contact">Hire Me!</a></div> </nav></div><div class="main-blog-panel"><div class="posts"> <section class="post"> <header class="post-header"><h2 class="post-title"> <a href="/2015/09/27/parenscript-ajax/" title="/2015/09/27/parenscript-ajax/"> Common Lisp, Parenscript, and AJAX </a></h2><div class="post-date"> September 27, 2015</div> </header><p>When looking to make full-stack web applications in lisp, Common Lisp and Parenscript are just as capable as Clojure and Clojurescript, if only less documented. As I wanted to make a web-based REPL for <a href="https://github.com/jeaye/jank">jank</a>, my statically-typed functional programming language, I evaluated both the Clojure and Common Lisp stacks and, ultimately, decided on Common Lisp.</p><p>The goal of this post is not to compare the Common Lisp and Clojure stacks, but is, instead, to offer an updated introduction to actually getting the Common Lisp stack running. Unfortunately, <em>every single</em> example and tutorial I’ve found on the topic has <em>something</em> incorrect. The minimal scope of this post, hopefully, will maximize its portability and longevity.</p><p><strong>UPDATE 2017-01-15:</strong> At this point, I wouldn’t recommend Common Lisp for web applications. In the past couple of years, I’ve spent a great deal of time with Clojure; its functional-first approach to programming, persistent, immutable data structures, and code-as-data macros have proven, in several projects, to be not only practical, but immensely enjoyable.</p><h3 id="dependencies">Dependencies</h3><p>To begin with, we’ll sort out our dependencies. This was tested using SBCL 1.2.15.79-c2708da on Slackware 14.1 x86_64, but it should have no issues elsewhere.</p><ol><li><a href="https://common-lisp.net/project/parenscript/">parenscript</a> (a set of macros for turning Common Lisp into Javascript)</li><li><a href="http://weitz.de/hunchentoot/">hunchentoot</a> (a pure Common Lisp web server)</li><li><a href="http://weitz.de/cl-who/">cl-who</a> (a DSL for building HTML, compatible with Parenscript)</li><li><a href="https://github.com/aarvid/SmackJack">smackjack</a> (an AJAX library we’ll use from Parenscript)</li></ol><p>We’ll just use <a href="https://www.quicklisp.org/beta/">quicklisp</a> to install these for us.</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">ql:quickload</span> <span class="o">'</span><span class="p">(</span><span class="ss">:hunchentoot</span> <span class="ss">:cl-who</span> <span class="ss">:parenscript</span> <span class="ss">:smackjack</span><span class="p">))</span>
</code></pre></div></div><h3 id="package">Package</h3><p>After that, we’ll define a package for our application. In my case, it’s <code class="highlighter-rouge">:jank-repl</code>.</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:jank-repl</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span> <span class="ss">:hunchentoot</span> <span class="ss">:cl-who</span> <span class="ss">:parenscript</span> <span class="ss">:smackjack</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:jank-repl</span><span class="p">)</span>
</code></pre></div></div><h3 id="starting-the-server">Starting the server</h3><p>At this point, we can tell Hunchentoot to start up. It won’t do much, but it’ll allow us to verify everything is good so far.</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*server*</span>
  <span class="p">(</span><span class="nv">start</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">'easy-acceptor</span> <span class="ss">:address</span> <span class="s">"localhost"</span> <span class="ss">:port</span> <span class="mi">8080</span><span class="p">)))</span>
</code></pre></div></div><p>We specify the <code class="highlighter-rouge">'easy-acceptor</code> so that Hunchentoot will detect our custom routes later on, automatically. Different acceptors can be added to a global <code class="highlighter-rouge">*dispatch-table*</code>, which we’ll see later.</p><p><strong>NOTE:</strong> Many Hunchentoot examples and tutorials will use <code class="highlighter-rouge">'acceptor</code> instead of <code class="highlighter-rouge">'easy-acceptor</code>. Do <em>not</em> do this unless you know what you’re doing. Nothing will work.</p><p>Now we can try connecting to the server, either through our browser, or simply via curl.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="s2">"http://localhost:8080/"</span>
</code></pre></div></div><p>If all is working well, you should get a simple page back saying something like “Welcome to Hunchentoot!” We can now start adding some custom pages.</p><h3 id="adding-custom-pages">Adding custom pages</h3><p>Before we jump into using cl-who with Hunchentoot, we need to tell Parenscript how to escape its strings when embedded in cl-who.</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">; Allow cl-who and Parenscript to work together</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*js-string-delimiter*</span> <span class="sc">#\"</span><span class="p">)</span>
</code></pre></div></div><p>Now we can define a custom route using Hunchentoot’s <code class="highlighter-rouge">define-easy-handler</code> macro.</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">define-easy-handler</span> <span class="p">(</span><span class="nv">repl</span> <span class="ss">:uri</span> <span class="s">"/repl"</span><span class="p">)</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">with-html-output-to-string</span> <span class="p">(</span><span class="nv">s</span><span class="p">)</span>
    <span class="p">(</span><span class="ss">:html</span>
      <span class="p">(</span><span class="ss">:body</span>
        <span class="p">(</span><span class="ss">:h2</span> <span class="s">"Jank REPL"</span><span class="p">)))))</span>
</code></pre></div></div><p>This macro will setup routing for us, requiring no extra Hunchentoot code. As you can see, we use cl-who here to build HTML into a string. The return value of this handler is the html (or other content, if desired) of the webpage.</p><p>After restarting the server, we can now test out this new page.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="s2">"http://localhost:8080/repl"</span>
</code></pre></div></div><h3 id="setting-up-a-remote-api">Setting up a remote API</h3><p>To have our server start responding to queries, we’ll begin integrating SmackJack into our source. To start, we need an AJAX processor operating at a specific URI.</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*ajax-processor*</span>
  <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">'ajax-processor</span> <span class="ss">:server-uri</span> <span class="s">"/repl-api"</span><span class="p">))</span>
</code></pre></div></div><p>After that, we can register remote functions with it using SmackJack’s <code class="highlighter-rouge">defun-ajax</code> macro. We’ll start with a simple echo function. The <code class="highlighter-rouge">:callback-data</code> can be various types, from text to JSON, to XML. For now, we’ll just echo text.</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">defun-ajax</span> <span class="nv">echo</span> <span class="p">(</span><span class="nv">data</span><span class="p">)</span> <span class="p">(</span><span class="vg">*ajax-processor*</span> <span class="ss">:callback-data</span> <span class="ss">:response-text</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">'string</span> <span class="s">"echo: "</span> <span class="nv">data</span><span class="p">))</span>
</code></pre></div></div><p>The last thing we need to do, in order for us to access our remote functions through Hunchentoot, is integrate the AJAX handler with Hunchentoot’s dispatch table.</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">setq</span> <span class="vg">*dispatch-table*</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">'dispatch-easy-handlers</span>
                             <span class="p">(</span><span class="nv">create-ajax-dispatcher</span> <span class="vg">*ajax-processor*</span><span class="p">)))</span>
</code></pre></div></div><p>Now we can test the server!</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="s1">'http://localhost:8080/repl-api/ECHO?data="testing!"'</span>
</code></pre></div></div><p><strong>NOTE:</strong> The capitalization of <code class="highlighter-rouge">ECHO</code> here and the quoting of the <code class="highlighter-rouge">data</code> value is very deliberate. This is also something that many examples/tutorials will get wrong.</p><h3 id="calling-from-parenscript">Calling from Parenscript</h3><p>Finally, we need to call our server from the client. We’ll spice up our REPL page to have some Parenscript and we’ll use the echo server with SmackJack to reply to the client.</p><p>In order to access our AJAX functions from Parenscript, we need to bring in SmackJack’s prologue, which is just a generated dump of JavaScript wrappers. Aside from that, we’ll need to define a two Parenscript functions.</p><ol><li>Something to call when an event on the page happens; it calls into SmackJack</li><li>A callback for when we hear back from the server</li></ol><p>Let’s see how that looks, replacing our old call to <code class="highlighter-rouge">define-easy-handler</code>:</p><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">define-easy-handler</span> <span class="p">(</span><span class="nv">repl</span> <span class="ss">:uri</span> <span class="s">"/repl"</span><span class="p">)</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">with-html-output-to-string</span> <span class="p">(</span><span class="nv">s</span><span class="p">)</span>
    <span class="p">(</span><span class="ss">:html</span>
      <span class="p">(</span><span class="ss">:head</span>
        <span class="p">(</span><span class="ss">:title</span> <span class="s">"Jank REPL"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">str</span> <span class="p">(</span><span class="nv">generate-prologue</span> <span class="vg">*ajax-processor*</span><span class="p">))</span>
        <span class="p">(</span><span class="ss">:script</span> <span class="ss">:type</span> <span class="s">"text/javascript"</span>
          <span class="p">(</span><span class="nv">str</span>
            <span class="p">(</span><span class="nv">ps</span>
              <span class="p">(</span><span class="nb">defun</span> <span class="nv">callback</span> <span class="p">(</span><span class="nv">response</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">alert</span> <span class="nv">response</span><span class="p">))</span>
              <span class="p">(</span><span class="nb">defun</span> <span class="nv">on-click</span> <span class="p">()</span>
                <span class="p">(</span><span class="nv">chain</span> <span class="nv">smackjack</span> <span class="p">(</span><span class="nv">echo</span> <span class="p">(</span><span class="nv">chain</span> <span class="nv">document</span>
                                              <span class="p">(</span><span class="nv">get-element-by-id</span> <span class="s">"data"</span><span class="p">)</span>
                                              <span class="nv">value</span><span class="p">)</span>
                                       <span class="nv">callback</span><span class="p">)))))))</span>
      <span class="p">(</span><span class="ss">:body</span>
        <span class="p">(</span><span class="ss">:p</span>
          <span class="p">(</span><span class="ss">:input</span> <span class="ss">:id</span> <span class="s">"data"</span> <span class="ss">:type</span> <span class="s">"text"</span><span class="p">))</span>
        <span class="p">(</span><span class="ss">:p</span>
          <span class="p">(</span><span class="ss">:button</span> <span class="ss">:type</span> <span class="s">"button"</span>
                   <span class="ss">:onclick</span> <span class="p">(</span><span class="nv">ps-inline</span> <span class="p">(</span><span class="nv">on-click</span><span class="p">))</span>
                   <span class="s">"Submit!"</span><span class="p">))))))</span>
</code></pre></div></div><p>This is quite a bit larger than our previous <code class="highlighter-rouge">/repl</code> Hunchentoot handler, but the pieces are quite simple. First, we see we’re generating SmackJack’s prologue. We need to use cl-who’s <code class="highlighter-rouge">str</code> function to marshal Common Lisp strings into the HTML generation. Aside from that, we’re defining a script tag with some Parenscript, denoted by <code class="highlighter-rouge">ps</code>.</p><p>As mentioned before, we have two Parenscript functions. One handles the initial event and the other handles the callback from the server. I’ll point out a couple of subtle bits which other examples and tutorials get wrong.</p><ol><li>We use <code class="highlighter-rouge">chain</code> to access nested functions within Parenscript objects</li><li>We use <code class="highlighter-rouge">ps-inline</code> to generate JavaScript prefixed with “javascript:”</li></ol><p>Now navigate to <a href="http://localhost:8080/repl">http://localhost:8080/repl</a> and jot something into the text box. When you click the submit button, you’ll contact the server. Once the server’s reply comes back, your window will be alerted with the response.</p><h3 id="wrapping-up">Wrapping up</h3><p>The full source for this can fit comfortably under 50 lines, which is great, considering it’s both the front end and back end logic. However, the state of documentation for these projects, most of which have been stale for a matter of years, is very unfortunate. Even a matter of 50 lines can prove to be several hours of pain.</p><p>Of course, this isn’t quite a REPL yet, but all of the necessary glue work between the client and server is entirely done. Now it’s just a matter of cleaning up the UI and implementing the backend logic.</p><p>The full echo client/server source is shown below, as well as some references I used while piecing this together.</p><h3 id="full-source">Full source</h3><div class="language-cl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">ql:quickload</span> <span class="o">'</span><span class="p">(</span><span class="ss">:hunchentoot</span> <span class="ss">:cl-who</span> <span class="ss">:parenscript</span> <span class="ss">:smackjack</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:jank-repl</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span> <span class="ss">:hunchentoot</span> <span class="ss">:cl-who</span> <span class="ss">:parenscript</span> <span class="ss">:smackjack</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:jank-repl</span><span class="p">)</span>

<span class="c1">; Allow cl-who and parenscript to work together</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*js-string-delimiter*</span> <span class="sc">#\"</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*ajax-processor*</span>
  <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">'ajax-processor</span> <span class="ss">:server-uri</span> <span class="s">"/repl-api"</span><span class="p">))</span>

<span class="p">(</span><span class="nv">defun-ajax</span> <span class="nv">echo</span> <span class="p">(</span><span class="nv">data</span><span class="p">)</span> <span class="p">(</span><span class="vg">*ajax-processor*</span> <span class="ss">:callback-data</span> <span class="ss">:response-text</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">'string</span> <span class="s">"echo: "</span> <span class="nv">data</span><span class="p">))</span>

<span class="p">(</span><span class="nv">define-easy-handler</span> <span class="p">(</span><span class="nv">repl</span> <span class="ss">:uri</span> <span class="s">"/repl"</span><span class="p">)</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">with-html-output-to-string</span> <span class="p">(</span><span class="nv">s</span><span class="p">)</span>
    <span class="p">(</span><span class="ss">:html</span>
      <span class="p">(</span><span class="ss">:head</span>
        <span class="p">(</span><span class="ss">:title</span> <span class="s">"Jank REPL"</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">str</span> <span class="p">(</span><span class="nv">generate-prologue</span> <span class="vg">*ajax-processor*</span><span class="p">))</span>
        <span class="p">(</span><span class="ss">:script</span> <span class="ss">:type</span> <span class="s">"text/javascript"</span>
          <span class="p">(</span><span class="nv">str</span>
            <span class="p">(</span><span class="nv">ps</span>
              <span class="p">(</span><span class="nb">defun</span> <span class="nv">callback</span> <span class="p">(</span><span class="nv">response</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">alert</span> <span class="nv">response</span><span class="p">))</span>
              <span class="p">(</span><span class="nb">defun</span> <span class="nv">on-click</span> <span class="p">()</span>
                <span class="p">(</span><span class="nv">chain</span> <span class="nv">smackjack</span> <span class="p">(</span><span class="nv">echo</span> <span class="p">(</span><span class="nv">chain</span> <span class="nv">document</span>
                                              <span class="p">(</span><span class="nv">get-element-by-id</span> <span class="s">"data"</span><span class="p">)</span>
                                              <span class="nv">value</span><span class="p">)</span>
                                       <span class="nv">callback</span><span class="p">)))))))</span>
      <span class="p">(</span><span class="ss">:body</span>
        <span class="p">(</span><span class="ss">:p</span>
          <span class="p">(</span><span class="ss">:input</span> <span class="ss">:id</span> <span class="s">"data"</span> <span class="ss">:type</span> <span class="s">"text"</span><span class="p">))</span>
        <span class="p">(</span><span class="ss">:p</span>
          <span class="p">(</span><span class="ss">:button</span> <span class="ss">:type</span> <span class="s">"button"</span>
                   <span class="ss">:onclick</span> <span class="p">(</span><span class="nv">ps-inline</span> <span class="p">(</span><span class="nv">on-click</span><span class="p">))</span>
                   <span class="s">"Submit!"</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*server*</span>
  <span class="p">(</span><span class="nv">start</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">'easy-acceptor</span> <span class="ss">:address</span> <span class="s">"localhost"</span> <span class="ss">:port</span> <span class="mi">8080</span><span class="p">)))</span>

<span class="p">(</span><span class="k">setq</span> <span class="vg">*dispatch-table*</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">'dispatch-easy-handlers</span>
                             <span class="p">(</span><span class="nv">create-ajax-dispatcher</span> <span class="vg">*ajax-processor*</span><span class="p">)))</span>
</code></pre></div></div><h3 id="references">References</h3><p>Note that <em>many</em> of these are out of date. Compare the usages you find with what’s shown above to have a higher chance of bringing in working code.</p><ul><li><a href="https://common-lisp.net/project/parenscript/tutorial.html">Official Parenscript tutorial</a></li><li><a href="http://vitovan.com/lispweb3.html">Other Parenscript tutorial</a></li><li><a href="http://www.cliki.net/ParenscriptTipsAndTricks">Parenscript tips</a></li><li><a href="https://github.com/aarvid/SmackJack/blob/master/demo/demo.lisp">SmackJack Demo</a></li></ul></section><hr/><div><div class="border-bottom"><h1 class="panel-subhead">Related posts</h1><ul class="related-list"><li><h2 class="related-post-title"> <a href="/2018/04/11/system76-firmware/">Removing IME: Upgrading System76 firmware on Arch</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/11/30/noscript/">A guide to using NoScript 10.x</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/10/31/clojure-keywords/">The five common forms of Clojure keywords</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/09/30/clojurescript-promesa/">Async/await in ClojureScript with Promesa</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li></ul></div></div></div></div></div> <footer> </footer></body></html>