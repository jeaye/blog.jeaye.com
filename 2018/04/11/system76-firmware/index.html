<!DOCTYPE html><html><head><meta charset="utf-8"/><link rel="icon" type="image/png" href="https://blog.jeaye.com//assets/favicon-c551898801df70b89095c40cbb11f01ff876ecf59bfa153122137abe9459c576.png"><title>Removing IME: Upgrading System76 firmware on Arch</title><meta name="author" content="jeaye"/><meta name="keywords" content="jeaye,jesse,wilkerson,c++,modern,engineering,manager,software,functional,clojure,programming,system76, firmware, ime, arch"/><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="I'm a leader, a problem solver, and a hacker with a passion for privacy and security."><style>.icon{background-image:url("/assets/sprite-sheet-f829f47fe9f6353c7c632fee71002c94a29b8341725e19843f2c1b263869e4f2.png") !important}</style><style rel="stylesheet" type="text/css" integrity="sha256-FAEL2/AHw4sy6PSxUkN0Zt4TaPhbApIPciXM8UG6d7c=" crossorigin="anonymous">*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}body{display:flex;flex-flow:column nowrap;margin:0;font-family:sans-serif}a{text-decoration:none}.theme-old a{color:#3d92c9}.theme-red a{color:#c93d7a}.theme-teal a{color:#c2363c}.theme-green a{color:#3dc945}.theme-penny a{color:#ec331a}a:hover,a:focus{text-decoration:underline}.theme-old .gentle-body-color{color:#222}.theme-red .gentle-body-color{color:#222}.theme-teal .gentle-body-color{color:#222}.theme-green .gentle-body-color{color:#222}.theme-penny .gentle-body-color{color:#222}.header{display:flex;flex-flow:column wrap;align-items:center;margin:0;padding:2em 40px 2em 40px;text-align:center}.theme-old .header{background:#3d4f5d;color:#999}.theme-red .header{background:#5d3d4a;color:#999}.theme-teal .header{background:#3d5d5d;color:#999}.theme-green .header{background:#3d5d40;color:#999}.theme-penny .header{background:#812d39;color:#999}.header-inner{display:flex;flex-flow:row wrap}.header-description{flex:2;text-align:left;max-width:700px}.header-icon{display:flex;flex:1;justify-content:flex-end}.header-title,.header-short-pitch{margin:0}.header-short-pitch{font-weight:300}.theme-old .header-short-pitch{color:#b0cadb}.theme-red .header-short-pitch{color:#dbb0c3}.theme-teal .header-short-pitch{color:#b0dbd9}.theme-green .header-short-pitch{color:#b0dbb3}.theme-penny .header-short-pitch{color:#ffbbcb}.header-name{font-size:2.5em}.theme-old .header-name{color:#222}.theme-red .header-name{color:#222}.theme-teal .header-name{color:#222}.theme-green .header-name{color:#222}.theme-penny .header-name{color:#222}.nav{display:flex;flex-flow:row wrap;gap:0.5em;padding-top:0.5em}.nav-item{display:flex;flex:1;white-space:nowrap}.nav-item a{background:transparent;margin-top:1em;padding:6px 14px;letter-spacing:0.05em;font-size:85%}.theme-old .nav-item a{color:#fff;border:2px solid #b0cadb}.theme-red .nav-item a{color:#fff;border:2px solid #dbb0c3}.theme-teal .nav-item a{color:#fff;border:2px solid #b0dbd9}.theme-green .nav-item a{color:#fff;border:2px solid #b0dbb3}.theme-penny .nav-item a{color:#fff;border:2px solid #ffbbcb}.nav-item a:hover,.nav-item a:focus{text-decoration:none}.theme-old .nav-item a:hover,.theme-old .nav-item a:focus{border:2px solid #3d92c9}.theme-red .nav-item a:hover,.theme-red .nav-item a:focus{border:2px solid #c93d7a}.theme-teal .nav-item a:hover,.theme-teal .nav-item a:focus{border:2px solid #3dc9c3}.theme-green .nav-item a:hover,.theme-green .nav-item a:focus{border:2px solid #3dc945}.theme-penny .nav-item a:hover,.theme-penny .nav-item a:focus{border:2px solid #ff1345}.theme-old .special-nav-item a{border:2px solid #c2a086}.theme-red .special-nav-item a{border:2px solid #86c2aa}.theme-teal .special-nav-item a{border:2px solid #c28686}.theme-green .special-nav-item a{border:2px solid #c286bc}.theme-penny .special-nav-item a{border:2px solid #87e200}.theme-old .special-nav-item a:hover,.theme-old .special-nav-item a:focus{border:2px solid #c26d36}.theme-red .special-nav-item a:hover,.theme-red .special-nav-item a:focus{border:2px solid #36c285}.theme-teal .special-nav-item a:hover,.theme-teal .special-nav-item a:focus{border:2px solid #c2363c}.theme-green .special-nav-item a:hover,.theme-green .special-nav-item a:focus{border:2px solid #c236ba}.theme-penny .special-nav-item a:hover,.theme-penny .special-nav-item a:focus{border:2px solid #78af26}.panel-h-box{display:flex;flex:1;flex-flow:row wrap;gap:10em;justify-content:center;margin:0 3em 0 3em}.panel-v-box{display:flex;flex-flow:column wrap}.panel-gap{min-width:10em}.panel-subhead{text-transform:uppercase;padding:0;font-size:80%;font-weight:500;letter-spacing:0.1em}.theme-old .panel-subhead{color:#999}.theme-red .panel-subhead{color:#999}.theme-teal .panel-subhead{color:#999}.theme-green .panel-subhead{color:#999}.theme-penny .panel-subhead{color:#999}.main-panel,.toolbox-panel,.pgp-panel,.what-i-do-panel,.main-blog-panel{margin-top:2em}.main-panel{display:flex;flex:2;max-width:1280px;min-width:400px}.toolbox-panel{display:flex;flex:1;flex-flow:column nowrap;max-width:450px;min-width:200px}.what-i-do-panel{display:flex;flex:2;flex-flow:column nowrap;min-width:400px;max-width:900px}.what-i-do-h-box{display:flex;flex-flow:row nowrap;gap:4em;margin-top:1em}.what-i-do-thing{flex:1}.what-i-do-thing-title{font-size:1.0em;line-height:0.5em}.what-i-do-title{font-size:1.0em;line-height:0.5em;text-transform:uppercase;margin-bottom:2em}.theme-old .what-i-do-title{color:#443843}.theme-red .what-i-do-title{color:#443843}.theme-teal .what-i-do-title{color:#443843}.theme-green .what-i-do-title{color:#443843}.theme-penny .what-i-do-title{color:#443843}.what-i-do-big{font-size:2.5em;line-height:1em;font-weight:bold}.theme-old .what-i-do-big{color:#222}.theme-red .what-i-do-big{color:#222}.theme-teal .what-i-do-big{color:#222}.theme-green .what-i-do-big{color:#222}.theme-penny .what-i-do-big{color:#222}.job-title{font-size:2em;margin-bottom:0.2em}.theme-old .job-title{color:#222}.theme-red .job-title{color:#222}.theme-teal .job-title{color:#222}.theme-green .job-title{color:#222}.theme-penny .job-title{color:#222}.job-at{font-size:80%;font-weight:500}.theme-old .job-at{color:#999}.theme-red .job-at{color:#999}.theme-teal .job-at{color:#999}.theme-green .job-at{color:#999}.theme-penny .job-at{color:#999}.job-company{font-size:90%}.theme-old .job-company{color:#3d92c9}.theme-red .job-company{color:#c93d7a}.theme-teal .job-company{color:#c2363c}.theme-green .job-company{color:#3dc945}.theme-penny .job-company{color:#ec331a}.posts{display:flex;justify-content:center;flex-flow:column nowrap;max-width:1280px}.post{padding-bottom:2em}.post-header{display:flex;justify-content:space-between;align-items:center}.post-title{font-size:2em;margin-bottom:0.2em}.theme-old .post-title{color:#222}.theme-red .post-title{color:#222}.theme-teal .post-title{color:#222}.theme-green .post-title{color:#222}.theme-penny .post-title{color:#222}.theme-old .post-title a{color:#222;text-decoration-color:#222}.theme-red .post-title a{color:#222;text-decoration-color:#222}.theme-teal .post-title a{color:#222;text-decoration-color:#222}.theme-green .post-title a{color:#222;text-decoration-color:#222}.theme-penny .post-title a{color:#222;text-decoration-color:#222}.post-description{font-family:Georgia, "Cambria", serif;line-height:1.8em}.theme-old .post-description{color:#222}.theme-red .post-description{color:#222}.theme-teal .post-description{color:#222}.theme-green .post-description{color:#222}.theme-penny .post-description{color:#222}.post-meta{font-size:90%;margin:0}.theme-old .post-meta{color:#222}.theme-red .post-meta{color:#222}.theme-teal .post-meta{color:#222}.theme-green .post-meta{color:#222}.theme-penny .post-meta{color:#222}.post-date{text-align:right;white-space:nowrap}.theme-old .post-date{color:#222}.theme-red .post-date{color:#222}.theme-teal .post-date{color:#222}.theme-green .post-date{color:#222}.theme-penny .post-date{color:#222}.post-updated-date{font-size:90%;font-style:italic}.theme-old .post-updated-date{color:#5aba59}.theme-red .post-updated-date{color:#5aba59}.theme-teal .post-updated-date{color:#5aba59}.theme-green .post-updated-date{color:#5aba59}.theme-penny .post-updated-date{color:#5aba59}.post-category{margin:0 0.1em;padding:0.3em 1em;font-size:80%}.theme-old .post-category{color:#fff;background:#999}.theme-red .post-category{color:#fff;background:#999}.theme-teal .post-category{color:#fff;background:#999}.theme-green .post-category{color:#fff;background:#999}.theme-penny .post-category{color:#fff;background:#999}.theme-old .post-category-review{background:#61b360}.theme-red .post-category-review{background:#61b360}.theme-teal .post-category-review{background:#61b360}.theme-green .post-category-review{background:#61b360}.theme-penny .post-category-review{background:#61b360}.theme-old .post-category-privacy,.theme-old .post-category-security{background:#4d85d1}.theme-red .post-category-privacy,.theme-red .post-category-security{background:#4d85d1}.theme-teal .post-category-privacy,.theme-teal .post-category-security{background:#4d85d1}.theme-green .post-category-privacy,.theme-green .post-category-security{background:#4d85d1}.theme-penny .post-category-privacy,.theme-penny .post-category-security{background:#4d85d1}.theme-old .post-category-rant{background:#8156a7}.theme-red .post-category-rant{background:#8156a7}.theme-teal .post-category-rant{background:#8156a7}.theme-green .post-category-rant{background:#8156a7}.theme-penny .post-category-rant{background:#8156a7}.theme-old .post-category-tutorial{background:#bd4f64}.theme-red .post-category-tutorial{background:#bd4f64}.theme-teal .post-category-tutorial{background:#bd4f64}.theme-green .post-category-tutorial{background:#bd4f64}.theme-penny .post-category-tutorial{background:#bd4f64}.theme-old .post h1,.theme-old h2,.theme-old h3,.theme-old h4{color:#222}.theme-red .post h1,.theme-red h2,.theme-red h3,.theme-red h4{color:#222}.theme-teal .post h1,.theme-teal h2,.theme-teal h3,.theme-teal h4{color:#222}.theme-green .post h1,.theme-green h2,.theme-green h3,.theme-green h4{color:#222}.theme-penny .post h1,.theme-penny h2,.theme-penny h3,.theme-penny h4{color:#222}.post p,.post ol,.post ul{font-family:Georgia, "Cambria", serif}.theme-old .post p,.theme-old .post ol,.theme-old .post ul{color:#222}.theme-red .post p,.theme-red .post ol,.theme-red .post ul{color:#222}.theme-teal .post p,.theme-teal .post ol,.theme-teal .post ul{color:#222}.theme-green .post p,.theme-green .post ol,.theme-green .post ul{color:#222}.theme-penny .post p,.theme-penny .post ol,.theme-penny .post ul{color:#222}.post p a{font-weight:600}.skills{margin:0;padding:0 3em 0 0}.skill{display:flex;gap:1em;padding:1em 0;border-bottom:1px solid #ccc}.skill:last-child{border:none !important}.skill-name{font-size:0.8em;font-weight:bold;align-self:center}.theme-old .skill-name{color:#222}.theme-red .skill-name{color:#222}.theme-teal .skill-name{color:#222}.theme-green .skill-name{color:#222}.theme-penny .skill-name{color:#222}.main-blog-panel{display:flex;justify-content:center;margin-left:10em;margin-right:10em}.blog-header{display:flex;flex-flow:row nowrap;justify-content:space-between}.border-bottom{border-bottom:1px solid #eee}.related-list{list-style-type:none}.related-list li{padding-bottom:0.5em;border-bottom:1px solid #ccc}.related-list li:last-child{border:none}.related-post-title{font-size:1em;margin-bottom:0.2em}.theme-old .related-post-title{color:#222}.theme-red .related-post-title{color:#222}.theme-teal .related-post-title{color:#222}.theme-green .related-post-title{color:#222}.theme-penny .related-post-title{color:#222}.theme-old .related-post-title a{color:#222;text-decoration-color:#222}.theme-red .related-post-title a{color:#222;text-decoration-color:#222}.theme-teal .related-post-title a{color:#222;text-decoration-color:#222}.theme-green .related-post-title a{color:#222;text-decoration-color:#222}.theme-penny .related-post-title a{color:#222;text-decoration-color:#222}figure{text-align:center;margin:0 auto}figure img{border:1px solid rgba(50,50,50,0.5);border-radius:2px;padding:5px;background:#fff}.figure-2-3{width:66%}figcaption{padding:1em 1em 2em 1em;word-wrap:normal;text-align:center;display:inline-block !important;width:66%}code{overflow:auto}.icon-feed{background-position:0px 0px;width:24px;height:30px}.icon-j{background-position:-24px 0px;width:158px;height:155px}code:not([id='typeans']){padding-left:5px;padding-right:5px;border:1px solid;border-color:lightgrey;border-radius:5px}pre code{padding:5px}.highlight .lineno{color:#ccc;display:inline-block;padding:0 5px;border-right:1px solid #ccc}.highlight pre code{display:block;white-space:pre-wrap;overflow-x:auto;word-wrap:normal}.highlight .hll{background-color:#49483e}.highlight{background:#272822;color:#f8f8f2;border-radius:5px}.highlight .c{color:#75715e}.highlight .err{color:#960050;background-color:#1e0010}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .ch{color:#75715e}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .cpf{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .gd{color:#f92672}.highlight .ge{font-style:italic}.highlight .gi{color:#a6e22e}.highlight .gs{font-weight:bold}.highlight .gu{color:#75715e}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mb{color:#ae81ff}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sa{color:#e6db74}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .dl{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .fm{color:#a6e22e}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .vm{color:#f8f8f2}.highlight .il{color:#ae81ff}
</style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="/feed.xml"/></head><body class="theme-penny"><div class="header"><div class="header-inner"><div class="header-description"><h1 class="header-title">My name is <span class="header-name">Jeaye</span></h1><h2 class="header-short-pitch">I'm a leader, a problem solver, and a hacker with a passion for privacy and security.</h2></div><div class="header-icon"><div class="icon icon-j"></div></div></div><nav class="nav"><div class="nav-item"> <a href="https://jeaye.com/">About</a></div><div class="nav-item"> <a href="https://github.com/jeaye">Github</a></div><div class="nav-item"> <a href="/">Blog</a></div><div class="nav-item"> <a href="https://jeaye.com/contact">Contact</a></div><div class="nav-item special-nav-item"> <a href="https://jeaye.com/contact">Hire Me!</a></div> </nav></div><div class="main-blog-panel"><div class="posts"> <section class="post"> <header class="post-header"><h2 class="post-title"> <a href="/2018/04/11/system76-firmware/" title="/2018/04/11/system76-firmware/"> Removing IME: Upgrading System76 firmware on Arch </a></h2><div class="post-date"> April 11, 2018</div> </header><p>In the wake of the <a href="https://en.wikipedia.org/wiki/Intel_Management_Engine">Intel Management Engine</a> security revelations, <a href="https://system76.com/">System76</a> developed a firmware upgrade for all of its machines and released an <a href="http://blog.system76.com/post/168050597573/system76-me-firmware-updates-plan">update plan</a> in November 2017. In February 2018, owners of the <a href="https://system76.com/laptops/oryx">Oryx Pro</a> were informed that the firmware update was available through System76’s open source <a href="https://github.com/system76/firmware-update">firmware updater</a>. For anyone not on System76’s <a href="https://system76.com/pop">Pop!_OS</a> or similar Debian-based distros, this firmware updater probably <em>didn’t do anything</em>. After waiting patiently for a couple of months for more updates and not seeing any fixes, I dug into how I could get things going. Herein lies the easiest way I found.</p><h3 id="before-proceeding">Before proceeding</h3><p>To start with, try the firmware update normally, as recommended by the <a href="http://support.system76.com/articles/laptop-firmware/">System76 docs</a>. The approach I took is pretty hacky, but it was the only thing which worked for my setup. Ideally, you can take a more trodden route.</p><h3 id="silent-errors-when-running">Silent errors when running</h3><p>The <a href="https://aur.archlinux.org/packages/system76-driver/">system76-driver AUR package</a> provides a systemd service which just runs the <code class="highlighter-rouge">system76-firmware</code> command to check for firmware updates. In my case, when I ran it, I saw something like the following:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ system76-firmware
2018-04-08 10:48:51,895  INFO  Verified manifest signature...
2018-04-08 10:48:51,895  INFO  Fetching f7cd3816401c6ab1cd2f0a83285a56ee432a9736b707870fb7aeb34c2750bcefc2adcf0f83952696eb688b9768e93f68 with cache /var/cache/system76-firmware
2018-04-08 10:48:51,897  INFO  Fetching e4206477b3f5bad09d54363a78ae79e2916127399e9725c3b9d77bf229c25c293111926d841c1c05b186a96c0963f6ff with cache /var/cache/system76-firmware
2018-04-08 10:48:51,933  INFO  Fetching ec0b0b475412acde6b2b9a05647a64f48beaa5baea298e8801ce1a34bbddcdada5fc2d8025b2e6f07d9802c384a01e7c with cache /var/cache/system76-firmware
2018-04-08 10:48:52,262  INFO  Verified manifest signature...
2018-04-08 10:48:52,263  INFO  Fetching f7cd3816401c6ab1cd2f0a83285a56ee432a9736b707870fb7aeb34c2750bcefc2adcf0f83952696eb688b9768e93f68 with cache /var/cache/system76-firmware
2018-04-08 10:48:52,265  INFO  Fetching e4206477b3f5bad09d54363a78ae79e2916127399e9725c3b9d77bf229c25c293111926d841c1c05b186a96c0963f6ff with cache /var/cache/system76-firmware
2018-04-08 10:48:52,299  INFO  Fetching ec0b0b475412acde6b2b9a05647a64f48beaa5baea298e8801ce1a34bbddcdada5fc2d8025b2e6f07d9802c384a01e7c with cache /var/cache/system76-firmware
$ echo $?
0
</code></pre></div></div><p>No errors, no warnings, a clean exit code, but it didn’t update my firmware or give me any insight into how or when that was going to happen. This is how things were since the <code class="highlighter-rouge">system76-firmware</code> command was added to the AUR package.</p><h3 id="issues-with-the-display">Issues with the display</h3><p>When deciding to dig into what was going on, the first thing I did was step through the program with <a href="https://docs.python.org/2/library/pdb.html">pdb</a>. From there, it became clear that <code class="highlighter-rouge">system76-firmware</code> is trying to show a modal, but can’t find the display name, so it <a href="https://github.com/pop-os/system76-driver/blob/master_artful/system76driver/firmware.py#L467">exits silently</a>. It’s reading the display name from <code class="highlighter-rouge">who</code>, which is odd, since I’d think it’d just check <code class="highlighter-rouge">DISPLAY</code>, so I edited the source to just return <code class="highlighter-rouge">":0"</code>, which is the value of <code class="highlighter-rouge">echo $DISPLAY</code> in my X session. This could be because I’m running <a href="https://i3wm.org/">i3-wm</a> and not GNOME or KDE, but it’s an assumption made on System76’s part either way.</p><p>For the file: <code class="highlighter-rouge">/usr/lib/python3.6/site-packages/system76driver/firmware.py</code></p><div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff --git a/firmware.py b/firmware.py
index 95bafe1..90c60f9 100644
</span><span class="gd">--- a/firmware.py
</span><span class="gi">+++ b/firmware.py
</span><span class="gu">@@ -444,6 +444,7 @@ def get_user_session():
</span>                     "who | awk -v vt=tty$(fgconsole) '$0 ~ vt {print $5}'",
                     shell=True
                 ).decode('utf-8').rstrip('\n').lstrip('(').rstrip(')')
<span class="gi">+    display_name = ":0" # XXX: Hack
</span>
     user_pid = subprocess.check_output(
                     "who -u | awk -v vt=tty$(fgconsole) '$0 ~ vt {print $6}'",
</code></pre></div></div><h3 id="issues-with-efibootmgr">Issues with efibootmgr</h3><p>After that one line fix, running <code class="highlighter-rouge">system76-firmware</code> resulted in a modal! I could choose to close the modal or click a button to install the firmware. After trying to install, another modal shows up with the procedure instructions, as they’re also shown on the <a href="http://support.system76.com/articles/laptop-firmware/">System76 support page</a>, and a button to restart into the firmware updater. Restart!</p><p>…</p><p>Back into GRUB, then into Arch, with no firmware updates. Damn. So I dug more into the source for, hopefully, another one liner. There’s a bash script, as part of the Python source, called <a href="https://github.com/pop-os/system76-driver/blob/master_artful/system76driver/firmware.py#L206">FIRMWARE_SET_NEXT_BOOT</a>. It looks like this:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">EFIDEV</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>findmnt <span class="nt">-n</span> /boot/efi <span class="nt">-o</span> SOURCE<span class="k">)</span><span class="s2">"</span>
<span class="nv">EFINAME</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="k">${</span><span class="nv">EFIDEV</span><span class="k">}</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
<span class="nv">EFISYS</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="s2">"/sys/class/block/</span><span class="k">${</span><span class="nv">EFINAME</span><span class="k">}</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
<span class="nv">EFIPART</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">cat</span> <span class="s2">"</span><span class="k">${</span><span class="nv">EFISYS</span><span class="k">}</span><span class="s2">/partition"</span><span class="k">)</span><span class="s2">"</span>
<span class="nv">DISKSYS</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="k">${</span><span class="nv">EFISYS</span><span class="k">}</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
<span class="nv">DISKNAME</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DISKSYS</span><span class="k">}</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
<span class="nv">DISKDEV</span><span class="o">=</span><span class="s2">"/dev/</span><span class="k">${</span><span class="nv">DISKNAME</span><span class="k">}</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\e</span><span class="s2">[1mCreating Boot1776 on "</span><span class="k">${</span><span class="nv">DISKDEV</span><span class="k">}</span><span class="s2">" "</span><span class="k">${</span><span class="nv">EFIPART</span><span class="k">}</span><span class="s2">" </span><span class="se">\e</span><span class="s2">[0m"</span> <span class="o">&gt;</span>&amp;2
efibootmgr <span class="nt">-B</span> <span class="nt">-b</span> 1776 <span class="o">||</span> <span class="nb">true
</span>efibootmgr <span class="nt">-C</span> <span class="nt">-b</span> 1776 <span class="nt">-d</span> <span class="s2">"</span><span class="k">${</span><span class="nv">DISKDEV</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-p</span> <span class="s2">"</span><span class="k">${</span><span class="nv">EFIPART</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-l</span> <span class="s1">'\system76-firmware-update\boot.efi'</span> <span class="nt">-L</span> <span class="s2">"system76-firmware-update"</span>

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\e</span><span class="s2">[1mSetting BootNext to 1776</span><span class="se">\e</span><span class="s2">[0m"</span> <span class="o">&gt;</span>&amp;2
efibootmgr <span class="nt">-n</span> 1776

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\e</span><span class="s2">[1mInstalled system76-firmware-update</span><span class="se">\e</span><span class="s2">[0m"</span> <span class="o">&gt;</span>&amp;2
efibootmgr <span class="nt">-v</span>
</code></pre></div></div><p>This is what’s trying to make the next boot go into the updater’s EFI file instead of the normal boot order. So, already, there are some assumptions made.</p><ol><li>The user is booting with EFI</li><li><code class="highlighter-rouge">/boot/efi</code> is mounted</li><li>Writing the System76 updater EFI to <code class="highlighter-rouge">/boot/efi/system76-firmware-update/</code> is useful</li><li><code class="highlighter-rouge">efibootmgr -C</code> is valid</li><li>Errors don’t matter. They do though, so it should be using <a href="https://vaneyckt.io/posts/safer_bash_scripts_with_set_euxo_pipefail/">safer settings</a>.</li></ol><p>For all but the first of these assumptions, on my Arch setup, System76 is guessing incorrectly. Yes, I’m booting with EFI, but <code class="highlighter-rouge">/boot/efi</code> isn’t always mounted. Furthermore, the <code class="highlighter-rouge">system76-firmware-update</code> directory should be installed into <code class="highlighter-rouge">/boot/efi/EFI</code> if it wants to actually be useful. Finally, according to the <code class="highlighter-rouge">efibootmgr</code> man page, <code class="highlighter-rouge">-c</code> should be used to create boot entries. <code class="highlighter-rouge">-C</code> doesn’t exist. In your <code class="highlighter-rouge">system76-firmware</code> output, you’ll probably see something like this (from <code class="highlighter-rouge">efibootmgr</code>):</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Could not prepare Boot variable: No such file or directory
</code></pre></div></div><p>So, you might try the following, in order to get your restarts to bring you into the updater:</p><ol><li>Patch the <a href="https://github.com/pop-os/system76-driver/blob/master_artful/system76driver/firmware.py#L224">bash script</a> to use <code class="highlighter-rouge">-c</code> instead of <code class="highlighter-rouge">-C</code> with <code class="highlighter-rouge">efibootmgr</code></li><li>Mount <code class="highlighter-rouge">/boot/efi</code> and <em>then</em> run <code class="highlighter-rouge">system76-firmware</code> (then see if it installs properly and try rebooting)</li><li>Move <code class="highlighter-rouge">/boot/efi/system76-firmware-update</code> to <code class="highlighter-rouge">/boot/efi/EFI/system76-firmware-update</code> and then run <code class="highlighter-rouge">system76-firmware</code> again, to see if <code class="highlighter-rouge">efibootmgr -c</code> picks it up and try your restart</li></ol><p>I was able to get <code class="highlighter-rouge">efibootmgr</code> to finally run without error, but a restart still just brought me to GRUB. So, I took a more manual route.</p><h3 id="before-proceeding-get-rescatux">Before proceeding: get Rescatux</h3><p>Very importantly, make sure you have a USB or CD/DVD with a burned image of <a href="https://www.supergrubdisk.org/rescatux/">Rescatux</a>. Rescatux is an amazing 20MB rescue boot image which can boot into most anything. This is not a precaution; if you follow these steps, you <em>will</em> need Rescatux, so burn it now.</p><ol><li>Download it <a href="https://www.supergrubdisk.org/category/download/rescatuxdownloads/rescatux-beta/">here</a></li><li>Burn with <code class="highlighter-rouge">dd</code> or whatever you prefer</li></ol><h3 id="manually-loading-the-updater-efi">Manually loading the updater EFI</h3><p>My idea was simple: just add a GRUB entry for the firmware updater, since I can so reliably make it into GRUB. The catch is that the firmware updater, thinking that it was booted from the temporary boot path made by the bash script discussed above, deletes the EFI boot path which was used to boot. As long as there’s a Rescatux image lying around, though, that’s not a problem.</p><h4 id="add-the-grub-entry">Add the GRUB entry</h4><p>The GRUB entry should look something like this (put it at the bottom of <code class="highlighter-rouge">/etc/grub.d/40_custom</code>):</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>menuentry "System76 Firmware Update" {
        insmod chain
        insmod search_fs_uuid
        search --fs-uuid --no-floppy --set=root TODO-ID
        chainloader /EFI/system76-firmware-update/boot.efi
}
</code></pre></div></div><p>In order for it to work for your machine, you need to do two things.</p><h4 id="find-the-filesystem-uuid">Find the filesystem UUID</h4><p>Run <code class="highlighter-rouge">cfdisk &lt;your disk&gt;</code> and select your EFI partition to see its filesystem id. For example, mine is <code class="highlighter-rouge">129D-B845</code>. Replace <code class="highlighter-rouge">TODO-ID</code> in the above GRUB entry with your id. Here’s what it should look like:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cfdisk /dev/nvme0n1
                                   Disk: /dev/nvme0n1
                 Size: 232.9 GiB, 250059350016 bytes, 488397168 sectors
              Label: gpt, identifier: B7545E19-CF68-4779-BD95-F12C7DC8DDA6

    Device                 Start          End      Sectors      Size Type
&gt;&gt;  /dev/nvme0n1p1          2048      1050623      1048576      512M EFI System
    /dev/nvme0n1p2       1050624    488397134    487346511    232.4G Linux filesystem
 ┌────────────────────────────────────────────────────────────────────────────────────┐
 │  Partition name: primary                                                           │
 │  Partition UUID: 7761E4D0-5726-45BE-9761-25FC114DE691                              │
 │  Partition type: EFI System (C12A7328-F81F-11D2-BA4B-00A0C93EC93B)                 │
 │ Filesystem UUID: 129D-B845                                                         │
 │Filesystem LABEL: EFI                                                               │
 └────────────────────────────────────────────────────────────────────────────────────┘
   [ Delete ]  [ Resize ]  [  Quit  ]  [  Type  ]  [  Help  ]  [  Write ]  [  Dump  ]

</code></pre></div></div><h4 id="move-the-updater-to-the-efi-partition">Move the updater to the EFI partition</h4><p>As mentioned above, <code class="highlighter-rouge">system76-firmware</code> installs the updater to <code class="highlighter-rouge">/boot/efi/system76-firmware-update</code>. If that’s your EFI root, great. Just update the GRUB entry to not use <code class="highlighter-rouge">/EFI/</code>. If your system is like mine, though, you’ll need to move the updater to <code class="highlighter-rouge">/boot/efi/EFI/system76-firmware-update</code>.</p><h4 id="generate-grubs-new-config">Generate GRUB’s new config</h4><p>With the new GRUB entry, the final step to get ready for the reboot is to generate the new GRUB configs.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grub-mkconfig <span class="nt">--output</span> /boot/grub/grub.cfg
</code></pre></div></div><h3 id="time-to-update-the-firmware">Time to update the firmware</h3><p>At this point, a reboot should bring you into GRUB with your new entry. After selecting your new entry, you should see the updater and you can press enter to continue. Remember to have the <a href="http://support.system76.com/articles/laptop-firmware/">System76 docs</a> on hand, so you understand how the update flow should go.</p><p>After a little while, the updater will reboot. Your fans will be on full blast. <strong>At the GRUB menu, choose the updater again.</strong> Once you’re back in the updater, it’ll work for a while more, run some checks, and finally power off. Follow the System76 docs to jump into BIOS, adopt the defaults, and everything else. When you’re ready to get back into GNU/Linux, you’ll find your EFI boot path is gone.</p><h3 id="rescatux">Rescatux</h3><p>Plug in your Rescatux media, reboot your machine, optionally hit F2 to change your boot order, if necessary, to make it into the Rescatux menu. The default option, to find all bootable OSs, will do the trick, so just hit enter and then choose the first Linux boot option to get back into your typical environment.</p><h3 id="reinstall-grub">Reinstall GRUB</h3><p>Since your EFI boot path was wiped by the updater and you probably don’t want to boot via Rescatux forever, once you’re back in a sane GNU/Linux environment, just mount your EFI partition and reinstall GRUB. For me, that process looked like this.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cfdisk /dev/nvme0n1
<span class="nv">$ </span>mount /dev/nvme0n1p1 /boot/efi
<span class="nv">$ </span>grub-install <span class="nt">--target</span><span class="o">=</span>x86_64-efi <span class="nt">--efi-directory</span><span class="o">=</span>/boot/efi <span class="nt">--bootloader-id</span><span class="o">=</span>grub
</code></pre></div></div><p>The Intel Management Engine has now been disabled and its code has been removed. You can try running the firmware updater again, just to be sure that it detects everything is up to date.</p><h3 id="cleanup">Cleanup</h3><p>Finally, feel free to remove <code class="highlighter-rouge">/boot/efi/EFI/system76-firmware-update</code> and <code class="highlighter-rouge">/boot/efi/system76-firmware-update</code>, if they’re still around. You can also remove the GRUB boot entry from <code class="highlighter-rouge">/etc/grub.d/40_custom</code> and re-generate your GRUB config.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grub-mkconfig <span class="nt">--output</span> /boot/grub/grub.cfg
</code></pre></div></div><h3 id="post-update-issues">Post-update issues</h3><p>In <code class="highlighter-rouge">#system76</code> on Freenode, which is barren and likely not worth joining, I’ve seen some questions about people losing some fn key functionality after the update. For me, HDMI didn’t work at all after the update. I unplugged and tested the HDMI cable and monitor on another machine and concluded that the firmware update must’ve borked something. <code class="highlighter-rouge">xrandr</code> didn’t show any connections, but I didn’t look further into it than that, since it was late and I was pleased enough to’ve finished the update.</p><p>In the morning, HDMI worked as expected, without any hiccups. Maybe the machine also just need a good night’s rest.</p></section><hr/><div><div class="border-bottom"><h1 class="panel-subhead">Related posts</h1><ul class="related-list"><li><h2 class="related-post-title"> <a href="/2017/12/16/firefox/">Don't abandon Mozilla Firefox just yet</a> <span class="post-category post-category-privacy">privacy</span> <span class="post-category post-category-security">security</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/11/30/noscript/">A guide to using NoScript 10.x</a> <span class="post-category post-category-privacy">privacy</span> <span class="post-category post-category-security">security</span> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/10/31/clojure-keywords/">The five common forms of Clojure keywords</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li><li><h2 class="related-post-title"> <a href="/2017/09/30/clojurescript-promesa/">Async/await in ClojureScript with Promesa</a> <span class="post-category post-category-tutorial">tutorial</span></h2></li></ul></div></div></div></div></div> <footer> </footer></body></html>