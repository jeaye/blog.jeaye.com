---
title: A RainLoop review and setup guide
tags: [review, email, gpg, security, privacy, rainloop]
---

[RainLoop](TODO) is a web-based
[MUA](https://en.wikipedia.org/wiki/Email_client) similar to [Roundcube](TODO),
[MailPile](TODO), and the like. When looking to setup portable email access for
my wife, who no longer is happy with just Thunderbird, Rainloop seemed like a
reasonable choice. Here are some integration notes, as well as a review and some
ranting, based on my afternoon setting it up.

### Community vs Standard version
The [website for Rainloop](http://www.rainloop.net) is quite minimal, but so is
the setup itself. The [biggest decision](http://www.rainloop.net/purchase/) one
needs to make is whether or not to use the Community
([AGPL](https://en.wikipedia.org/wiki/Affero_General_Public_License)) version or
the Standard
([closed-source](https://en.wikipedia.org/wiki/Proprietary_software)) version.
As of writing, for personal sites, the Community version lacks only one feature:
single-click updating. Instead, the user is directed to install the new version
atop the old one, manually.

#### No single-click updating?
As far as licensing is concerned, that's not a problem at all. The approach
where the core of a product can be open source, while some non-crucial features
cost money, is a pretty reasonable deal. Still, there's no need to use a
closed-source version just to get single-click updating. Manually updating
in-place, however, is error-prone, non-atomic (meaning it's not all or nothing),
imperative, and not the [NixOS](http://nixos.org/) way. We can do better.

### Basic installation
Following the [documentation](http://www.rainloop.net/docs/installation/), basic
installation is a breeze.

**Note:** *The below uses `/var/www/rainloop`, but this could be anywhere on
your machine which is capable of serving data to Apache.*

```bash
$ wget http://www.rainloop.net/repository/webmail/rainloop-community-latest.zip
$ mkdir /var/www/rainloop
$ unzip rainloop-community-latest.zip -d /var/www/rainloop
```

From there, a basic Apache setup can just look in the `rainloop` directory.

```conf
<Directory /var/www/rainloop>
  DirectoryIndex index.php
  Options +Indexes +FollowSymLinks +ExecCGI
  AllowOverride All
  Order deny,allow
  Allow from all
  Require all granted
</Directory>
```

As per the documentation, all configuration, caches, and assorted private data
is included within the top-level `rainloop` directory, but within a `data`
directory. Ideally, no users should be able to access that, so it should be
disabled with Apache.

```conf
<Directory /var/www/rainloop/data>
  Options -Indexes
  Deny from all
</Directory>
```

Aside from setting up [HTTPS](https://letsencrypt.org/), which should be
considered a requirement for any web application, that's it. As per the docs,
manual upgrading involves unzipping the newest release on top of the live
version. As per the intro, we can do better.

### Automatically and atomically updating
The RainLoop devs are kind enough to package a [PGP
signature](https://en.wikipedia.org/wiki/Pretty_Good_Privacy) for each release.
Using a script, it'd be straightforward to match that signature with the one of
our live version. If the two differ, the new one can be downloaded and extracted
in a new directory (not the live one). The new signature should be kept in the
new directory, so the script can know when the next update arrives. Once the new
setup is complete, a symbolic link can be atomically updated to point to the
latest version. Here's how it might look.

The current directory layout, as per the basic installation is similar to this.

```bash
$ tree -L 1 /var/www/rainloop
/var/www/rainloop
├── data
├── index.php
└── rainloop
```

Instead, each version can be dated. RainLoop doesn't have specific version
numbers in its latest downloads, so the date is the next easiest thing to use.
The `latest` link will just point to the latest version around.

```bash
$ tree -L 1 /var/www/rainloop
/var/www/rainloop
├── latest -> /var/www/rainloop/version-2017-04-23.19:09:29
├── version-2017-03-01.13:14:11
│   ├── data
│   ├── index.php
│   ├── rainloop
│   └── rainloop-community-latest.zip.asc
├── version-2017-04-21.13:03:58
│   ├── data
│   ├── index.php
│   ├── rainloop
│   └── rainloop-community-latest.zip.asc
└── version-2017-04-23.19:09:29
    ├── data
    ├── index.php
    ├── rainloop
    └── rainloop-community-latest.zip.asc
```

Since RainLoop isn't very large (about 25MB), it likely doesn't hurt to keep
these versions around. If it does, a simple daily cron can clean up all but the
last N versions. With the theory out of the way, here's a working upgrade script
which follows all of the above ideas.

```bash
#!/usr/bin/env bash

set -eu -o pipefail

# The only thing you'll need to change
local_webmail=/var/www/rainloop # Wherever you're running rainloop

zip_file=rainloop-community-latest.zip
signature_file=$zip_file.asc
remote_webmail=http://www.rainloop.net/repository/webmail
new_zip_signature=$(curl -s "$remote_webmail/$signature_file")
old_zip_signature=$(cat "$local_webmail/latest/$signature_file" || true)

printf "RainLoop: checking for upgrades... "
if [ "$new_zip_signature" != "$old_zip_signature" ];
then
  echo "found"
  echo "RainLoop: upgrading..."
  temp_dir=$(mktemp -d)
  pushd "$temp_dir"
    gpg2 --import <(curl -s "http://www.rainloop.net/repository/RainLoop.asc")

    # Download new version
    wget "$remote_webmail/$zip_file"
    gpg2 --verify <(echo "$new_zip_signature") "$zip_file"

    # Start from the latest, if it's there
    if [ -d "$local_webmail/latest" ];
    then
      rsync -av "$local_webmail/latest/" .
    fi

    unzip -o "$zip_file"
    rm "$zip_file"

    echo "$new_zip_signature" > "$signature_file"
  popd

  new_version=$(date +'version-%Y-%m-%d.%H:%M:%S')
  new_path=$local_webmail/$new_version
  if [ -d "$new_path" ];
  then
    echo "RainLoop: directory already exists: $new_path"
    exit 1
  fi

  # Move the new version into place and atomically link/upgrade
  mv "$temp_dir" "$new_path"
  ln -sfn "$new_path" "$local_webmail/latest"

  echo "Rainloop: upgrade complete"
else
  echo "not found"
fi
```

With that in place, and either running in a cron job or running manually, the
only tweak needed is in the Apache config. Apache should just point at the
`latest` link, so upgrading will never require changing its configs. Since the
upgrade is atomic (all or nothing), Apache won't ever be serving up a
half-upgraded RainLoop. It's either fully on one version, or fully on another.
This is just like NixOS and the way the [Nix](http://nixos.org/nix/) package
manage works.

```conf
# Each directory just has latest at the end now
<Directory /var/www/rainloop/latest>
  DirectoryIndex index.php
  Options +Indexes +FollowSymLinks +ExecCGI
  AllowOverride All
  Order deny,allow
  Allow from all
  Require all granted
</Directory>
<Directory /var/www/rainloop/latest/data>
  Options -Indexes
  Deny from all
</Directory>
```

### UI and functionality
My wife has been pretty pleased with Rainloop, on both desktop and mobile. Some
annoyances have occurred though, most of which are minor.

* On mobile, the back button doesn't behave properly; after selecting an email,
  the back button will not return to the inbox. After hitting it, failing, and
  manually returning to the inbox, the search will have been changed to
  "is:flagged" -- it seems that the back button is trying to do something.

  Unfortunately, it's more buggy than that. After asking her to reproduce it for
  me a second time, she was in her inbox, selected an email, and the back button
  then brought her to the settings menu. For now, she's just not using that
  button.

* There is no autocompletion of names or emails, based on existing emails in
  one's inbox. Instead, it seems that they may need to be added to the contacts
  list. Manually adding each contact is tiresome, tedious work and the
  completion of emails and names in the To, Cc, etc forms should be filled in a
  smart way.

* The refresh icon, in the inbox view is entirely unintuitive; neither of us
  knew what it was supposed to do when we first saw it. It's not a tough thing
  to learn, but that doesn't seem like the place we should be breaking new
  ground.

* While there are default themes, none of them change the color of the message
  body background, which remains a glaring white. Some more complete default
  themes would be appreciated, for those with sensitive eyes.

Review of UI & functionality
  Appreciate the smart multiple identity support
  Themes
    Their presence is appreciated
    No default theme which changes the message body background (always white)
Lack of good gpg
  Developers just closed the ticket with no good reasoning
  JS version has security and portability issues
